<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修jQuery 源码解析(三十) 动画模块 $.animate()详解' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>jQuery 源码解析(三十) 动画模块 $.animate()详解</center></div><div class='banquan'>原文出处:本文由博客园博主大沙漠提供。<br/>
原文连接:https://www.cnblogs.com/greatdesert/p/12120586.html</div><br>
    <p>jQuery的动画模块提供了包括隐藏显示动画、渐显渐隐动画、滑入划出动画，同时还支持构造复杂自定义动画，动画模块用到了之前讲解过的很多其它很多模块，例如队列、事件等等，</p>
<p>$.animate()的用法如下:animate(prop,speed,easing,callback)，参数如下:</p>
<ul>
<li>prop 　　;对象，&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;包含将要动画的样式</li>
<li>speed 　 ;字符串或数字&nbsp;&nbsp; &nbsp;;动画运行持续时间，单位毫秒,可以设置为"slow"、"normal"、"fast"等预定义时间</li>
<li>easing 　;字符串&nbsp;&nbsp; &nbsp;&nbsp; &nbsp; &nbsp;　&nbsp; ;表示所使用的缓动函数</li>
<li>callback&nbsp; ;回调函数&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;当动画完成时被调用</li>
</ul>
<p>还是举个栗子:</p>
<div class="cnblogs_code">
<pre><code><span style="color: #0000ff;">&lt;!</span><span style="color: #ff00ff;">DOCTYPE html</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #0000ff;">&lt;</span><span style="color: #800000;">html </span><span style="color: #ff0000;">lang</span><span style="color: #0000ff;">="en"</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #0000ff;">&lt;</span><span style="color: #800000;">head</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">meta </span><span style="color: #ff0000;">charset</span><span style="color: #0000ff;">="UTF-8"</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">title</span><span style="color: #0000ff;">&gt;</span>Document<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">title</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">script </span><span style="color: #ff0000;">src</span><span style="color: #0000ff;">="http://libs.baidu.com/jquery/1.11.1/jquery.min.js"</span><span style="color: #0000ff;">&gt;&lt;/</span><span style="color: #800000;">script</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">style</span><span style="color: #0000ff;">&gt;</span><span style="background-color: #f5f5f5; color: #800000;">
        div</span><span style="background-color: #f5f5f5; color: #000000;">{</span><span style="background-color: #f5f5f5; color: #ff0000;">width</span><span style="background-color: #f5f5f5; color: #000000;">:</span><span style="background-color: #f5f5f5; color: #0000ff;"> 200px</span><span style="background-color: #f5f5f5; color: #000000;">;</span><span style="background-color: #f5f5f5; color: #ff0000;">height</span><span style="background-color: #f5f5f5; color: #000000;">:</span><span style="background-color: #f5f5f5; color: #0000ff;"> 50px</span><span style="background-color: #f5f5f5; color: #000000;">;</span><span style="background-color: #f5f5f5; color: #ff0000;">background</span><span style="background-color: #f5f5f5; color: #000000;">:</span><span style="background-color: #f5f5f5; color: #0000ff;"> #cfc</span><span style="background-color: #f5f5f5; color: #000000;">;</span><span style="background-color: #f5f5f5; color: #000000;">}</span>
    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">style</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">head</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #0000ff;">&lt;</span><span style="color: #800000;">body</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">button</span><span style="color: #0000ff;">&gt;</span>按钮<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">button</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">div</span><span style="color: #0000ff;">&gt;&lt;/</span><span style="color: #800000;">div</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">script</span><span style="color: #0000ff;">&gt;</span><span style="background-color: #f5f5f5; color: #000000;">
        $(</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">button</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">).click(</span><span style="background-color: #f5f5f5; color: #0000ff;">function</span><span style="background-color: #f5f5f5; color: #000000;">(){
            $(</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">div</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">).animate({width:</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">400px</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">,height:</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">100px</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">,background:</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">#f00</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">},</span><span style="background-color: #f5f5f5; color: #000000;">2000</span><span style="background-color: #f5f5f5; color: #000000;">,</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">linear</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">,</span><span style="background-color: #f5f5f5; color: #0000ff;">function</span><span style="background-color: #f5f5f5; color: #000000;">(){alert(</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">动画完成成功</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">)})
        })
    </span><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">script</span><span style="color: #0000ff;">&gt;</span>    
<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">body</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">html</span><span style="color: #0000ff;">&gt;</span></pre>
</div>
<p>我们定义一个div和一个按钮，再在按钮上绑定一个事件，该事件回调用$.animate()来修改div的样式，动画完成后再执行一个回调函数，效果如下:</p>
<p><img src="./images/jQuery 源码解析(三十) 动画模块 $.animate()详解0.png" alt="" /></p>
<p>挺好用的啊，很方便的，可以用jQuery实现各种动画，尺寸、位置、颜色，还可以配合CSS3的transform属性实现各种酷炫效果。</p>
<p>&nbsp;</p>
<p><strong><span style="font-size: 18pt;">源码分析</span></strong></p>
<hr />
<p>jQuery内在执行$.animate()时会遍历参数1也就是我们要修改的样式，然后分别创建一个对应的$.fx对象，实际上最终的动画是在$.fx这个对象上运行的，另外jQuery内部会维护一个setInterval()，默认会每隔13毫秒执行一次样式的修改，这样看起来就和动画一样了。</p>
<p>直接看代码吧,$.animate()实现如下:</p>
<div class="cnblogs_code">
<pre><code><span style="color: #000000;">jQuery.fn.extend({
    animate: </span><span style="color: #0000ff;">function</span>( prop, speed, easing, callback ) {                <span style="color: #008000;">//</span><span style="color: #008000;">动画入口函数，负责执行单个样式的动画，</span>
        <span style="color: #0000ff;">var</span> optall = jQuery.speed( speed, easing, callback );                <span style="color: #008000;">//</span><span style="color: #008000;">调用$.speed修正运行时间、缓动函数，重写完成回调函数</span>

        <span style="color: #0000ff;">if</span> ( jQuery.isEmptyObject( prop ) ) {                                <span style="color: #008000;">//</span><span style="color: #008000;">如果prop中没有需要执行动画的样式</span>
            <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span>.each( optall.complete, [ <span style="color: #0000ff;">false</span> ] );                        <span style="color: #008000;">//</span><span style="color: #008000;">则立即调用完成回调函数</span>
<span style="color: #000000;">        }

        </span><span style="color: #008000;">//</span><span style="color: #008000;"> Do not change referenced properties as per-property easing will be lost</span>
        prop = jQuery.extend( {}, prop );                                    <span style="color: #008000;">//</span><span style="color: #008000;">复制一份动画样式的集合，以避免改变原始动画样式集合，因为每个动画样式的缓存函数最终会丢失。</span>

        <span style="color: #0000ff;">function</span> doAnimation() {                                            <span style="color: #008000;">//</span><span style="color: #ff0000;">执行动画的函数，后面再讲解，我们先把流程理解了</span>
            <span style="color: #008000;">/*</span><span style="color: #008000;">略</span><span style="color: #008000;">*/</span><span style="color: #000000;">
        }

        </span><span style="color: #0000ff;">return</span> optall.queue === <span style="color: #0000ff;">false</span> ?                                        <span style="color: #008000;">//</span><span style="color: #008000;">queue表示是否将当前动画放入队列</span>
            <span style="color: #0000ff;">this</span>.each( doAnimation ) :                                             <span style="color: #008000;">//</span><span style="color: #008000;">如果optall.queue为false,则调用.each()方法在每个匹配元素上执行动画函数doAnimation();</span>
            <span style="color: #0000ff;">this</span>.queue( optall.queue, doAnimation );                             <span style="color: #008000;">//</span><span style="color: #008000;">否则调用方法.queue()将动画函数doAnimation()插入选项queue指定的队列中。</span>
<span style="color: #000000;">    },
})</span></pre>
</div>
<p>$.queue之前已经讲过了，可以看这个连接<a href="https://www.cnblogs.com/greatdesert/p/11670591.html" target="_blank">https://www.cnblogs.com/greatdesert/p/11670591.html</a>,由于插入的是默认动画，因此插入到队列后就会自动执行的。</p>
<p>$.speed()是用于负责修正运行时间、缓动函数，重写完成回调函数的，如下:</p>
<div class="cnblogs_code">
<pre><code><span style="color: #000000;">jQuery.extend({
    speed: </span><span style="color: #0000ff;">function</span>( speed, easing, fn ) {         <span style="color: #008000;">//</span><span style="color: #008000;">负责修正运行时间、缓动函数，重写完成回调函数。//speed:表示动画持续时间、easing是所使用的缓动函数、fn是动画完成时被调用的函数。</span>
        <span style="color: #0000ff;">var</span> opt = speed &amp;&amp; <span style="color: #0000ff;">typeof</span> speed === "object" ? jQuery.extend( {}, speed ) : {     <span style="color: #008000;">//</span><span style="color: #008000;">如果speed是对象，即$.fn.animate()只传入了两个参数的格式，则将该对象赋值给opt对象。</span>
            complete: fn || !fn &amp;&amp; easing ||                                                     <span style="color: #008000;">//</span><span style="color: #008000;">依次尝试把最后一个参数作为完成回调函数保存到complete中</span>
                jQuery.isFunction( speed ) &amp;&amp;<span style="color: #000000;"> speed,
            duration: speed,                                                                     </span><span style="color: #008000;">//</span><span style="color: #008000;">动画持续时间</span>
            easing: fn &amp;&amp; easing || easing &amp;&amp; !jQuery.isFunction( easing ) &amp;&amp; easing             <span style="color: #008000;">//</span><span style="color: #008000;">如果参数3非空，则设置easing为参数2  </span>
<span style="color: #000000;">        };

        opt.duration </span>= jQuery.fx.off ? 0 : <span style="color: #0000ff;">typeof</span> opt.duration === "number" ? opt.duration :     <span style="color: #008000;">//</span><span style="color: #008000;">修正duration选项</span>
            opt.duration <span style="color: #0000ff;">in</span> jQuery.fx.speeds ?<span style="color: #000000;"> jQuery.fx.speeds[ opt.duration ] : jQuery.fx.speeds._default;

        </span><span style="color: #008000;">//</span><span style="color: #008000;"> normalize opt.queue - true/undefined/null -&gt; "fx"</span>
        <span style="color: #0000ff;">if</span> ( opt.queue == <span style="color: #0000ff;">null</span> || opt.queue === <span style="color: #0000ff;">true</span><span style="color: #000000;"> ) {
            opt.queue </span>= "fx"<span style="color: #000000;">;
        }

        </span><span style="color: #008000;">//</span><span style="color: #008000;"> Queueing </span>
        opt.old = opt.complete;                                                                 <span style="color: #008000;">//</span><span style="color: #008000;">备份完成回调函数complete到old属性中</span>
<span style="color: #000000;">
        opt.complete </span>= <span style="color: #0000ff;">function</span>( noUnmark ) {                                                     <span style="color: #008000;">//</span><span style="color: #008000;">重写complete函数，当前动画完成时，自动取出下一个动画函数。</span>
            <span style="color: #0000ff;">if</span><span style="color: #000000;"> ( jQuery.isFunction( opt.old ) ) {
                opt.old.call( </span><span style="color: #0000ff;">this</span><span style="color: #000000;"> );
            }

            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> ( opt.queue ) {
                jQuery.dequeue( </span><span style="color: #0000ff;">this</span><span style="color: #000000;">, opt.queue );
            } </span><span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> ( noUnmark !== <span style="color: #0000ff;">false</span><span style="color: #000000;"> ) {
                jQuery._unmark( </span><span style="color: #0000ff;">this</span><span style="color: #000000;"> );
            }
        };

        </span><span style="color: #0000ff;">return</span> opt;                                                                             <span style="color: #008000;">//</span><span style="color: #008000;">最后返回opt</span>
<span style="color: #000000;">    },
})</span></pre>
</div>
<p>$.animate函数非常灵活，可以有如下形式:</p>
<ul>
<li>animate(prop,speed,easing,callback)&nbsp;&nbsp;&nbsp;</li>
<li>animate(prop,easing,callback)&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;</li>
<li>animate(prop,speed,callback)&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;</li>
<li>animate(prop,callback)&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;</li>
<li>animate(prop,obj)&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;</li>
</ul>
<p>&nbsp;这就是$.speed函数的功劳了。</p>
<p>回到$.animate函数内，当将doAnimation插入到队列后，由于是默认队列就会自动执行该函数，doAnimation实现如下:</p>
<div class="cnblogs_code">
<pre><code><span style="color: #0000ff;">function</span> doAnimation() {                    <span style="color: #008000;">//</span><span style="color: #008000;">负责遍历动画样式集合，先修正、解析、备份样式名，然后为每个样式调用构造函数jQuery.fx()构造动画</span>
    <span style="color: #008000;">//</span><span style="color: #008000;"> XXX 'this' does not always have a nodeName when running the</span>
    <span style="color: #008000;">//</span><span style="color: #008000;"> test suite</span>

    <span style="color: #0000ff;">if</span> ( optall.queue === <span style="color: #0000ff;">false</span> ) {                <span style="color: #008000;">//</span><span style="color: #008000;">如果选项queue为false,动画将会立即执行</span>
        jQuery._mark( <span style="color: #0000ff;">this</span><span style="color: #000000;"> );
    }

    </span><span style="color: #0000ff;">var</span> opt = jQuery.extend( {}, optall ),                    <span style="color: #008000;">//</span><span style="color: #008000;">opt是完整选项集optall的副本;</span>
        isElement = <span style="color: #0000ff;">this</span>.nodeType === 1,                    <span style="color: #008000;">//</span><span style="color: #008000;">isElement用于检测当前元素是否是DOM元素</span>
        hidden = isElement &amp;&amp; jQuery(<span style="color: #0000ff;">this</span>).is(":hidden"),    <span style="color: #008000;">//</span><span style="color: #008000;">hidden表示当前元素是否是可见的</span>
<span style="color: #000000;">        name, val, p, e,
        parts, start, end, unit,
        method;

    </span><span style="color: #008000;">//</span><span style="color: #008000;"> will store per property easing and be used to determine when an animation is complete</span>
    opt.animatedProperties = {};                            <span style="color: #008000;">//</span><span style="color: #008000;">存放动画样式的缓存函数，当动画完成后，属性值被设置为true。</span>

    <span style="color: #0000ff;">for</span> ( p <span style="color: #0000ff;">in</span> prop ) {                                        <span style="color: #008000;">//</span><span style="color: #008000;">遍历动画样式集合prop。修正、解析、备份样式        ;p是每一个样式的名称，比如:width height</span>

        <span style="color: #008000;">//</span><span style="color: #008000;"> property name normalization</span>
        name = jQuery.camelCase( p );                            <span style="color: #008000;">//</span><span style="color: #008000;">/将样式名格式化为驼峰式</span>
        <span style="color: #0000ff;">if</span> ( p !==<span style="color: #000000;"> name ) {
            prop[ name ] </span>=<span style="color: #000000;"> prop[ p ];
            </span><span style="color: #0000ff;">delete</span><span style="color: #000000;"> prop[ p ];
        }

        val </span>=<span style="color: #000000;"> prop[ name ];

        </span><span style="color: #008000;">//</span><span style="color: #008000;">获取每个样式的结束值和缓动函数</span>
        <span style="color: #0000ff;">if</span> ( jQuery.isArray( val ) ) {                            <span style="color: #008000;">//</span><span style="color: #008000;">如果样式值是一个数组</span>
            opt.animatedProperties[ name ] = val[ 1 ];                <span style="color: #008000;">//</span><span style="color: #008000;">取第二个元素为该样式的缓动函数</span>
            val = prop[ name ] = val[ 0 ];                            <span style="color: #008000;">//</span><span style="color: #008000;">修正第一个元素为该样式的结束值。</span>
        } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {
            opt.animatedProperties[ name ] </span>= opt.specialEasing &amp;&amp; opt.specialEasing[ name ] || opt.easing || 'swing'<span style="color: #000000;">;
        }

        </span><span style="color: #0000ff;">if</span> ( val === "hide" &amp;&amp; hidden || val === "show" &amp;&amp; !hidden ) {    <span style="color: #008000;">//</span><span style="color: #008000;">如果值是hide但当前元素不可见，或者值是show但当前元素可见，表示不需要执行动画就已经完成了</span>
            <span style="color: #0000ff;">return</span> opt.complete.call( <span style="color: #0000ff;">this</span> );                                 <span style="color: #008000;">//</span><span style="color: #008000;">直接触发完成回调函数。这是一个优化措施</span>
<span style="color: #000000;">        }

        </span><span style="color: #0000ff;">if</span> ( isElement &amp;&amp; ( name === "height" || name === "width" ) ) {    <span style="color: #008000;">//</span><span style="color: #008000;">备份或修正可能影响动画效果的样式，这些样式将在动画完成后被恢复。</span>
            <span style="color: #008000;">//</span><span style="color: #008000;"> Make sure that nothing sneaks out</span>
            <span style="color: #008000;">//</span><span style="color: #008000;"> Record all 3 overflow attributes because IE does not</span>
            <span style="color: #008000;">//</span><span style="color: #008000;"> change the overflow attribute when overflowX and</span>
            <span style="color: #008000;">//</span><span style="color: #008000;"> overflowY are set to the same value</span>
            opt.overflow = [ <span style="color: #0000ff;">this</span>.style.overflow, <span style="color: #0000ff;">this</span>.style.overflowX, <span style="color: #0000ff;">this</span><span style="color: #000000;">.style.overflowY ];

            </span><span style="color: #008000;">//</span><span style="color: #008000;"> Set display property to inline-block for height/width</span>
            <span style="color: #008000;">//</span><span style="color: #008000;"> animations on inline elements that are having width/height animated</span>
            <span style="color: #0000ff;">if</span> ( jQuery.css( <span style="color: #0000ff;">this</span>, "display" ) === "inline" &amp;&amp;<span style="color: #000000;">
                    jQuery.css( </span><span style="color: #0000ff;">this</span>, "float" ) === "none"<span style="color: #000000;"> ) {

                </span><span style="color: #008000;">//</span><span style="color: #008000;"> inline-level elements accept inline-block;</span>
                <span style="color: #008000;">//</span><span style="color: #008000;"> block-level elements need to be inline with layout</span>
                <span style="color: #0000ff;">if</span> ( !jQuery.support.inlineBlockNeedsLayout || defaultDisplay( <span style="color: #0000ff;">this</span>.nodeName ) === "inline"<span style="color: #000000;"> ) {
                    </span><span style="color: #0000ff;">this</span>.style.display = "inline-block"<span style="color: #000000;">;

                } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {
                    </span><span style="color: #0000ff;">this</span>.style.zoom = 1<span style="color: #000000;">;
                }
            }
        }
    }

    </span><span style="color: #0000ff;">if</span> ( opt.overflow != <span style="color: #0000ff;">null</span> ) {         <span style="color: #008000;">//</span><span style="color: #008000;">如果opt.overflow不为空，即样式值是width或height、</span>
        <span style="color: #0000ff;">this</span>.style.overflow = "hidden";     <span style="color: #008000;">//</span><span style="color: #008000;">则设置样式overflow为'hidden'，即超出部分隐藏，这样不影响其他布局</span>
<span style="color: #000000;">    }

    </span><span style="color: #0000ff;">for</span> ( p <span style="color: #0000ff;">in</span> prop ) {                 <span style="color: #008000;">//</span><span style="color: #008000;">再次遍历动画样式集合prop，为每个属性执行动画效果 p是每个样式名，比如:width、height</span>
        e = <span style="color: #0000ff;">new</span> jQuery.fx( <span style="color: #0000ff;">this</span>, opt, p );     <span style="color: #008000;">//</span><span style="color: #ff0000;">调用构造函数jQuery.fn(elem,options,prop)创建一个标准动画对象</span>
        val = prop[ p ];                     <span style="color: #008000;">//</span><span style="color: #008000;">获取设置的结束值，比如:500px,600px</span>

        <span style="color: #0000ff;">if</span> ( rfxtypes.test( val ) ) {         <span style="color: #008000;">//</span><span style="color: #008000;">如果样式值val是toggle、show或hide</span>

            <span style="color: #008000;">//</span><span style="color: #008000;"> Tracks whether to show or hide based on private</span>
            <span style="color: #008000;">//</span><span style="color: #008000;"> data attached to the element</span>
            method = jQuery._data( <span style="color: #0000ff;">this</span>, "toggle" + p ) || ( val === "toggle" ? hidden ? "show" : "hide" : 0<span style="color: #000000;"> );
            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> ( method ) {
                jQuery._data( </span><span style="color: #0000ff;">this</span>, "toggle" + p, method === "show" ? "hide" : "show"<span style="color: #000000;"> );
                e[ method ]();
            } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {
                e[ val ]();
            }

        } </span><span style="color: #0000ff;">else</span> {                             <span style="color: #008000;">//</span><span style="color: #008000;">如果样式值是数值型，则计算开始值start、结束值end、单位unit，然后开始执行动画</span>
            parts = rfxnum.exec( val );         <span style="color: #008000;">//</span><span style="color: #008000;">rfxnum用于匹配样式值中的运算符、数值、单位。rfxnum = /^([+\-]=)?([\d+.\-]+)([a-z%]*)$/i,    格式:Array [ "700px", 符号, "数值", "单位" ] ，比如:'+=20px',匹配后:Array [ "+=20px", "+=", "20", "px" ]</span>
            start = e.cur();                     <span style="color: #008000;">//</span><span style="color: #008000;">获取初始值,比如:200</span>

            <span style="color: #0000ff;">if</span> ( parts ) {                         <span style="color: #008000;">//</span><span style="color: #008000;">如果样式值能够匹配正则parts，则说明是数值型，就计算开始值start、结束值end、单位unit，然后开始执行动画。</span>
                end = parseFloat( parts[2] );                                         <span style="color: #008000;">//</span><span style="color: #008000;">end是传入的样式的数值，可能是结束值，也可能要加上或减去的值</span>
                unit = parts[3] || ( jQuery.cssNumber[ p ] ? "" : "px" );             <span style="color: #008000;">//</span><span style="color: #008000;">unit是最后的单位，如果没有传入则设置为px单位</span>

                <span style="color: #008000;">//</span><span style="color: #008000;"> We need to compute starting value</span>
                <span style="color: #0000ff;">if</span> ( unit !== "px" ) {                                                 <span style="color: #008000;">//</span><span style="color: #008000;">如果结束值的单位不是默认单位px，则将开始值start换算为与结束值end的单位一致的数值。</span>
                    jQuery.style( <span style="color: #0000ff;">this</span>, p, (end || 1) +<span style="color: #000000;"> unit);
                    start </span>= ( (end || 1) / e.cur() ) *<span style="color: #000000;"> start;
                    jQuery.style( </span><span style="color: #0000ff;">this</span>, p, start +<span style="color: #000000;"> unit);
                }

                </span><span style="color: #008000;">//</span><span style="color: #008000;"> If a +=/-= token was provided, we're doing a relative animation</span>
                <span style="color: #0000ff;">if</span> ( parts[1] ) {                                                     <span style="color: #008000;">//</span><span style="color: #008000;">如果样式值以+= 或 -=开头，则用开始值加上或减去给定的值，</span>
                    end = ( (parts[ 1 ] === "-=" ? -1 : 1) * end ) + start;             <span style="color: #008000;">//</span><span style="color: #008000;">得到结束值</span>
<span style="color: #000000;">                }
 
                e.custom( start, end, unit );                                         </span><span style="color: #008000;">//</span><span style="color: #ff0000;">调用jQuery.fx.prototype.custom(from,to,unit)开始执行动画。start是开始值，end是结束值，unit是单位。</span>
<span style="color: #000000;">
            } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {
                e.custom( start, val, </span>"" );                                     <span style="color: #008000;">//</span><span style="color: #008000;">样式值不是数值型时，仍然开始执行动画，以支持插件扩展的动画样式。</span>
<span style="color: #000000;">            }
        }
    }

    </span><span style="color: #008000;">//</span><span style="color: #008000;"> For JS strict compliance</span>
    <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span><span style="color: #000000;">;
}</span></pre>
</div>
<p>函数内首先调用new jQuery.fx()创建一个$.fx对象，最后调用该对象的custom开始执行动画，$.fx的定义如下:</p>
<div class="cnblogs_code">
<pre><code><span style="color: #000000;">jQuery.extend({
    fx: </span><span style="color: #0000ff;">function</span>( elem, options, prop ) {         <span style="color: #008000;">//</span><span style="color: #008000;">jQuery构造函数，用于为单个样式构造动画对象。elem:当前匹配元素、options:当前动画的选项集、prop:参与动画的当前样式。</span>
        <span style="color: #0000ff;">this</span>.options =<span style="color: #000000;"> options;
        </span><span style="color: #0000ff;">this</span>.elem =<span style="color: #000000;"> elem;
        </span><span style="color: #0000ff;">this</span>.prop =<span style="color: #000000;"> prop;

        options.orig </span>= options.orig ||<span style="color: #000000;"> {};
    }
})</span></pre>
</div>
<p>就是在当前实例上挂载几个属性，它的其它方法都定义在原型上的，例如cur和custom如下:</p>
<div class="cnblogs_code">
<pre><code>jQuery.fx.prototype =<span style="color: #000000;"> {
    </span><span style="color: #008000;">//</span><span style="color: #008000;"> Get the current size</span>
    cur: <span style="color: #0000ff;">function</span>() {             <span style="color: #008000;">//</span><span style="color: #008000;">获取this.elem元素this.prop样式当前的值</span>
        <span style="color: #0000ff;">if</span> ( <span style="color: #0000ff;">this</span>.elem[ <span style="color: #0000ff;">this</span>.prop ] != <span style="color: #0000ff;">null</span> &amp;&amp; (!<span style="color: #0000ff;">this</span>.elem.style || <span style="color: #0000ff;">this</span>.elem.style[ <span style="color: #0000ff;">this</span>.prop ] == <span style="color: #0000ff;">null</span>) ) {     <span style="color: #008000;">//</span><span style="color: #008000;">如果当前DOM元素的this.prop属性不为空，且没有style属性或者有style属性但是style[this.prop]为null</span>
            <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span>.elem[ <span style="color: #0000ff;">this</span>.prop ];                                                                                 <span style="color: #008000;">//
</span><span style="color: #000000;">        }

        </span><span style="color: #0000ff;">var</span><span style="color: #000000;"> parsed,
            r </span>= jQuery.css( <span style="color: #0000ff;">this</span>.elem, <span style="color: #0000ff;">this</span>.prop );                             <span style="color: #008000;">//</span><span style="color: #008000;">获取该DOM元素的prop样式的值，比如:200px</span>
        <span style="color: #008000;">//</span><span style="color: #008000;"> Empty strings, null, undefined and "auto" are converted to 0,</span>
        <span style="color: #008000;">//</span><span style="color: #008000;"> complex values such as "rotate(1rad)" are returned as is,</span>
        <span style="color: #008000;">//</span><span style="color: #008000;"> simple values such as "10px" are parsed to Float.</span>
        <span style="color: #0000ff;">return</span> isNaN( parsed = parseFloat( r ) ) ? !r || r === "auto" ? 0<span style="color: #000000;"> : r : parsed;
    },

    </span><span style="color: #008000;">//</span><span style="color: #008000;"> Start an animation from one number to another</span>
    custom: <span style="color: #0000ff;">function</span>( from, to, unit ) {                                     <span style="color: #008000;">//</span><span style="color: #008000;">负责开始执行单个样式的动画。from:当前样式的开始值、to:当前样式的结束值、unit:当前样式的单位。</span>
        <span style="color: #0000ff;">var</span> self = <span style="color: #0000ff;">this</span>,                                                         <span style="color: #008000;">//</span><span style="color: #008000;">self是当前样式的jQuery.fx对象</span>
            fx =<span style="color: #000000;"> jQuery.fx;

        </span><span style="color: #0000ff;">this</span>.startTime = fxNow || createFxNow();                                 <span style="color: #008000;">//</span><span style="color: #008000;">动画开始的时间，值为当前时间，每次调用animate()方法时多个样式的该值是一样的。</span>
        <span style="color: #0000ff;">this</span>.end = to;                                                            <span style="color: #008000;">//</span><span style="color: #008000;">当前样式的结束值</span>
        <span style="color: #0000ff;">this</span>.now = <span style="color: #0000ff;">this</span>.start = from;                                            <span style="color: #008000;">//</span><span style="color: #008000;">当前样式的单位。</span>
        <span style="color: #0000ff;">this</span>.pos = <span style="color: #0000ff;">this</span>.state = 0;                                                <span style="color: #008000;">//</span><span style="color: #008000;">this.now:当前帧样式值    、this.start:当前样式的开始值</span>
        <span style="color: #0000ff;">this</span>.unit = unit || <span style="color: #0000ff;">this</span>.unit || ( jQuery.cssNumber[ <span style="color: #0000ff;">this</span>.prop ] ? "" : "px" );     <span style="color: #008000;">//</span><span style="color: #008000;">this.pos:差值百分比。this.state:已执行时间的百分比    </span>

        <span style="color: #0000ff;">function</span> t( gotoEnd ) {                                                 <span style="color: #008000;">//</span><span style="color: #008000;">构造封装了jQuery.fx.prototype.step()的单帧闭包动画函数，函数t通过闭包机制引用jQuery.fx()对象。</span>
            <span style="color: #0000ff;">return</span><span style="color: #000000;"> self.step( gotoEnd );
        }

        t.queue </span>= <span style="color: #0000ff;">this</span>.options.queue;         <span style="color: #008000;">//</span><span style="color: #008000;">动画类型，默认为:fx</span>
        t.elem = <span style="color: #0000ff;">this</span>.elem;                 <span style="color: #008000;">//</span><span style="color: #008000;">elem是当前匹配元素</span>
        t.saveState = <span style="color: #0000ff;">function</span>() {             <span style="color: #008000;">//</span><span style="color: #008000;">记录当前样式动画的状态，在stop()中用的到</span>
            <span style="color: #0000ff;">if</span> ( self.options.hide &amp;&amp; jQuery._data( self.elem, "fxshow" + self.prop ) ===<span style="color: #000000;"> undefined ) {     
                jQuery._data( self.elem, </span>"fxshow" +<span style="color: #000000;"> self.prop, self.start );
            }
        };

        </span><span style="color: #0000ff;">if</span> ( t() &amp;&amp; jQuery.timers.push(t) &amp;&amp; !timerId ) {                         <span style="color: #008000;">//</span><span style="color: #008000;">执行单帧闭包动画函数t(gotoEnd)，如果该函数返回true则表示动画尚未完成，则并将其插入全局动画函数数组jQuery.timers中，如果timeId不存在,timeId是执行动画的全局定时器。</span>
            timerId = setInterval( fx.tick, fx.interval );                             <span style="color: #008000;">//</span><span style="color: #008000;">创建一个定时器。周期性的执行jQuery.fx.tick()方法，从而开始执行动画。</span>
<span style="color: #000000;">        }
    },</span></pre>
</div>
<p>$.tick()内会执行setInterval，隔13毫秒就执行一次 t() 函数，t函数内会执行step()函数，该函数会计算匹配元素下一次的样式值，如下:</p>
<p class="hwi">&nbsp;writer by:大沙漠 QQ:22969969</p>
<div class="cnblogs_code">
<pre><code>jQuery.fx.prototype =<span style="color: #000000;"> {
    step: </span><span style="color: #0000ff;">function</span>( gotoEnd ) {             <span style="color: #008000;">//</span><span style="color: #008000;">负责计算和执行当前样式动画的一帧。</span>
        <span style="color: #0000ff;">var</span><span style="color: #000000;"> p, n, complete,
            t </span>= fxNow || createFxNow(),         <span style="color: #008000;">//</span><span style="color: #008000;">t是当前时间</span>
            done = <span style="color: #0000ff;">true</span><span style="color: #000000;">,
            elem </span>= <span style="color: #0000ff;">this</span>.elem,                     <span style="color: #008000;">//</span><span style="color: #008000;">匹配元素</span>
            options = <span style="color: #0000ff;">this</span>.options;             <span style="color: #008000;">//</span><span style="color: #008000;">选项</span>

        <span style="color: #0000ff;">if</span> ( gotoEnd || t &gt;= options.duration + <span style="color: #0000ff;">this</span>.startTime ) {     <span style="color: #008000;">//</span><span style="color: #008000;"><span style="color: #ff0000;">动画已完成的逻辑</span> 如果参数totoEnd为true(stop())调用时),或超出了动画完成时间，最后会返回false</span>
            <span style="color: #0000ff;">this</span>.now = <span style="color: #0000ff;">this</span>.end;                                         <span style="color: #008000;">//</span><span style="color: #008000;">设置当前帧式值为结束值</span>
            <span style="color: #0000ff;">this</span>.pos = <span style="color: #0000ff;">this</span>.state = 1;                                     <span style="color: #008000;">//</span><span style="color: #008000;">设置已执行时间百分比和差值百分比为1</span>
            <span style="color: #0000ff;">this</span>.update();                                                 <span style="color: #008000;">//</span><span style="color: #008000;">调用update()更新样式值。这三行代码是用来修正动画可能导致的样式误差的。</span>
<span style="color: #000000;">
            options.animatedProperties[ </span><span style="color: #0000ff;">this</span>.prop ] = <span style="color: #0000ff;">true</span>;             <span style="color: #008000;">//</span><span style="color: #008000;">设置options.animatedProperties[ this.prop ]为true,表示当前样式动画已经执行完成。</span>

            <span style="color: #0000ff;">for</span> ( p <span style="color: #0000ff;">in</span><span style="color: #000000;"> options.animatedProperties ) {
                </span><span style="color: #0000ff;">if</span> ( options.animatedProperties[ p ] !== <span style="color: #0000ff;">true</span><span style="color: #000000;"> ) {
                    done </span>= <span style="color: #0000ff;">false</span><span style="color: #000000;">;
                }
            }

            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> ( done ) {
                </span><span style="color: #008000;">//</span><span style="color: #008000;"> Reset the overflow</span>
                <span style="color: #0000ff;">if</span> ( options.overflow != <span style="color: #0000ff;">null</span> &amp;&amp; !<span style="color: #000000;">jQuery.support.shrinkWrapBlocks ) {

                    jQuery.each( [ </span>"", "X", "Y" ], <span style="color: #0000ff;">function</span><span style="color: #000000;">( index, value ) {
                        elem.style[ </span>"overflow" + value ] =<span style="color: #000000;"> options.overflow[ index ];
                    });
                }

                </span><span style="color: #008000;">//</span><span style="color: #008000;"> Hide the element if the "hide" operation was done</span>
                <span style="color: #0000ff;">if</span><span style="color: #000000;"> ( options.hide ) {
                    jQuery( elem ).hide();
                }

                </span><span style="color: #008000;">//</span><span style="color: #008000;"> Reset the properties, if the item has been hidden or shown</span>
                <span style="color: #0000ff;">if</span> ( options.hide ||<span style="color: #000000;"> options.show ) {
                    </span><span style="color: #0000ff;">for</span> ( p <span style="color: #0000ff;">in</span><span style="color: #000000;"> options.animatedProperties ) {
                        jQuery.style( elem, p, options.orig[ p ] );
                        jQuery.removeData( elem, </span>"fxshow" + p, <span style="color: #0000ff;">true</span><span style="color: #000000;"> );
                        </span><span style="color: #008000;">//</span><span style="color: #008000;"> Toggle data is no longer needed</span>
                        jQuery.removeData( elem, "toggle" + p, <span style="color: #0000ff;">true</span><span style="color: #000000;"> );
                    }
                }

                </span><span style="color: #008000;">//</span><span style="color: #008000;"> Execute the complete function</span>
                <span style="color: #008000;">//</span><span style="color: #008000;"> in the event that the complete function throws an exception</span>
                <span style="color: #008000;">//</span><span style="color: #008000;"> we must ensure it won't be called twice. #5684</span>
<span style="color: #000000;">
                complete </span>=<span style="color: #000000;"> options.complete;
                </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> ( complete ) {

                    options.complete </span>= <span style="color: #0000ff;">false</span><span style="color: #000000;">;
                    complete.call( elem );
                }
            }

            </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span><span style="color: #000000;">;

        } </span><span style="color: #0000ff;">else</span> {                                                     <span style="color: #008000;">//</span><span style="color: #ff0000;">如果当前样式动画尚未完成</span>
            <span style="color: #008000;">//</span><span style="color: #008000;"> classical easing cannot be used with an Infinity duration</span>
            <span style="color: #0000ff;">if</span> ( options.duration ==<span style="color: #000000;"> Infinity ) {
                </span><span style="color: #0000ff;">this</span>.now =<span style="color: #000000;"> t;
            } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {
                n </span>= t - <span style="color: #0000ff;">this</span>.startTime;                             <span style="color: #008000;">//</span><span style="color: #008000;">n = 当前时间-开始时间 = 已执行时间</span>
                <span style="color: #0000ff;">this</span>.state = n / options.duration;                     <span style="color: #008000;">//</span><span style="color: #008000;">已执行时间百分比 = 已执行时间/运行时间</span>

                <span style="color: #008000;">//</span><span style="color: #008000;"> Perform the easing function, defaults to swing</span>
                <span style="color: #0000ff;">this</span>.pos = jQuery.easing[ options.animatedProperties[<span style="color: #0000ff;">this</span>.prop] ]( <span style="color: #0000ff;">this</span>.state, n, 0, 1, options.duration );     <span style="color: #008000;">//</span><span style="color: #008000;">差值百分比=缓动函数(已执行时间百分比，已执行时间，0，1，运行时间)</span>
                <span style="color: #0000ff;">this</span>.now = <span style="color: #0000ff;">this</span>.start + ( (<span style="color: #0000ff;">this</span>.end - <span style="color: #0000ff;">this</span>.start) * <span style="color: #0000ff;">this</span>.pos );                                                 <span style="color: #008000;">//</span><span style="color: #008000;">当前帧样式值=开始值+差值百分比*(结束值-开始值)</span>
<span style="color: #000000;">            }
            </span><span style="color: #008000;">//</span><span style="color: #008000;"> Perform the next step of the animation</span>
            <span style="color: #0000ff;">this</span>.update();                                                                                                         <span style="color: #008000;">//</span><span style="color: #008000;">更新样式值。</span>
<span style="color: #000000;">        }

        </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span><span style="color: #000000;">;
    }
}</span></pre>
</div>
<p>计算出样式值后会将值保存到this.now上面，最终调用this.update()进行更新样式，update源码如下:</p>
<div class="cnblogs_code">
<pre><code>jQuery.fx.prototype =<span style="color: #000000;"> {
    update: </span><span style="color: #0000ff;">function</span>() {                 <span style="color: #008000;">//</span><span style="color: #008000;">更新当前样式的值。内部通过jQuery.fx.step中的方法来更新样式的值</span>
        <span style="color: #0000ff;">if</span> ( <span style="color: #0000ff;">this</span>.options.step ) {                 <span style="color: #008000;">//</span><span style="color: #008000;">如果当前的animate指定了step回调函数</span>
            <span style="color: #0000ff;">this</span>.options.step.call( <span style="color: #0000ff;">this</span>.elem, <span style="color: #0000ff;">this</span>.now, <span style="color: #0000ff;">this</span> );     <span style="color: #008000;">//</span><span style="color: #008000;">则调用该回调函数，参数分别是当前样式的值和元素的引用</span>
<span style="color: #000000;">        }

        ( jQuery.fx.step[ </span><span style="color: #0000ff;">this</span>.prop ] || jQuery.fx.step._default )( <span style="color: #0000ff;">this</span> );     <span style="color: #008000;">//</span><span style="color: #008000;">否则调用默认方法jQuery.fx.step._default()直接设置内联样式(style属性)或DOM属性。</span>
<span style="color: #000000;">    },
}</span></pre>
</div>
<p>可以看到优先通过$.fx.step来进行修改样式，其次通过$.fx.step._default来修改，如下:</p>
<div class="cnblogs_code">
<pre><code><span style="color: #000000;">jQuery.extend( jQuery.fx, {
    step: {                     </span><span style="color: #008000;">//</span><span style="color: #008000;">最后的步骤:更新样式</span>
        opacity: <span style="color: #0000ff;">function</span>( fx ) {         <span style="color: #008000;">//</span><span style="color: #008000;">修正样式opacity的设置行为</span>
            jQuery.style( fx.elem, "opacity"<span style="color: #000000;">, fx.now );
        },

        _default: </span><span style="color: #0000ff;">function</span>( fx ) {         <span style="color: #008000;">//</span><span style="color: #008000;">默认情况下，通过直接设置内联属性(style属性)或DOM属性更新样式值。</span>
            <span style="color: #0000ff;">if</span> ( fx.elem.style &amp;&amp; fx.elem.style[ fx.prop ] != <span style="color: #0000ff;">null</span> ) {     <span style="color: #008000;">//</span><span style="color: #ff0000;">如果当前元素有style属性，并且syle含有指定的样式</span>
                fx.elem.style[ fx.prop ] = fx.now + fx.unit;                 <span style="color: #008000;">//</span><span style="color: #008000;">在style属性上设置样式值</span>
            } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {
                fx.elem[ fx.prop ] </span>= fx.now;                               <span style="color: #008000;">//</span><span style="color: #ff0000;">否则在DOM元素上设置DOM属性，例如:scrollTop、scrollLeft</span>
<span style="color: #000000;">            }
        }
    }
})</span></pre>
</div>
<p>可以看到最终就是修改的元素的style来修改样式的，或者直接修改DOM对象属性。</p>
</div>
</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>