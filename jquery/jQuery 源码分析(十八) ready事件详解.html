<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修jQuery 源码分析(十八) ready事件详解' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>jQuery 源码分析(十八) ready事件详解</center></div><div class='banquan'>原文出处:本文由博客园博主大沙漠提供。<br/>
原文连接:https://www.cnblogs.com/greatdesert/p/11720567.html</div><br>
    <p>ready事件是当DOM文档树加载完成后执行一个函数(不包含图片，css等)，因此它的触发要早于load事件。用法:</p>
<ul>
<li>$(document).ready(fun)　　　　;fun是一个函数，这样当DOM树加载完毕后就会执行该匿名函数了</li>
</ul>
<p>ready有一个简写，可以直接传入$(fun)即可，这是因为在jQuey内部也定义了一个$(document)的jQuery对象，和我们在上面的写法是一样的</p>
<p>ready事件和window的onload区别:</p>
<ul>
<li>ready事件　　;等dom树载完毕后就可以执行</li>
<li>onload事件　&nbsp; ;等网页中所有的资源加载完毕后(包括图片，flash,音频，视频)才能执行 　　</li>
</ul>
<p>onload事件还可以绑定在某个图片上面，举个例子:</p>
<div class="cnblogs_code">
<pre><code><span style="color: #0000ff;">&lt;!</span><span style="color: #ff00ff;">DOCTYPE html</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #0000ff;">&lt;</span><span style="color: #800000;">html </span><span style="color: #ff0000;">lang</span><span style="color: #0000ff;">="en"</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #0000ff;">&lt;</span><span style="color: #800000;">head</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">meta </span><span style="color: #ff0000;">charset</span><span style="color: #0000ff;">="UTF-8"</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">title</span><span style="color: #0000ff;">&gt;</span>Document<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">title</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">script </span><span style="color: #ff0000;">src</span><span style="color: #0000ff;">="http://libs.baidu.com/jquery/1.11.1/jquery.min.js"</span><span style="color: #0000ff;">&gt;&lt;/</span><span style="color: #800000;">script</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">head</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #0000ff;">&lt;</span><span style="color: #800000;">body</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">img </span><span style="color: #ff0000;">src</span><span style="color: #0000ff;">="https://www.cnblogs.com/images/logo_small.gif"</span><span style="color: #ff0000;">  alt</span><span style="color: #0000ff;">=""</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">script</span><span style="color: #0000ff;">&gt;</span><span style="background-color: #f5f5f5; color: #000000;">
        $(()</span><span style="background-color: #f5f5f5; color: #000000;">=&gt;</span><span style="background-color: #f5f5f5; color: #000000;">console.log(</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">DOM树已加载完毕</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">))                        </span><span style="background-color: #f5f5f5; color: #008000;">//</span><span style="background-color: #f5f5f5; color: #008000;">ready事件</span>
<span style="background-color: #f5f5f5; color: #000000;">        $(</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">img</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">).on(</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">load</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">,()</span><span style="background-color: #f5f5f5; color: #000000;">=&gt;</span><span style="background-color: #f5f5f5; color: #000000;">console.log(</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">图片已加载完毕</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">))        </span><span style="background-color: #f5f5f5; color: #008000;">//</span><span style="background-color: #f5f5f5; color: #008000;">图片的加载事件</span>
<span style="background-color: #f5f5f5; color: #000000;">        $(window).on(</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">load</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">,()</span><span style="background-color: #f5f5f5; color: #000000;">=&gt;</span><span style="background-color: #f5f5f5; color: #000000;">console.log(</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">资源已加载完毕</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">))       </span><span style="background-color: #f5f5f5; color: #008000;">//</span><span style="background-color: #f5f5f5; color: #008000;">网页所有资源都加载完毕后的事件        </span>
    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">script</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">body</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">html</span><span style="color: #0000ff;">&gt;</span></pre>
</div>
<p>这里我们用了箭头函数来写，代码很简单了，我们在绑定了一个ready事件，一个图片上的onload事件和window上的onload事件，加载后输出如下:</p>
<p><img src="./images/jQuery 源码分析(十八) ready事件详解0.png" alt="" /></p>
<p>&nbsp;<span style="color: #ff0000;">可以看到首先是ready事件的触发，然后是图片的onload事件，最后是window的onload事件的触发，此时所有资源都已经加载完了</span></p>
<p>&nbsp;</p>
<p><strong><span style="font-size: 18pt;">源码分析</span></strong></p>
<hr />
<p>&nbsp;jquery的ready事件就是在document上绑定了一个DOMContentLoaded事件对象，对他进行了一下封装，DOMContentLoaded事件的原理可以看看看这篇文章，介绍得挺详细的:<a href="https://www.cnblogs.com/caizhenbo/p/6679478.html" target="_blank">https://www.cnblogs.com/caizhenbo/p/6679478.html</a></p>
<p>jQuery的ready事件是基于函数列表实现的，函数列表可以看这个连接:<a href="https://www.cnblogs.com/greatdesert/p/11433365.html" target="_blank">https://www.cnblogs.com/greatdesert/p/11433365.html</a></p>
<p>当我们调用$(fun)去执行一个ready事件的时候首先会执行入口模块里的逻辑，与ready相关的如下:</p>
<div class="cnblogs_code">
<pre><code>init: <span style="color: #0000ff;">function</span><span style="color: #000000;">( selector, context, rootjQuery ) {
    </span><span style="color: #0000ff;">var</span><span style="color: #000000;"> match, elem, ret, doc;

    </span><span style="color: #008000;">//</span><span style="color: #008000;"> Handle $(""), $(null), or $(undefined)</span>
    <span style="color: #0000ff;">if</span> ( !<span style="color: #000000;">selector ) {
        </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">;
    }

    </span><span style="color: #008000;">//</span><span style="color: #008000;"> Handle $(DOMElement)</span>
    <span style="color: #0000ff;">if</span><span style="color: #000000;"> ( selector.nodeType ) {
        </span><span style="color: #0000ff;">this</span>.context = <span style="color: #0000ff;">this</span>[0] =<span style="color: #000000;"> selector;
        </span><span style="color: #0000ff;">this</span>.length = 1<span style="color: #000000;">;
        </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">;
    }

    </span><span style="color: #008000;">//</span><span style="color: #008000;"> The body element only exists once, optimize finding it</span>
    <span style="color: #0000ff;">if</span> ( selector === "body" &amp;&amp; !context &amp;&amp;<span style="color: #000000;"> document.body ) {
        </span><span style="color: #0000ff;">this</span>.context =<span style="color: #000000;"> document;
        </span><span style="color: #0000ff;">this</span>[0] =<span style="color: #000000;"> document.body;
        </span><span style="color: #0000ff;">this</span>.selector =<span style="color: #000000;"> selector;
        </span><span style="color: #0000ff;">this</span>.length = 1<span style="color: #000000;">;
        </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">;
    }

    </span><span style="color: #008000;">//</span><span style="color: #008000;"> Handle HTML strings</span>
    <span style="color: #0000ff;">if</span> ( <span style="color: #0000ff;">typeof</span> selector === "string"<span style="color: #000000;"> ) {
        </span><span style="color: #008000;">/*</span><span style="color: #008000;">略</span><span style="color: #008000;">*/</span><span style="color: #000000;">
    } </span><span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> ( jQuery.isFunction( selector ) ) {            <span style="color: #008000;">//</span><span style="color: #008000;">如果参数selector是函数，则认为是绑定ready事件</span>
        <span style="color: #0000ff;">return</span> rootjQuery.ready( selector );                    <span style="color: #008000;">//</span><span style="color: #008000;">则执行rootjQuery.ready()方法，并把selector作为参数传入</span>
<span style="color: #000000;">    }

    </span><span style="color: #008000;">/*</span><span style="color: #008000;">略</span><span style="color: #008000;">*/</span><span style="color: #000000;">
},</span></pre>
</div>
<p>rootjQuery是jQuery内部定义的一个局部变量，是一个jQuery实例，如下:</p>
<div class="cnblogs_code">
<pre><code>rootjQuery = jQuery(document);             　　　　　　　　　　<span style="color: #008000;">//</span><span style="color: #008000;">第917行，保存了document对象引用的jQuery实例</span></pre>
</div>
<p>在入口模块引用rootjQuery.ready()也就是执行了rootjQuery实例对象上的ready方法(该方法是定义在原型上的),如下:</p>
<div class="cnblogs_code">
<pre><code>jQuery.fn = jQuery.prototype =<span style="color: #000000;"> {
    ready: </span><span style="color: #0000ff;">function</span><span style="color: #000000;">( fn ) {
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> Attach the listeners</span>
        jQuery.bindReady();                 <span style="color: #008000;">//</span><span style="color: #008000;">先执行jQuery.bindReady()绑定ready事件(实际上绑定的是DOMContentLoaded或onreadystatechange事件)</span>

        <span style="color: #008000;">//</span><span style="color: #008000;"> Add the callback</span>
        readyList.add( fn );                <span style="color: #008000;">//</span><span style="color: #008000;">为函数列表readyList增加一个函数</span>

        <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">;
    }
}</span></pre>
</div>
<p>jQuery.bindReady()是一个静态方法，用于绑定事件的，内部会初始化readyList为一个jQuery.Callbacks( "once memory" )函数列表对象</p>
<p>然后执行readyList.add( fn )将fn函数保存到函数列表readyList里面。</p>
<p>jQuery.bindReady()的实现如下:</p>
<div class="cnblogs_code">
<pre><code><span style="color: #000000;">jQuery.extend({
    bindReady: </span><span style="color: #0000ff;">function</span>() {                            <span style="color: #008000;">//</span><span style="color: #008000;">初始化ready事件监听函数列表readyList，并为document对象绑定ready事件主监听函数DOMContentLoaded</span>
        <span style="color: #0000ff;">if</span><span style="color: #000000;"> ( readyList ) {
            </span><span style="color: #0000ff;">return</span><span style="color: #000000;">;
        }

        readyList </span>= jQuery.Callbacks( "once memory" );                        <span style="color: #008000;">//</span><span style="color: #008000;">调用jQuery.Callbacks(flags)ready事件监听函数列表readylist，同时传入once和memory标记。</span>

        <span style="color: #008000;">//</span><span style="color: #008000;"> Catch cases where $(document).ready() is called after the</span>
        <span style="color: #008000;">//</span><span style="color: #008000;"> browser event has already occurred.</span>
        <span style="color: #0000ff;">if</span> ( document.readyState === "complete" ) {                            <span style="color: #008000;">//</span><span style="color: #008000;">如果文档已经就绪，则调用jQuery.ready(wait)执行ready事件监听函数列表readyList</span>
            <span style="color: #008000;">//</span><span style="color: #008000;"> Handle it asynchronously to allow scripts the opportunity to delay ready</span>
            <span style="color: #0000ff;">return</span> setTimeout( jQuery.ready, 1 );                                <span style="color: #008000;">//</span><span style="color: #008000;">通过setTimeout()异步执行方法jQuery.ready(wait)，以允许其他脚本延迟ready事件的触发。</span>
<span style="color: #000000;">        }

        </span><span style="color: #008000;">//</span><span style="color: #008000;"> Mozilla, Opera and webkit nightlies currently support this event</span>
        <span style="color: #0000ff;">if</span> ( document.addEventListener ) {                                     <span style="color: #008000;">//</span><span style="color: #008000;">在IE9+及以上浏览器绑定DOMContentLoaded事件</span>
            <span style="color: #008000;">//</span><span style="color: #008000;"> Use the handy event callback</span>
            document.addEventListener( "DOMContentLoaded", DOMContentLoaded, <span style="color: #0000ff;">false</span> );         <span style="color: #008000;">//</span><span style="color: #ff0000;">把监听函数DOMContentLoaded绑定到document对象的DOMContentLoaded事件上</span>

            <span style="color: #008000;">//</span><span style="color: #008000;"> A fallback to window.onload, that will always work</span>
            window.addEventListener( "load", jQuery.ready, <span style="color: #0000ff;">false</span><span style="color: #000000;"> );

        </span><span style="color: #008000;">//</span><span style="color: #008000;"> If IE event model is used</span>
        } <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span><span style="color: #000000;"> ( document.attachEvent ) {
            </span><span style="color: #008000;">//</span><span style="color: #008000;"> ensure firing before onload,</span>
            <span style="color: #008000;">//</span><span style="color: #008000;"> maybe late but safe also for iframes</span>
            document.attachEvent( "onreadystatechange"<span style="color: #000000;">, DOMContentLoaded );

            </span><span style="color: #008000;">//</span><span style="color: #008000;"> A fallback to window.onload, that will always work</span>
            window.attachEvent( "onload"<span style="color: #000000;">, jQuery.ready );

            </span><span style="color: #008000;">//</span><span style="color: #008000;"> If IE and not a frame</span>
            <span style="color: #008000;">//</span><span style="color: #008000;"> continually check to see if the document is ready</span>
            <span style="color: #0000ff;">var</span> toplevel = <span style="color: #0000ff;">false</span><span style="color: #000000;">;

            </span><span style="color: #0000ff;">try</span><span style="color: #000000;"> {
                toplevel </span>= window.frameElement == <span style="color: #0000ff;">null</span><span style="color: #000000;">;
            } </span><span style="color: #0000ff;">catch</span><span style="color: #000000;">(e) {}

            </span><span style="color: #0000ff;">if</span> ( document.documentElement.doScroll &amp;&amp;<span style="color: #000000;"> toplevel ) {
                doScrollCheck();
            }
        }
    },
    </span><span style="color: #008000;">/*</span><span style="color: #008000;">略</span><span style="color: #008000;">*/</span><span style="color: #000000;">
})</span></pre>
</div>
<p>这里我们调用document.addEventListener在document上绑定了一个DOMContentLoaded事件，这样当DOM树加载完后就会执行DOMContentLoaded函数了，DOMContentLoaded函数的定义如下:</p>
<div class="cnblogs_code">
<pre><code><span style="color: #0000ff;">if</span> ( document.addEventListener ) {         <span style="color: #008000;">//</span><span style="color: #008000;">如果是IE9+和其他浏览器</span>
    DOMContentLoaded = <span style="color: #0000ff;">function</span><span style="color: #000000;">() {
        document.removeEventListener( </span>"DOMContentLoaded", DOMContentLoaded, <span style="color: #0000ff;">false</span> );    <span style="color: #008000;">//</span><span style="color: #ff0000;">先移除document的DOMContentLoaded事件</span>
        jQuery.ready();                                                                    <span style="color: #008000;">//</span><span style="color: #ff0000;">再调用jQuery.ready()执行ready事件监听函数</span>
<span style="color: #000000;">    };

} </span><span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span><span style="color: #000000;"> ( document.attachEvent ) {
    DOMContentLoaded </span>= <span style="color: #0000ff;">function</span><span style="color: #000000;">() {
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> Make sure body exists, at least, in case IE gets a little overzealous (ticket #5443).</span>
        <span style="color: #0000ff;">if</span> ( document.readyState === "complete"<span style="color: #000000;"> ) {
            document.detachEvent( </span>"onreadystatechange"<span style="color: #000000;">, DOMContentLoaded );
            jQuery.ready();
        }
    };
}</span></pre>
</div>
<p>函数内首先会移除DOMContentLoaded事件，然后调用jQuery.ready()事件，这是DOM树触发后的事件了(我们在jQuery.fn.ready()内执行了readyList.add( fn )增加的函数都会依次触发)，如下:</p>
<div class="cnblogs_code">
<pre><code><span style="color: #000000;">jQuery.extend({
    isReady: </span><span style="color: #0000ff;">false</span><span style="color: #000000;">,
    ready: </span><span style="color: #0000ff;">function</span>( wait ) {                        <span style="color: #008000;">//</span><span style="color: #008000;">实际执行的函数  触发ready事件监听函数列表readyList和数据缓存对象中的ready事件监听函数。</span>
        <span style="color: #008000;">//</span><span style="color: #008000;"> Either a released hold or an DOMready/load event and not yet ready</span>
        <span style="color: #0000ff;">if</span> ( (wait === <span style="color: #0000ff;">true</span> &amp;&amp; !--jQuery.readyWait) || (wait !== <span style="color: #0000ff;">true</span> &amp;&amp; !jQuery.isReady) ) {    <span style="color: #008000;">//</span><span style="color: #008000;">如果wait是true且jQuery.readyWait等于0 或者 wait不是true且jQuery.isReady是false 则执行 初始化jQuery.isReady为false的</span>
            <span style="color: #008000;">//</span><span style="color: #008000;"> Make sure body exists, at least, in case IE gets a little overzealous (ticket #5443).</span>
            <span style="color: #0000ff;">if</span> ( !<span style="color: #000000;">document.body ) {
                </span><span style="color: #0000ff;">return</span> setTimeout( jQuery.ready, 1<span style="color: #000000;"> );
            }

            </span><span style="color: #008000;">//</span><span style="color: #008000;"> Remember that the DOM is ready</span>
            jQuery.isReady = <span style="color: #0000ff;">true</span>;                                        <span style="color: #008000;">//</span><span style="color: #008000;">设置jQuery.inReady为true,表示ready事件已就绪。</span>

            <span style="color: #008000;">//</span><span style="color: #008000;"> If a normal DOM Ready event fired, decrement, and wait if need be</span>
            <span style="color: #0000ff;">if</span> ( wait !== <span style="color: #0000ff;">true</span> &amp;&amp; --jQuery.readyWait &gt; 0<span style="color: #000000;"> ) {
                </span><span style="color: #0000ff;">return</span><span style="color: #000000;">;
            }

            </span><span style="color: #008000;">//</span><span style="color: #008000;"> If there are functions bound, to execute</span>
            readyList.fireWith( document, [ jQuery ] );                 <span style="color: #008000;">//</span><span style="color: #ff0000;">执行ready事件监听函数readyList,上下文是document(即关键词this)，[jQuery]是ready事件监听函数的参数。</span>

            <span style="color: #008000;">//</span><span style="color: #008000;"> Trigger any bound ready events</span>
            <span style="color: #0000ff;">if</span><span style="color: #000000;"> ( jQuery.fn.trigger ) {
                jQuery( document ).trigger( </span>"ready" ).off( "ready"<span style="color: #000000;"> );
            }
        }
    },
    </span><span style="color: #008000;">/*</span><span style="color: #008000;">略</span><span style="color: #008000;">*/</span><span style="color: #000000;">
})</span></pre>
</div>
<p class="hwi">&nbsp;writer by:大沙漠 QQ:22969969</p>
<p>最后调用readyList.fireWith()方法去触发回掉函数列表里的每个函数。</p>
<p>&nbsp;</p>
</div>
</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>