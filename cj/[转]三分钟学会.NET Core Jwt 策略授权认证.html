<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='ç”µè„‘,ç”µè„‘è®²è§£,ç”µè„‘æŠ€æœ¯,ç¼–ç¨‹,ç”µè„‘æ•…éšœç»´ä¿®[è½¬]ä¸‰åˆ†é’Ÿå­¦ä¼š.NET Core Jwt ç­–ç•¥æˆæƒè®¤è¯' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>é¦–é¡µ</a></li>
</div><div onclick='hidden1()' >åˆ†äº«</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>[è½¬]ä¸‰åˆ†é’Ÿå­¦ä¼š.NET Core Jwt ç­–ç•¥æˆæƒè®¤è¯</center></div><div class='banquan'>åŸæ–‡å‡ºå¤„:æœ¬æ–‡ç”±åšå®¢å›­åšä¸»StudyCSharpæä¾›ã€‚<br/>
åŸæ–‡è¿æ¥:https://www.cnblogs.com/Study-Csharp/p/12114263.html</div><br>
    <h1 id="è½¬ä¸‰åˆ†é’Ÿå­¦ä¼š.net-core-jwt-ç­–ç•¥æˆæƒè®¤è¯"><a href="https://www.cnblogs.com/ZaraNet/p/12105688.html">[è½¬]ä¸‰åˆ†é’Ÿå­¦ä¼š.NET Core Jwt ç­–ç•¥æˆæƒè®¤è¯</a></h1>
<h2 id="ä¸€.å‰è¨€">ä¸€.å‰è¨€<a href="https://www.cnblogs.com/ZaraNet/p/12105688.html#4112395794">#</a></h2>
<p>ã€€ã€€å¤§å®¶å¥½æˆ‘åˆå›æ¥äº†ï¼Œå‰å‡ å¤©è®²è¿‡ä¸€ä¸ªå…³äºJwtçš„èº«ä»½éªŒè¯æœ€ç®€å•çš„æ¡ˆä¾‹ï¼Œä½†æ˜¯åŠŸèƒ½è¿˜æ˜¯ä¸å¤Ÿå¼ºå¤§ï¼Œä¸é€‚ç”¨äºçœŸæ­£çš„é¡¹ç›®ï¼Œæ˜¯çš„ï¼Œåœ¨çœŸæ­£é¢å¯¹å¤æ‚è€Œåˆè‹›åˆ»çš„å®¢æˆ·ä¸­ï¼Œæˆ‘ä»¬ä¼šä¸çŸ¥æ‰€æªï¼Œå°±ç°åœ¨éœ€è¦å°†è®¤è¯æˆæƒè¿™ä¸€å—ä¹Ÿå˜çš„å¤æ‚è€Œåˆå®ç”¨èµ·æ¥ï¼Œé‚£åœ¨ä¸“ä¸šæœ¯è¯­ä¸­å°±å«åšè‡ªå®šä¹‰ç­–ç•¥çš„APIè®¤è¯ï¼Œæœ¬æ¬¡æ¡ˆä¾‹è¿è¡Œåœ¨.NET Core 3.0ä¸­ï¼Œæœ€åæˆ‘ä»¬å°†åœ¨swaggerä¸­è¿›è¡Œæµè§ˆï¼Œæ¥å°è¯•é¡¹ç›®æ˜¯å¦æ­£å¸¸ï¼Œå¯¹äº.NET Core 2.x ç‰ˆæœ¬ï¼Œè¿™ç¯‡æ–‡ç« æœ‰äº›ä»£ç ä¸é€‚ç”¨ï¼Œä½†æˆ‘ä¼šåœ¨æ–‡ä¸­è¯´æ˜ã€‚</p>
<h2 id="äºŒ.åœ¨.net-coreä¸­å°è¯•">äºŒ.åœ¨.NET Coreä¸­å°è¯•<a href="https://www.cnblogs.com/ZaraNet/p/12105688.html#3055150705">#</a></h2>
<p>ã€€ã€€æˆ‘ä»¬éƒ½çŸ¥é“Jwtæ˜¯ä¸ºäº†è®¤è¯ï¼Œå¾®è½¯ç»™æˆ‘ä»¬æä¾›äº†è¿›åŸæ‰“é¬¼å­çš„åŸé—¨ï¼Œé‚£å°±æ˜¯ AuthorizationHandleã€‚</p>
<p>ã€€ã€€æˆ‘ä»¬é¦–å…ˆè¦å®ç°å®ƒï¼Œå¹¶ä¸”æˆ‘ä»¬è¿˜å¯ä»¥æ ¹æ®ä¾èµ–æ³¨å…¥çš„ AuthorizationHandlerContext æ¥è·å–ä¸Šä¸‹æ–‡ï¼Œå°±è¿™æ ·æˆ‘ä»¬å°±æ›´å¯ä»¥åšä¸€äº›æƒé™çš„æ‰‹è„š</p>
<p><a><img src="./images/[è½¬]ä¸‰åˆ†é’Ÿå­¦ä¼š.NET Core Jwt ç­–ç•¥æˆæƒè®¤è¯0.png" alt="å¤åˆ¶ä»£ç " /></a></p>
<pre><code><code>public class PolicyHandler : AuthorizationHandler&lt;PolicyRequirement&gt;
    {
        protected override Task HandleRequirementAsync(AuthorizationHandlerContext context, PolicyRequirement requirement)
        {
            var http = (context.Resource as Microsoft.AspNetCore.Routing.RouteEndpoint);
            var questUrl = &quot;/&quot;+http.RoutePattern.RawText; 
            //èµ‹å€¼ç”¨æˆ·æƒé™
            var userPermissions = requirement.UserPermissions;
            //æ˜¯å¦ç»è¿‡éªŒè¯
            var isAuthenticated = context.User.Identity.IsAuthenticated;
            if (isAuthenticated)
            {
                if (userPermissions.Any(u=&gt;u.Url == questUrl))
                {
                    //ç”¨æˆ·å
                    var userName = context.User.Claims.SingleOrDefault(s =&gt; s.Type == ClaimTypes.NameIdentifier).Value;
                    if (userPermissions.Any(w =&gt; w.UserName == userName))
                    {
                        context.Succeed(requirement);
                    }
                }
            }
            return Task.CompletedTask;
        }
    }</code></pre>
<p><a><img src="./images/[è½¬]ä¸‰åˆ†é’Ÿå­¦ä¼š.NET Core Jwt ç­–ç•¥æˆæƒè®¤è¯0.png" alt="å¤åˆ¶ä»£ç " /></a></p>
<p>ã€€ã€€é¦–å…ˆï¼Œæˆ‘ä»¬é‡å†™äº† HandleRequirementAsync æ–¹æ³•ï¼Œå¦‚æœä½ çœ‹è¿‡AspNetCoreçš„æºç ä½ ä¸€å®šçŸ¥é“ï¼Œå®ƒæ˜¯Jwtèº«ä»½è®¤è¯çš„å¼€ç«¯ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ é‡å†™äº†å®ƒï¼ŒåŸæ¥é‚£ä¸€å¥—å°±ä¸ä¼šèµ°äº†ï¼Œæˆ‘ä»¬è§‚å¯Ÿä¸€ä¸‹æºç ï¼Œæˆ‘è´´åœ¨ä¸‹é¢ï¼Œå¯ä»¥çœ‹åˆ°è¿™å°±æ˜¯ä¸€ä¸ªæœ€åŸºæœ¬çš„æˆæƒï¼Œé€šè¿‡ context.Succeed(requirement å®Œæˆäº†æœ€åçš„è®¤è¯åŠ¨ä½œï¼</p>
<p><a><img src="./images/[è½¬]ä¸‰åˆ†é’Ÿå­¦ä¼š.NET Core Jwt ç­–ç•¥æˆæƒè®¤è¯0.png" alt="å¤åˆ¶ä»£ç " /></a></p>
<pre><code><code>public class DenyAnonymousAuthorizationRequirement : AuthorizationHandler&lt;DenyAnonymousAuthorizationRequirement&gt;, IAuthorizationRequirement
    {
        /// &lt;summary&gt;
        /// Makes a decision if authorization is allowed based on a specific requirement.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;context&quot;&gt;The authorization context.&lt;/param&gt;
        /// &lt;param name=&quot;requirement&quot;&gt;The requirement to evaluate.&lt;/param&gt;
        protected override Task HandleRequirementAsync(AuthorizationHandlerContext context, DenyAnonymousAuthorizationRequirement requirement)
        {
            var user = context.User;
            var userIsAnonymous =
                user?.Identity == null ||
                !user.Identities.Any(i =&gt; i.IsAuthenticated);
            if (!userIsAnonymous)
            {
                context.Succeed(requirement);
            }
            return Task.CompletedTask;
        }
    }</code></pre>
<p><a><img src="./images/[è½¬]ä¸‰åˆ†é’Ÿå­¦ä¼š.NET Core Jwt ç­–ç•¥æˆæƒè®¤è¯0.png" alt="å¤åˆ¶ä»£ç " /></a></p>
<p>é‚£ä¹ˆ Succeed æ˜¯ä¸€ä¸ªä»€ä¹ˆå‘¢ï¼Ÿå®ƒæ˜¯ä¸€ä¸ªåœ¨ AuthorizationHandlerContextçš„å®šä¹‰åŠ¨ä½œï¼ŒåŒ…æ‹¬Fail() ï¼Œä¹Ÿæ˜¯å¦‚æ­¤ï¼Œå½“ç„¶å…·ä½“å®ç°æˆ‘ä»¬ä¸åœ¨ç»†è°ˆï¼Œå…¶å†…éƒ¨è¿˜æ˜¯æŒºå¤æ‚çš„ï¼Œä¸è¿‡æˆ‘ä»¬éœ€è¦çš„æ˜¯ DenyAnonymousAuthorizationRequirement è¢«å½“ä½œäº†æŠ½è±¡çš„ä¸€éƒ¨åˆ†ã€‚</p>
<pre><code><code>public abstract class AuthorizationHandler&lt;TRequirement&gt; : IAuthorizationHandler
            where TRequirement : IAuthorizationRequirement
    {}</code></pre>
<p>å¥½å§ï¼Œè¨€å½’æ­£ä¼ ï¼ˆçœ‹æºç æŒºåˆºæ¿€çš„ï¼‰ï¼Œæˆ‘ä»¬åˆšåˆšåœ¨ PolicyHandlerå®ç°äº†è‡ªå®šä¹‰è®¤è¯ç­–ç•¥ï¼Œä¸Šé¢è¿˜è¯´åˆ°äº†ä¸¤ä¸ªæ–¹æ³•ã€‚ç°åœ¨æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­é…ç½®å¹¶å¯åŠ¨å®ƒï¼Œå¹¶ä¸”æˆ‘åœ¨ä»£ç ä¸­ä¹Ÿæ˜¯ç”¨äº†Swaggerç”¨äºåé¢çš„æ¼”ç¤ºã€‚</p>
<p>åœ¨ AddJwtBearerä¸­æˆ‘ä»¬æ·»åŠ äº†jwtéªŒè¯åŒ…æ‹¬äº†éªŒè¯å‚æ•°ä»¥åŠå‡ ä¸ªäº‹ä»¶å¤„ç†ï¼Œè¿™ä¸ªå¾ˆåŸºæœ¬ï¼Œä¸åœ¨è§£é‡Šã€‚ä¸è¿‡åœ¨Swaggerä¸­æ·»åŠ jwtçš„ä¸€äº›åŠŸèƒ½æ˜¯åœ¨ AddSecurityDefinition ä¸­å†™å…¥çš„ã€‚</p>
<p><a><img src="./images/[è½¬]ä¸‰åˆ†é’Ÿå­¦ä¼š.NET Core Jwt ç­–ç•¥æˆæƒè®¤è¯0.png" alt="å¤åˆ¶ä»£ç " /></a></p>
<pre><code><code>public void ConfigureServices(IServiceCollection services)
        {
            //æ·»åŠ ç­–ç•¥é‰´æƒæ¨¡å¼
            services.AddAuthorization(options =&gt;
            {
                options.AddPolicy(&quot;Permission&quot;, policy =&gt; policy.Requirements.Add(new PolicyRequirement()));
            })
            .AddAuthentication(s =&gt;
            {
                //æ·»åŠ JWT Scheme
                s.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
                s.DefaultScheme = JwtBearerDefaults.AuthenticationScheme;
                s.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
            })
            //æ·»åŠ jwtéªŒè¯ï¼š
            .AddJwtBearer(options =&gt;
            {
                options.TokenValidationParameters = new TokenValidationParameters
                {
                    ValidateLifetime = true,//æ˜¯å¦éªŒè¯å¤±æ•ˆæ—¶é—´
                    ClockSkew = TimeSpan.FromSeconds(30),

                    ValidateAudience = true,//æ˜¯å¦éªŒè¯Audience
                    //ValidAudience = Const.GetValidudience(),//Audience
                    //è¿™é‡Œé‡‡ç”¨åŠ¨æ€éªŒè¯çš„æ–¹å¼ï¼Œåœ¨é‡æ–°ç™»é™†æ—¶ï¼Œåˆ·æ–°tokenï¼Œæ—§tokenå°±å¼ºåˆ¶å¤±æ•ˆäº†
                    AudienceValidator = (m, n, z) =&gt;
                    {
                        return m != null &amp;&amp; m.FirstOrDefault().Equals(Const.ValidAudience);
                    },
                    ValidateIssuer = true,//æ˜¯å¦éªŒè¯Issuer
                    ValidIssuer = Const.Domain,//Issuerï¼Œè¿™ä¸¤é¡¹å’Œå‰é¢ç­¾å‘jwtçš„è®¾ç½®ä¸€è‡´

                    ValidateIssuerSigningKey = true,//æ˜¯å¦éªŒè¯SecurityKey
                    IssuerSigningKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(Const.SecurityKey))//æ‹¿åˆ°SecurityKey
                };
                options.Events = new JwtBearerEvents
                {
                    OnAuthenticationFailed = context =&gt;
                    {
                        //Token expired
                        if (context.Exception.GetType() == typeof(SecurityTokenExpiredException))
                        {
                            context.Response.Headers.Add(&quot;Token-Expired&quot;, &quot;true&quot;);
                        }
                        return Task.CompletedTask;
                    }
                };
            }); 
            services.AddSwaggerGen(c =&gt;
            {
                c.SwaggerDoc(&quot;v1&quot;, new OpenApiInfo
                {
                    Version = &quot;v1&quot;,
                    Title = &quot;HaoZi JWT&quot;,
                    Description = &quot;åŸºäº.NET Core 3.0 çš„JWT èº«ä»½éªŒè¯&quot;,
                    Contact = new OpenApiContact
                    {
                        Name = &quot;zaranet&quot;,
                        Email = &quot;zaranet@163.com&quot;,
                        Url = new Uri(&quot;http://cnblogs.com/zaranet&quot;),
                    },
                });
                c.AddSecurityDefinition(&quot;Bearer&quot;, new OpenApiSecurityScheme()
                {
                    Description = &quot;åœ¨ä¸‹æ¡†ä¸­è¾“å…¥è¯·æ±‚å¤´ä¸­éœ€è¦æ·»åŠ JwtæˆæƒTokenï¼šBearer Token&quot;,
                    Name = &quot;Authorization&quot;,
                    In = ParameterLocation.Header,
                    Type = SecuritySchemeType.ApiKey,
                    BearerFormat = &quot;JWT&quot;,
                    Scheme = &quot;Bearer&quot;
                });
                c.AddSecurityRequirement(new OpenApiSecurityRequirement
                {
                    {
                        new OpenApiSecurityScheme
                        {
                            Reference = new OpenApiReference {
                                Type = ReferenceType.SecurityScheme,
                                Id = &quot;Bearer&quot;
                            }
                        },
                        new string[] { }
                    }
                });
            });
            //è®¤è¯æœåŠ¡
            services.AddSingleton&lt;IAuthorizationHandler, PolicyHandler&gt;();
            services.AddControllers();
        }</code></pre>
<p><a><img src="./images/[è½¬]ä¸‰åˆ†é’Ÿå­¦ä¼š.NET Core Jwt ç­–ç•¥æˆæƒè®¤è¯0.png" alt="å¤åˆ¶ä»£ç " /></a></p>
<p>åœ¨ä»¥ä¸Šä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡é‰´æƒæ¨¡å¼æ·»åŠ äº†è®¤è¯è§„åˆ™ï¼Œä¸€ä¸ªåå« PolicyRequirement çš„ç±»ï¼Œå®ƒå®ç°äº† IAuthorizationRequirement æ¥å£ï¼Œå…¶ä¸­æˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€äº›è§„åˆ™ï¼Œé€šè¿‡æ„é€ å‡½æ•°æˆ‘ä»¬å¯ä»¥æ·»åŠ æˆ‘ä»¬è¦è¯†åˆ«çš„æƒé™è§„åˆ™ã€‚é‚£ä¸ªUserNameå°±æ˜¯ Attribute ã€‚</p>
<p><a><img src="./images/[è½¬]ä¸‰åˆ†é’Ÿå­¦ä¼š.NET Core Jwt ç­–ç•¥æˆæƒè®¤è¯0.png" alt="å¤åˆ¶ä»£ç " /></a></p>
<pre><code><code>public class PolicyRequirement : IAuthorizationRequirement
    {/// &lt;summary&gt;
     /// User rights collection
     /// &lt;/summary&gt;
        public List&lt;UserPermission&gt; UserPermissions { get; private set; }
        /// &lt;summary&gt;
        /// No permission action
        /// &lt;/summary&gt;
        public string DeniedAction { get; set; }
        /// &lt;summary&gt;
        /// structure
        /// &lt;/summary&gt;
        public PolicyRequirement()
        {
            //Jump to this route without permission
            DeniedAction = new PathString(&quot;/api/nopermission&quot;);
            //Route configuration that users have access to, of course you can read it from the database, you can also put it in Redis for persistence
            UserPermissions = new List&lt;UserPermission&gt; {
                              new UserPermission {  Url=&quot;/api/value3&quot;, UserName=&quot;admin&quot;},
                          };
        }
    }
    public class UserPermission
    {
        public string UserName { get; set; }
        public string Url { get; set; }
    }</code></pre>
<p><a><img src="./images/[è½¬]ä¸‰åˆ†é’Ÿå­¦ä¼š.NET Core Jwt ç­–ç•¥æˆæƒè®¤è¯0.png" alt="å¤åˆ¶ä»£ç " /></a></p>
<p>éšåæˆ‘ä»¬åº”å½“å¯åŠ¨æˆ‘ä»¬çš„æœåŠ¡ï¼Œåœ¨.NET Core 3.0 ä¸­èº«ä»½éªŒè¯çš„ä¸­é—´ä»¶ä½ç½®éœ€è¦åœ¨è·¯ç”±å’Œç«¯ç‚¹é…ç½®çš„ä¸­é—´ã€‚</p>
<p><a><img src="./images/[è½¬]ä¸‰åˆ†é’Ÿå­¦ä¼š.NET Core Jwt ç­–ç•¥æˆæƒè®¤è¯0.png" alt="å¤åˆ¶ä»£ç " /></a></p>
<pre><code><code>public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
        {
            if (env.IsDevelopment())
            {
                app.UseDeveloperExceptionPage();
            }
            app.UseSwagger();
            app.UseSwaggerUI(c =&gt;
            {
                c.SwaggerEndpoint(&quot;/swagger/v1/swagger.json&quot;, &quot;My API V1&quot;);
            });
            app.UseRouting();
            app.UseAuthentication();
            app.UseAuthorization();
            app.UseEndpoints(endpoints =&gt;
            {
                endpoints.MapControllers();
            });
        }</code></pre>
<p><a><img src="./images/[è½¬]ä¸‰åˆ†é’Ÿå­¦ä¼š.NET Core Jwt ç­–ç•¥æˆæƒè®¤è¯0.png" alt="å¤åˆ¶ä»£ç " /></a></p>
<p>ã€€ã€€æˆ‘ä»¬é€šå¸¸ä¼šæœ‰ä¸€ä¸ªè·å–tokençš„APIï¼Œç”¨äºè®©Jwté€šè¿‡ JwtSecurityTokenHandler().WriteToken(token) ç”¨äºç”Ÿæˆæˆ‘ä»¬çš„tokenï¼Œè™½ç„¶jwtæ˜¯æ²¡æœ‰çŠ¶æ€çš„ï¼Œä½†ä½ åº”è¯¥ä¹Ÿæ˜ç™½ï¼Œå¦‚æœä½ çš„jwtç”Ÿæˆäº†éšåä½ é‡å¯äº†ä½ çš„ç½‘ç«™ï¼Œä½ çš„jwtä¼šå¤±æ•ˆï¼Œè¿™ä¸ªæ˜¯å› ä¸ºä½ çš„å¯†é’¥è¿›è¡Œäº†æ”¹å˜ï¼Œå¦‚æœä½ çš„å¯†é’¥ä¸€ç›´å†™æ­»ï¼Œé‚£ä¹ˆè¿™ä¸ªjwtå°†ä¸ä¼šå†è¿‡æœŸï¼Œè¿™ä¸ªè¿˜æ˜¯æœ‰å®‰å…¨é£é™©çš„ï¼Œè¿™ä¸ªæˆ‘ä¸åœ¨è¿™é‡Œè§£é‡Šï¼Œgettokenå®šä¹‰å¦‚ä¸‹ï¼š</p>
<p><a><img src="./images/[è½¬]ä¸‰åˆ†é’Ÿå­¦ä¼š.NET Core Jwt ç­–ç•¥æˆæƒè®¤è¯0.png" alt="å¤åˆ¶ä»£ç " /></a></p>
<pre><code><code>ã€€ã€€[ApiController]
    public class AuthController : ControllerBase
    {
        [AllowAnonymous]
        [HttpGet]
        [Route(&quot;api/nopermission&quot;)]
        public IActionResult NoPermission()
        {
            return Forbid(&quot;No Permission!&quot;);
        }
        /// &lt;summary&gt;
        /// login
        /// &lt;/summary&gt;
        [AllowAnonymous]
        [HttpGet]
        [Route(&quot;api/auth&quot;)]
        public IActionResult Get(string userName, string pwd)
        {
            if (CheckAccount(userName, pwd, out string role))
            {
                Const.ValidAudience = userName + pwd + DateTime.Now.ToString();
                // push the userâ€™s name into a claim, so we can identify the user later on.
                //è¿™é‡Œå¯ä»¥éšæ„åŠ å…¥è‡ªå®šä¹‰çš„å‚æ•°ï¼Œkeyå¯ä»¥è‡ªå·±éšä¾¿èµ·
                var claims = new[]
                {
                    new Claim(JwtRegisteredClaimNames.Nbf,$&quot;{new DateTimeOffset(DateTime.Now).ToUnixTimeSeconds()}&quot;) ,
                    new Claim (JwtRegisteredClaimNames.Exp,$&quot;{new DateTimeOffset(DateTime.Now.AddMinutes(30)).ToUnixTimeSeconds()}&quot;),
                    new Claim(ClaimTypes.NameIdentifier, userName),
                    new Claim(&quot;Role&quot;, role)
                };
                //sign the token using a secret key.This secret will be shared between your API and anything that needs to check that the token is legit.
                var key = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(Const.SecurityKey));
                var creds = new SigningCredentials(key, SecurityAlgorithms.HmacSha256);
                //.NET Coreâ€™s JwtSecurityToken class takes on the heavy lifting and actually creates the token.
                var token = new JwtSecurityToken(
                    issuer: Const.Domain, //é¢å‘è€…
                    audience: Const.ValidAudience,//è¿‡æœŸæ—¶é—´
                    expires: DateTime.Now.AddMinutes(30),// ç­¾åè¯ä¹¦
                    signingCredentials: creds, //è‡ªå®šä¹‰å‚æ•°
                    claims: claims );
                return Ok(new
                {
                    token = new JwtSecurityTokenHandler().WriteToken(token)
                });
            }
            else
            {
                return BadRequest(new { message = &quot;username or password is incorrect.&quot; });
            }
        }
        /// &lt;summary&gt;
        /// æ¨¡æ‹Ÿç™»é™†æ ¡éªŒ
        /// &lt;/summary&gt;
        private bool CheckAccount(string userName, string pwd, out string role)
        {
            role = &quot;user&quot;;
            if (string.IsNullOrEmpty(userName))
                return false;
            if (userName.Equals(&quot;admin&quot;))
                role = &quot;admin&quot;;
            return true;
        }</code></pre>
<p><a><img src="./images/[è½¬]ä¸‰åˆ†é’Ÿå­¦ä¼š.NET Core Jwt ç­–ç•¥æˆæƒè®¤è¯0.png" alt="å¤åˆ¶ä»£ç " /></a></p>
<p>ã€€ã€€å¯èƒ½æ¯”è¾ƒç‰¹åˆ«çš„æ˜¯ AllowAnonymous ï¼Œè¿™ä¸ªçœ‹æˆ‘æ–‡ç« çš„åŒå­¦å¯èƒ½å¤´ä¸€æ¬¡è§ï¼Œå…¶å®æ€ä¹ˆè¯´å¥½å‘¢ï¼Œè¿™ä¸ªå¯æ— å¯æœ‰ï¼Œæ²¡æœ‰ç¡¬æ€§çš„è¦æ±‚ï¼Œæˆ‘çœ‹åˆ°å¥½å‡ ä¸ªçŸ¥ååšä¸»åŠ ä¸Šäº†ï¼Œæˆ‘ä¹ŸåŠ ä¸Šäº†~...æœ€åæˆ‘ä»¬åˆ›å»ºäº†å‡ ä¸ªèµ„æºæ§åˆ¶å™¨ï¼Œå®ƒä»¬æ˜¯å—ä¿æŠ¤çš„ã€‚</p>
<p>ã€€ã€€åœ¨ä½ æ·»åŠ ç­–ç•¥æƒé™çš„æ—¶å€™ä¾‹å¦‚æ”¿ç­–åç§°æ˜¯XXXï¼Œé‚£ä¹ˆåœ¨å¯¹åº”çš„apiè¡¨å¤´å°±åº”è¯¥æ˜¯XXXï¼Œéšååˆ°äº† PolicyHandleræˆ‘ä»¬è§£æäº† Claims å¤„ç†äº†å®ƒæ˜¯å¦æœ‰æƒé™ã€‚</p>
<p><a><img src="./images/[è½¬]ä¸‰åˆ†é’Ÿå­¦ä¼š.NET Core Jwt ç­–ç•¥æˆæƒè®¤è¯0.png" alt="å¤åˆ¶ä»£ç " /></a></p>
<pre><code><code>// GET api/values1
        [HttpGet]
        [Route(&quot;api/value1&quot;)]
        public ActionResult&lt;IEnumerable&lt;string&gt;&gt; Get()
        {
            return new string[] { &quot;value1&quot;, &quot;value1&quot; };
        }
        // GET api/values2
        /**
         * è¯¥æ¥å£ç”¨Authorizeç‰¹æ€§åšäº†æƒé™æ ¡éªŒï¼Œå¦‚æœæ²¡æœ‰é€šè¿‡æƒé™æ ¡éªŒï¼Œåˆ™httpè¿”å›çŠ¶æ€ç ä¸º401
         */
        [HttpGet]
        [Route(&quot;api/value2&quot;)]
        [Authorize]
        public ActionResult&lt;IEnumerable&lt;string&gt;&gt; Get2()
        {
            var auth = HttpContext.AuthenticateAsync().Result.Principal.Claims;
            var userName = auth.FirstOrDefault(t =&gt; t.Type.Equals(ClaimTypes.NameIdentifier))?.Value;
            return new string[] { &quot;è¿™ä¸ªæ¥å£ç™»é™†è¿‡çš„éƒ½èƒ½è®¿é—®&quot;, $&quot;userName={userName}&quot; };
        }
        /**
         * è¿™ä¸ªæ¥å£å¿…é¡»ç”¨admin
         **/
        [HttpGet]
        [Route(&quot;api/value3&quot;)]
        [Authorize(&quot;Permission&quot;)]
        public ActionResult&lt;IEnumerable&lt;string&gt;&gt; Get3()
        {
            //è¿™æ˜¯è·å–è‡ªå®šä¹‰å‚æ•°çš„æ–¹æ³•
            var auth = HttpContext.AuthenticateAsync().Result.Principal.Claims;
            var userName = auth.FirstOrDefault(t =&gt; t.Type.Equals(ClaimTypes.NameIdentifier))?.Value;
            var role = auth.FirstOrDefault(t =&gt; t.Type.Equals(&quot;Role&quot;))?.Value;
            return new string[] { &quot;è¿™ä¸ªæ¥å£æœ‰ç®¡ç†å‘˜æƒé™æ‰å¯ä»¥è®¿é—®&quot;, $&quot;userName={userName}&quot;, $&quot;Role={role}&quot; };
        }</code></pre>
<p><a><img src="./images/[è½¬]ä¸‰åˆ†é’Ÿå­¦ä¼š.NET Core Jwt ç­–ç•¥æˆæƒè®¤è¯0.png" alt="å¤åˆ¶ä»£ç " /></a></p>
<h2 id="ä¸‰.æ•ˆæœå›¾">ä¸‰.æ•ˆæœå›¾<a href="https://www.cnblogs.com/ZaraNet/p/12105688.html#3479847093">#</a></h2>
<p><a href="./images/[è½¬]ä¸‰åˆ†é’Ÿå­¦ä¼š.NET Core Jwt ç­–ç•¥æˆæƒè®¤è¯14.png"><img src="./images/[è½¬]ä¸‰åˆ†é’Ÿå­¦ä¼š.NET Core Jwt ç­–ç•¥æˆæƒè®¤è¯14.png" alt="img" /></a></p>
<h2 id="å››.æ —å­æºä»£ç å’Œä»¥å¾€ç‰ˆæœ¬">å››.æ —å­æºä»£ç å’Œä»¥å¾€ç‰ˆæœ¬<a href="https://www.cnblogs.com/ZaraNet/p/12105688.html#938770907">#</a></h2>
<p>ã€€ã€€çœ‹åˆ°å¾ˆå¤šå‰è¾ˆå½©çš„å‘ï¼ŒåŸæ¥çš„ (context.Resource as Microsoft.AspNetCore.Routing.RouteEndpoint); å®é™…ä¸Šåœ¨.NET Core 3.0 å·²ç»ä¸èƒ½ç”¨äº†ï¼ŒåŸå› æ˜¯.NET Core 3.0 å¯ç”¨ EndpointRouting åï¼Œæƒé™filterä¸å†æ·»åŠ åˆ° ActionDescriptor ï¼Œè€Œå°†æƒé™ç›´æ¥ä½œä¸ºä¸­é—´ä»¶è¿è¡Œï¼ŒåŒæ—¶æ‰€æœ‰filteréƒ½ä¼šæ·»åŠ åˆ° endpoint.Metadata ï¼Œå¦‚æœåœ¨.NET Core 2.1 &amp; 2.2 ç‰ˆæœ¬ä¸­ä½ é€šå¸¸Handlerå¯ä»¥è¿™ä¹ˆå†™ï¼š</p>
<p><a><img src="./images/[è½¬]ä¸‰åˆ†é’Ÿå­¦ä¼š.NET Core Jwt ç­–ç•¥æˆæƒè®¤è¯0.png" alt="å¤åˆ¶ä»£ç " /></a></p>
<pre><code><code>public class PolicyHandler : AuthorizationHandler&lt;PolicyRequirement&gt;
    {
        protected override Task HandleRequirementAsync(AuthorizationHandlerContext context, PolicyRequirement requirement)
        {
            //èµ‹å€¼ç”¨æˆ·æƒé™
            var userPermissions = requirement.UserPermissions;
            //ä»AuthorizationHandlerContextè½¬æˆHttpContextï¼Œä»¥ä¾¿å–å‡ºè¡¨æ±‚ä¿¡æ¯
            var httpContext = (context.Resource as Microsoft.AspNetCore.Mvc.Filters.AuthorizationFilterContext).HttpContext;
            //è¯·æ±‚Url
            var questUrl = httpContext.Request.Path.Value.ToUpperInvariant();
            //æ˜¯å¦ç»è¿‡éªŒè¯
            var isAuthenticated = httpContext.User.Identity.IsAuthenticated;
            if (isAuthenticated)
            {
                if (userPermissions.GroupBy(g =&gt; g.Url).Any(w =&gt; w.Key.ToUpperInvariant() == questUrl))
                {
                    //ç”¨æˆ·å
                    var userName = httpContext.User.Claims.SingleOrDefault(s =&gt; s.Type == ClaimTypes.NameIdentifier).Value;
                    if (userPermissions.Any(w =&gt; w.UserName == userName &amp;&amp; w.Url.ToUpperInvariant() == questUrl))
                    {
                        context.Succeed(requirement);
                    }
                    else
                    {
                        //æ— æƒé™è·³è½¬åˆ°æ‹’ç»é¡µé¢
                        httpContext.Response.Redirect(requirement.DeniedAction);
                    }
                }
                else
                    context.Succeed(requirement);
            }
            return Task.CompletedTask;
        }
    }</code></pre>
<p><a><img src="./images/[è½¬]ä¸‰åˆ†é’Ÿå­¦ä¼š.NET Core Jwt ç­–ç•¥æˆæƒè®¤è¯0.png" alt="å¤åˆ¶ä»£ç " /></a></p>
<p>ã€€ã€€è¯¥æ¡ˆä¾‹æºä»£ç åœ¨æˆ‘çš„Githubä¸Šï¼šhttps://github.com/zaranetCore/aspNetCore_JsonwebToken/tree/master/Jwt_Policy_Demo è°¢è°¢å¤§å®¶ğŸ˜„ğŸ˜„ğŸ˜„~~ï¼ï¼ï¼</p>

</div>
</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>