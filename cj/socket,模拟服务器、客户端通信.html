<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修socket,模拟服务器、客户端通信' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>socket,模拟服务器、客户端通信</center></div><div class='banquan'>原文出处:本文由博客园博主张行行提供。<br/>
原文连接:https://www.cnblogs.com/Little-Sky/p/10739246.html</div><br>
    <p><img src="./images/socket,模拟服务器、客户端通信0.png" alt="" /></p>
<p>服务器代码：</p>
<p>using System;<br />using System.Collections.Generic;<br />using System.ComponentModel;<br />using System.Data;<br />using System.Drawing;<br />using System.IO;<br />using System.Linq;<br />using System.Net;<br />using System.Net.Sockets;<br />using System.Text;<br />using System.Threading;<br />using System.Threading.Tasks;<br />using System.Windows.Forms;</p>
<p>namespace Missuin<br />{<br />    public partial class Form2 : Form<br />    {<br />        public Form2()<br />        {<br />            InitializeComponent();<br />        }</p>
<p>        private void button1_Click(object sender, EventArgs e)<br />        {<br />            //当点击开始监听的时候 在服务器端创建一个负责监IP地址和端口号的Socket<br />            Socket socket = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.IP);<br />            IPAddress ip = IPAddress.Any;//IPAddress.Parse(txtServer.Text);<br />            //创建端口号对象<br />            IPEndPoint point = new IPEndPoint(ip, Convert.ToInt32(txtPort.Text));<br />            //监听<br />            socket.Bind(point);<br />            ShowMsg("监听成功");<br />            socket.Listen(10);</p>
<p>            Thread th = new Thread(Listen);<br />            th.IsBackground = true;<br />            th.Start(socket);<br />        }</p>
<p><br />        Socket socketSend;<br />        /// &lt;summary&gt;<br />        /// 被线程所执行的函数，只能传object参数<br />        /// &lt;/summary&gt;<br />        /// &lt;param name="o"&gt;&lt;/param&gt;<br />        void Listen(Object o)<br />        {<br />            Socket socketWatch = o as Socket;<br />            //等待客户端连接 并创建一个负责通信的Sokcet<br />            while (true)<br />            {<br />                //负责根客户通信的Socket<br />                socketSend = socketWatch.Accept();<br />                dictSocket.Add(socketSend.RemoteEndPoint.ToString(), socketSend);</p>
<p>                cbuUsers.Items.Add(socketSend.RemoteEndPoint.ToString());<br />                ShowMsg(socketSend.RemoteEndPoint.ToString() + ":" + "连接成功");<br />                ////客户端连接成功后，服务器应该接受客户端发来的消息<br />                //byte[] buffer = new byte[1024 * 1024 * 2];<br />                ////实际接受到的有效字节数<br />                //int r = socketSend.Receive(buffer);<br />                //string str = Encoding.UTF8.GetString(buffer, 0, r);<br />                //Console.WriteLine(socketSend.RemoteEndPoint+":"+str);<br />                Thread th = new Thread(Recive);<br />                th.IsBackground = true;<br />                th.Start(socketSend);<br />            }<br />        }</p>
<p>        Dictionary&lt;String, Socket&gt; dictSocket = new Dictionary&lt;string, Socket&gt;();<br />        /// &lt;summary&gt;<br />        /// 服务器端不修改的接收客户发来的消息<br />        /// &lt;/summary&gt;<br />        /// &lt;param name="o"&gt;&lt;/param&gt;<br />        void Recive(object o)<br />        {<br />            Socket socketSend = o as Socket;<br />            while (true)<br />            {<br />                try<br />                {<br />                    //客户端连接成功后，服务器应该接受客户端发来的消息<br />                    byte[] buffer = new byte[1024 * 1024 * 2];<br />                    //实际接受到的有效字节数<br />                    int r = socketSend.Receive(buffer);<br />                    if (r == 0)<br />                        break;<br />                    string str = Encoding.UTF8.GetString(buffer, 0, r);<br />                    ShowMsg(socketSend.RemoteEndPoint + ":" + str);<br />                }<br />                catch (Exception ex)<br />                {<br />                    Console.WriteLine(ex.Message);<br />                }<br />            }<br />        }</p>
<p>        void ShowMsg(string msg)<br />        {<br />            txtLog.AppendText(msg + "\r\n");<br />        }</p>
<p>        private void Form2_Load(object sender, EventArgs e)<br />        {<br />            Control.CheckForIllegalCrossThreadCalls = false;<br />        }<br />        /// &lt;summary&gt;<br />        /// 服务器给客户端发消息<br />        /// &lt;/summary&gt;<br />        /// &lt;param name="sender"&gt;&lt;/param&gt;<br />        /// &lt;param name="e"&gt;&lt;/param&gt;<br />        private void button5_Click(object sender, EventArgs e)<br />        {<br />            byte[] msgs = Encoding.UTF8.GetBytes(this.txtmsg.Text);</p>
<p>            List&lt;byte&gt; list = new List&lt;byte&gt;();<br />            list.Add(0);<br />            list.AddRange(msgs);<br />            byte[] newmsgs = list.ToArray();<br />            //获得用户在下拉框中选中的IP地址<br />            string ip = cbuUsers.SelectedItem.ToString();<br />            Socket sendSocket = dictSocket[ip];<br />            sendSocket.Send(newmsgs);<br />            ShowMsg(sendSocket.RemoteEndPoint + ":" + this.txtmsg.Text);</p>
<p>        }<br />        /// &lt;summary&gt;<br />        /// 选择要发送的文件<br />        /// &lt;/summary&gt;<br />        /// &lt;param name="sender"&gt;&lt;/param&gt;<br />        /// &lt;param name="e"&gt;&lt;/param&gt;<br />        private void btnSelect_Click(object sender, EventArgs e)<br />        {<br />            OpenFileDialog of = new OpenFileDialog();<br />            of.InitialDirectory = @"C:\users";<br />            of.Title = "请选择要发送的文件";<br />            of.Filter = "所有文件|*.*";<br />            of.ShowDialog();</p>
<p>            txtPath.Text = of.FileName;</p>
<p>        }</p>
<p>        private void btnFileSend_Click(object sender, EventArgs e)<br />        {<br />            string path = this.txtPath.Text.ToString();<br />            using(FileStream fs = new FileStream(path, FileMode.Open, FileAccess.Read))<br />            {<br />                byte[] buffer = new byte[1024 * 1024 * 5];<br />                List&lt;byte&gt; list = new List&lt;byte&gt;();<br />                list.Add(1);<br />                list.AddRange(list);<br />                byte[] newBytes = list.ToArray();<br />                Socket socket = dictSocket[cbuUsers.SelectedItem.ToString()];<br />                socket.Send(newBytes);<br />            }<br />        }    <br />        private void button3_Click(object sender, EventArgs e)<br />        {<br />            byte[] buffer = new byte[1];<br />            buffer[0] = 2;<br />            Socket socket = dictSocket[cbuUsers.SelectedItem.ToString()];<br />            socket.Send(buffer);<br />        }<br />    }<br />}</p>
<p>客户端代码</p>
<p>using System;<br />using System.Collections.Generic;<br />using System.ComponentModel;<br />using System.Data;<br />using System.Drawing;<br />using System.IO;<br />using System.Linq;<br />using System.Net;<br />using System.Net.Sockets;<br />using System.Text;<br />using System.Threading;<br />using System.Threading.Tasks;<br />using System.Windows.Forms;</p>
<p>namespace Client<br />{<br />    public partial class Form1 : Form<br />    {<br />        public Form1()<br />        {<br />            InitializeComponent();<br />        }<br />        //创建负责通信的Socket<br />        Socket socketSend;<br />        private void button1_Click(object sender, EventArgs e)<br />        {<br />            try<br />            {<br />                socketSend = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);<br />                IPAddress ip = IPAddress.Parse(textBox1.Text);<br />                IPEndPoint point = new IPEndPoint(ip, Convert.ToInt32(textBox2.Text));<br />                socketSend.Connect(point);<br />                showMsg("连接成功");</p>
<p>                //开启一个新线程不停的接收服务器发来的消息<br />                Thread th = new Thread(recive);<br />                th.IsBackground = true;<br />                th.Start();<br />            }<br />            catch(Exception ex)<br />            {</p>
<p>            } <br />        }</p>
<p>        /// &lt;summary&gt;<br />        /// 不停的接收服务器发来的消息<br />        /// &lt;/summary&gt;<br />        void recive()<br />        {<br />            while (true)<br />            { <br />                byte[] buffer = new byte[1024 * 1024 * 2];<br />                int r = socketSend.Receive(buffer);<br />                if (r == 0)<br />                    break;<br />                //发来的是文字<br />                if (buffer[0] == 0)<br />                {<br />                    string s = Encoding.UTF8.GetString(buffer,1,r-1);<br />                    showMsg(socketSend.RemoteEndPoint + ":" + s);<br />                }<br />               else  if (buffer[0] == 1)<br />                {<br />                    SaveFileDialog sfd = new SaveFileDialog();<br />                    sfd.InitialDirectory = @"C:\";<br />                    sfd.Title = "请选择要保存的文件";<br />                    sfd.Filter = "所有文件|*.*";<br />                    sfd.ShowDialog(this);<br />                    string path = sfd.FileName;<br />                    using(FileStream sf = new FileStream(path, FileMode.OpenOrCreate, FileAccess.Write))<br />                    {<br />                        sf.Write(buffer, 1, r - 1);<br />                    }<br />                    MessageBox.Show("保存成功");<br />                } <br />                else if (buffer[0] == 2)<br />                {<br />                    for (int i=0;i&lt;10;i++){<br />                        this.Location = new Point(200, 200);<br />                        this.Location = new Point(210, 210);<br />                    } <br />                }<br />            }<br />        }<br />         </p>
<p>        private void showMsg(string msg)<br />        {<br />            this.txtLog.AppendText(msg + "\r\n");<br />        }</p>
<p>        private void button2_Click(object sender, EventArgs e)<br />        {<br />            byte[] msgs = System.Text.Encoding.UTF8.GetBytes(txtmsg.Text);<br />            socketSend.Send(msgs);<br />        }</p>
<p>        private void Form1_Load(object sender, EventArgs e)<br />        {<br />            Control.CheckForIllegalCrossThreadCalls = false;<br />        }<br />    }<br />}</p>
<p>&nbsp;</p>
</div>
</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>