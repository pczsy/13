<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修C# Moq' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>C# Moq</center></div><div class='banquan'>原文出处:本文由博客园博主刘林栋提供。<br/>
原文连接:https://www.cnblogs.com/lldwolf/p/10947060.html</div><br>
    <p id="title">Moq</p>
<hr />
<h1><a href="file:///C:/workspace/core_service/gxs_core/note/note/Language/CSharp/moq.htm#h1">1 My Cases</a></h1>
<h2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="file:///C:/workspace/core_service/gxs_core/note/note/Language/CSharp/moq.htm#h1-1">1.1 简单入门</a></h2>
<h1><a href="file:///C:/workspace/core_service/gxs_core/note/note/Language/CSharp/moq.htm#h2">2 Reference</a></h1>
<h2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="file:///C:/workspace/core_service/gxs_core/note/note/Language/CSharp/moq.htm#h2-1">2.1 Methods</a></h2>
<h2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="file:///C:/workspace/core_service/gxs_core/note/note/Language/CSharp/moq.htm#h2-2">2.2 Matching Arguments</a></h2>
<h2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="file:///C:/workspace/core_service/gxs_core/note/note/Language/CSharp/moq.htm#h2-3">2.3 Properties</a></h2>
<h2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="file:///C:/workspace/core_service/gxs_core/note/note/Language/CSharp/moq.htm#h2-4">2.4 Events</a></h2>
<h2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="file:///C:/workspace/core_service/gxs_core/note/note/Language/CSharp/moq.htm#h2-5">2.5 Callbacks</a></h2>
<h2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="file:///C:/workspace/core_service/gxs_core/note/note/Language/CSharp/moq.htm#h2-6">2.6 Verification</a></h2>
<h2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="file:///C:/workspace/core_service/gxs_core/note/note/Language/CSharp/moq.htm#h2-7">2.7 Customizing Mock Behavior</a></h2>
<h2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="file:///C:/workspace/core_service/gxs_core/note/note/Language/CSharp/moq.htm#h2-8">2.8 Miscellaneous</a></h2>
<h2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="file:///C:/workspace/core_service/gxs_core/note/note/Language/CSharp/moq.htm#h2-9">2.9 Advanced Features</a></h2>
<h2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="file:///C:/workspace/core_service/gxs_core/note/note/Language/CSharp/moq.htm#h2-10">2.10 LINQ to Mocks</a></h2>
<h1><a href="file:///C:/workspace/core_service/gxs_core/note/note/Language/CSharp/moq.htm#h3">3 FAQ</a></h1>
<h2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="file:///C:/workspace/core_service/gxs_core/note/note/Language/CSharp/moq.htm#h3-1">3.1 static class/method</a></h2>
<hr />
<h1><a id="h1"></a>1 My Cases</h1>
<h2><a id="h1-1"></a>1.1 简单入门</h2>
<pre><code><span class="sh_comment">// 假定我有一个 MyFactory 用来创建 MyInterface 实例
<span class="sh_comment">// 创建 MyFactory 的 Mock 对象
<span class="sh_usertype">var<span class="sh_normal"> mockFactory <span class="sh_symbol">= <span class="sh_keyword">new Mock<span class="sh_symbol">&lt;MyFactory<span class="sh_symbol">&gt;();

<span class="sh_comment">// 创建 MyInterface 的 Mock 实例
<span class="sh_usertype">var<span class="sh_normal"> mockInstance <span class="sh_symbol">= <span class="sh_keyword">new Mock<span class="sh_symbol">&lt;MyInterface<span class="sh_symbol">&gt;();

<span class="sh_comment">// 使用 Moq 实现如果调用 MyInstance.DoSomething(bool) 方法无论传入参数为何值一概抛出 MyException 异常
mockInstance<span class="sh_symbol">.<span class="sh_function">Setup<span class="sh_symbol">(c <span class="sh_symbol">=&gt; c<span class="sh_symbol">.<span class="sh_function">DoSomething<span class="sh_symbol">(It<span class="sh_symbol">.IsAny<span class="sh_symbol">&lt;<span class="sh_type">bool<span class="sh_symbol">&gt;()))
    <span class="sh_symbol">.<span class="sh_function">Throws<span class="sh_symbol">(<span class="sh_keyword">new <span class="sh_function">MyException<span class="sh_symbol">(<span class="sh_string">"my exception message"<span class="sh_symbol">));

<span class="sh_comment">// 使用 Moq 实现 MyFactory 的 Mock 实例第一次调用 CreateInstance(string) 方法时返回 MyInterface 的 Mock 实例
<span class="sh_comment">// 第二次及以后调用则返回真正的 MyInstance 实例
mockFactory<span class="sh_symbol">.<span class="sh_function">SetupSequence<span class="sh_symbol">(f <span class="sh_symbol">=&gt; f<span class="sh_symbol">.<span class="sh_function">CreateInstance<span class="sh_symbol">(It<span class="sh_symbol">.IsAny<span class="sh_symbol">&lt;<span class="sh_type">string<span class="sh_symbol">&gt;()))
    <span class="sh_symbol">.<span class="sh_function">Returns<span class="sh_symbol">(mockInstance<span class="sh_symbol">.Object<span class="sh_symbol">)
    <span class="sh_symbol">.<span class="sh_function">Returns<span class="sh_symbol">(<span class="sh_keyword">new <span class="sh_function">MyInstance<span class="sh_symbol">(<span class="sh_string">"real object"<span class="sh_symbol">));

client<span class="sh_symbol">.Factory <span class="sh_symbol">= mockFactory<span class="sh_symbol">.Object<span class="sh_symbol">;
</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
<h1><a id="h2"></a>2 Reference</h1>
<p>Please refer to&nbsp;<a href="https://github.com/Moq/moq4/wiki/Quickstart">Moq Quickstart</a></p>
<p>Moq is intended to be simple to use, strongly typed (no magic strings!, and therefore full compiler-verified and refactoring-friendly) and minimalistic (while still fully functional!).</p>
<h2><a id="h2-1"></a>2.1 Methods</h2>
<div id="accordion-code-1" class="ui-accordion ui-widget ui-helper-reset ui-accordion-icons">
<p class="ui-accordion-header ui-helper-reset ui-state-default ui-state-active ui-corner-top"><span class="ui-icon ui-icon-triangle-1-s"><a href="file:///C:/workspace/core_service/gxs_core/note/note/Language/CSharp/moq.htm#">Methods Mock</a></span></p>
<pre class="sh_csharp sh_sourceCode ui-accordion-content ui-helper-reset ui-widget-content ui-corner-bottom ui-accordion-content-active"><span class="sh_preproc">using Moq<span class="sh_symbol">;

<span class="sh_comment">// Assumptions:

<span class="sh_keyword">public <span class="sh_keyword">interface IFoo
<span class="sh_cbracket">{
    <span class="sh_usertype">Bar<span class="sh_normal"> Bar <span class="sh_cbracket">{ <span class="sh_keyword">get<span class="sh_symbol">; <span class="sh_keyword">set<span class="sh_symbol">; <span class="sh_cbracket">}
    <span class="sh_type">string Name <span class="sh_cbracket">{ <span class="sh_keyword">get<span class="sh_symbol">; <span class="sh_keyword">set<span class="sh_symbol">; <span class="sh_cbracket">}
    <span class="sh_type">int Value <span class="sh_cbracket">{ <span class="sh_keyword">get<span class="sh_symbol">; <span class="sh_keyword">set<span class="sh_symbol">; <span class="sh_cbracket">}
    <span class="sh_type">bool <span class="sh_function">DoSomething<span class="sh_symbol">(<span class="sh_type">string <span class="sh_keyword">value<span class="sh_symbol">);
    <span class="sh_type">bool <span class="sh_function">DoSomething<span class="sh_symbol">(<span class="sh_type">int number<span class="sh_symbol">, <span class="sh_type">string <span class="sh_keyword">value<span class="sh_symbol">);
    <span class="sh_type">string <span class="sh_function">DoSomethingStringy<span class="sh_symbol">(<span class="sh_type">string <span class="sh_keyword">value<span class="sh_symbol">);
    <span class="sh_type">bool <span class="sh_function">TryParse<span class="sh_symbol">(<span class="sh_type">string <span class="sh_keyword">value<span class="sh_symbol">, <span class="sh_keyword">out <span class="sh_type">string outputValue<span class="sh_symbol">);
    <span class="sh_type">bool <span class="sh_function">Submit<span class="sh_symbol">(<span class="sh_keyword">ref <span class="sh_usertype">Bar<span class="sh_normal"> bar<span class="sh_symbol">);
    <span class="sh_type">int <span class="sh_function">GetCount<span class="sh_symbol">();
    <span class="sh_type">bool <span class="sh_function">Add<span class="sh_symbol">(<span class="sh_type">int <span class="sh_keyword">value<span class="sh_symbol">);
<span class="sh_cbracket">}

<span class="sh_keyword">public <span class="sh_keyword">class<span class="sh_normal"> <span class="sh_classname">Bar 
<span class="sh_cbracket">{
    <span class="sh_keyword">public <span class="sh_keyword">virtual <span class="sh_usertype">Baz<span class="sh_normal"> Baz <span class="sh_cbracket">{ <span class="sh_keyword">get<span class="sh_symbol">; <span class="sh_keyword">set<span class="sh_symbol">; <span class="sh_cbracket">}
    <span class="sh_keyword">public <span class="sh_keyword">virtual <span class="sh_type">bool <span class="sh_function">Submit<span class="sh_symbol">() <span class="sh_cbracket">{ <span class="sh_keyword">return <span class="sh_keyword">false<span class="sh_symbol">; <span class="sh_cbracket">}
<span class="sh_cbracket">}

<span class="sh_keyword">public <span class="sh_keyword">class<span class="sh_normal"> <span class="sh_classname">Baz
<span class="sh_cbracket">{
    <span class="sh_keyword">public <span class="sh_keyword">virtual <span class="sh_type">string Name <span class="sh_cbracket">{ <span class="sh_keyword">get<span class="sh_symbol">; <span class="sh_keyword">set<span class="sh_symbol">; <span class="sh_cbracket">}
<span class="sh_cbracket">}


<span class="sh_usertype">var<span class="sh_normal"> mock <span class="sh_symbol">= <span class="sh_keyword">new Mock<span class="sh_symbol">&lt;IFoo<span class="sh_symbol">&gt;();
mock<span class="sh_symbol">.<span class="sh_function">Setup<span class="sh_symbol">(foo <span class="sh_symbol">=&gt; foo<span class="sh_symbol">.<span class="sh_function">DoSomething<span class="sh_symbol">(<span class="sh_string">"ping"<span class="sh_symbol">)).<span class="sh_function">Returns<span class="sh_symbol">(<span class="sh_keyword">true<span class="sh_symbol">);


<span class="sh_comment">// out arguments
<span class="sh_usertype">var<span class="sh_normal"> outString <span class="sh_symbol">= <span class="sh_string">"ack"<span class="sh_symbol">;
<span class="sh_comment">// TryParse will return true, and the out argument will return "ack", lazy evaluated
mock<span class="sh_symbol">.<span class="sh_function">Setup<span class="sh_symbol">(foo <span class="sh_symbol">=&gt; foo<span class="sh_symbol">.<span class="sh_function">TryParse<span class="sh_symbol">(<span class="sh_string">"ping"<span class="sh_symbol">, <span class="sh_keyword">out outString<span class="sh_symbol">)).<span class="sh_function">Returns<span class="sh_symbol">(<span class="sh_keyword">true<span class="sh_symbol">);


<span class="sh_comment">// ref arguments
<span class="sh_usertype">var<span class="sh_normal"> instance <span class="sh_symbol">= <span class="sh_keyword">new <span class="sh_function">Bar<span class="sh_symbol">();
<span class="sh_comment">// Only matches if the ref argument to the invocation is the same instance
mock<span class="sh_symbol">.<span class="sh_function">Setup<span class="sh_symbol">(foo <span class="sh_symbol">=&gt; foo<span class="sh_symbol">.<span class="sh_function">Submit<span class="sh_symbol">(<span class="sh_keyword">ref instance<span class="sh_symbol">)).<span class="sh_function">Returns<span class="sh_symbol">(<span class="sh_keyword">true<span class="sh_symbol">);


<span class="sh_comment">// access invocation arguments when returning a value
mock<span class="sh_symbol">.<span class="sh_function">Setup<span class="sh_symbol">(x <span class="sh_symbol">=&gt; x<span class="sh_symbol">.<span class="sh_function">DoSomethingStringy<span class="sh_symbol">(It<span class="sh_symbol">.IsAny<span class="sh_symbol">&lt;<span class="sh_type">string<span class="sh_symbol">&gt;()))
		<span class="sh_symbol">.<span class="sh_function">Returns<span class="sh_symbol">((<span class="sh_type">string s<span class="sh_symbol">) <span class="sh_symbol">=&gt; s<span class="sh_symbol">.<span class="sh_function">ToLower<span class="sh_symbol">());
<span class="sh_comment">// Multiple parameters overloads available


<span class="sh_comment">// throwing when invoked with specific parameters
mock<span class="sh_symbol">.<span class="sh_function">Setup<span class="sh_symbol">(foo <span class="sh_symbol">=&gt; foo<span class="sh_symbol">.<span class="sh_function">DoSomething<span class="sh_symbol">(<span class="sh_string">"reset"<span class="sh_symbol">)).Throws<span class="sh_symbol">&lt;InvalidOperationException<span class="sh_symbol">&gt;();
mock<span class="sh_symbol">.<span class="sh_function">Setup<span class="sh_symbol">(foo <span class="sh_symbol">=&gt; foo<span class="sh_symbol">.<span class="sh_function">DoSomething<span class="sh_symbol">(<span class="sh_string">""<span class="sh_symbol">)).<span class="sh_function">Throws<span class="sh_symbol">(<span class="sh_keyword">new <span class="sh_function">ArgumentException<span class="sh_symbol">(<span class="sh_string">"command"<span class="sh_symbol">));


<span class="sh_comment">// lazy evaluating return value
<span class="sh_usertype">var<span class="sh_normal"> count <span class="sh_symbol">= <span class="sh_number">1<span class="sh_symbol">;
mock<span class="sh_symbol">.<span class="sh_function">Setup<span class="sh_symbol">(foo <span class="sh_symbol">=&gt; foo<span class="sh_symbol">.<span class="sh_function">GetCount<span class="sh_symbol">()).<span class="sh_function">Returns<span class="sh_symbol">(() <span class="sh_symbol">=&gt; count<span class="sh_symbol">);


<span class="sh_comment">// returning different values on each invocation
<span class="sh_usertype">var<span class="sh_normal"> mock <span class="sh_symbol">= <span class="sh_keyword">new Mock<span class="sh_symbol">&lt;IFoo<span class="sh_symbol">&gt;();
<span class="sh_usertype">var<span class="sh_normal"> calls <span class="sh_symbol">= <span class="sh_number">0<span class="sh_symbol">;
mock<span class="sh_symbol">.<span class="sh_function">Setup<span class="sh_symbol">(foo <span class="sh_symbol">=&gt; foo<span class="sh_symbol">.<span class="sh_function">GetCount<span class="sh_symbol">())
	<span class="sh_symbol">.<span class="sh_function">Returns<span class="sh_symbol">(() <span class="sh_symbol">=&gt; calls<span class="sh_symbol">)
	<span class="sh_symbol">.<span class="sh_function">Callback<span class="sh_symbol">(() <span class="sh_symbol">=&gt; calls<span class="sh_symbol">++);
<span class="sh_comment">// returns 0 on first invocation, 1 on the next, and so on
Console<span class="sh_symbol">.<span class="sh_function">WriteLine<span class="sh_symbol">(mock<span class="sh_symbol">.Object<span class="sh_symbol">.<span class="sh_function">GetCount<span class="sh_symbol">());
</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
</div>
<h2><a id="h2-2"></a>2.2 Matching Arguments</h2>
<div id="accordion-code-2" class="ui-accordion ui-widget ui-helper-reset ui-accordion-icons">
<p class="ui-accordion-header ui-helper-reset ui-state-default ui-state-active ui-corner-top"><span class="ui-icon ui-icon-triangle-1-s"><a href="file:///C:/workspace/core_service/gxs_core/note/note/Language/CSharp/moq.htm#">Arguments Mock</a></span></p>
<pre class="sh_csharp sh_sourceCode ui-accordion-content ui-helper-reset ui-widget-content ui-corner-bottom ui-accordion-content-active"><span class="sh_comment">// any value
mock<span class="sh_symbol">.<span class="sh_function">Setup<span class="sh_symbol">(foo <span class="sh_symbol">=&gt; foo<span class="sh_symbol">.<span class="sh_function">DoSomething<span class="sh_symbol">(It<span class="sh_symbol">.IsAny<span class="sh_symbol">&lt;<span class="sh_type">string<span class="sh_symbol">&gt;())).<span class="sh_function">Returns<span class="sh_symbol">(<span class="sh_keyword">true<span class="sh_symbol">);


<span class="sh_comment">// any value passed in a `ref` parameter (requires Moq 4.8 or later):
mock<span class="sh_symbol">.<span class="sh_function">Setup<span class="sh_symbol">(foo <span class="sh_symbol">=&gt; foo<span class="sh_symbol">.<span class="sh_function">Submit<span class="sh_symbol">(<span class="sh_keyword">ref It<span class="sh_symbol">.Ref<span class="sh_symbol">&lt;Bar<span class="sh_symbol">&gt;.IsAny<span class="sh_symbol">)).<span class="sh_function">Returns<span class="sh_symbol">(<span class="sh_keyword">true<span class="sh_symbol">);


<span class="sh_comment">// matching Func&lt;int&gt;, lazy evaluated
mock<span class="sh_symbol">.<span class="sh_function">Setup<span class="sh_symbol">(foo <span class="sh_symbol">=&gt; foo<span class="sh_symbol">.<span class="sh_function">Add<span class="sh_symbol">(It<span class="sh_symbol">.<span class="sh_usertype">Is&lt;int&gt;(i =&gt;<span class="sh_normal"> i <span class="sh_symbol">% <span class="sh_number">2 <span class="sh_symbol">== <span class="sh_number">0<span class="sh_symbol">))).<span class="sh_function">Returns<span class="sh_symbol">(<span class="sh_keyword">true<span class="sh_symbol">); 


<span class="sh_comment">// matching ranges
mock<span class="sh_symbol">.<span class="sh_function">Setup<span class="sh_symbol">(foo <span class="sh_symbol">=&gt; foo<span class="sh_symbol">.<span class="sh_function">Add<span class="sh_symbol">(It<span class="sh_symbol">.IsInRange<span class="sh_symbol">&lt;<span class="sh_type">int<span class="sh_symbol">&gt;(<span class="sh_number">0<span class="sh_symbol">, <span class="sh_number">10<span class="sh_symbol">, Range<span class="sh_symbol">.Inclusive<span class="sh_symbol">))).<span class="sh_function">Returns<span class="sh_symbol">(<span class="sh_keyword">true<span class="sh_symbol">); 


<span class="sh_comment">// matching regex
mock<span class="sh_symbol">.<span class="sh_function">Setup<span class="sh_symbol">(x <span class="sh_symbol">=&gt; x<span class="sh_symbol">.<span class="sh_function">DoSomethingStringy<span class="sh_symbol">(It<span class="sh_symbol">.<span class="sh_function">IsRegex<span class="sh_symbol">(<span class="sh_string">"[a-d]+"<span class="sh_symbol">, RegexOptions<span class="sh_symbol">.IgnoreCase<span class="sh_symbol">))).<span class="sh_function">Returns<span class="sh_symbol">(<span class="sh_string">"foo"<span class="sh_symbol">);
</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
</div>
<h2><a id="h2-3"></a>2.3 Properties</h2>
<ul>
<li>
<p>Common</p>
<div id="accordion-code-3" class="ui-accordion ui-widget ui-helper-reset ui-accordion-icons">
<p class="ui-accordion-header ui-helper-reset ui-state-default ui-state-active ui-corner-top"><span class="ui-icon ui-icon-triangle-1-s"><a href="file:///C:/workspace/core_service/gxs_core/note/note/Language/CSharp/moq.htm#">Arguments Mock</a></span></p>
<pre class="sh_csharp sh_sourceCode ui-accordion-content ui-helper-reset ui-widget-content ui-corner-bottom ui-accordion-content-active">mock<span class="sh_symbol">.<span class="sh_function">Setup<span class="sh_symbol">(foo <span class="sh_symbol">=&gt; foo<span class="sh_symbol">.Name<span class="sh_symbol">).<span class="sh_function">Returns<span class="sh_symbol">(<span class="sh_string">"bar"<span class="sh_symbol">);


<span class="sh_comment">// auto-mocking hierarchies (a.k.a. recursive mocks)
mock<span class="sh_symbol">.<span class="sh_function">Setup<span class="sh_symbol">(foo <span class="sh_symbol">=&gt; foo<span class="sh_symbol">.Bar<span class="sh_symbol">.Baz<span class="sh_symbol">.Name<span class="sh_symbol">).<span class="sh_function">Returns<span class="sh_symbol">(<span class="sh_string">"baz"<span class="sh_symbol">);

<span class="sh_comment">// expects an invocation to set the value to "foo"
mock<span class="sh_symbol">.<span class="sh_function">SetupSet<span class="sh_symbol">(foo <span class="sh_symbol">=&gt; foo<span class="sh_symbol">.Name <span class="sh_symbol">= <span class="sh_string">"foo"<span class="sh_symbol">);

<span class="sh_comment">// or verify the setter directly
mock<span class="sh_symbol">.<span class="sh_function">VerifySet<span class="sh_symbol">(foo <span class="sh_symbol">=&gt; foo<span class="sh_symbol">.Name <span class="sh_symbol">= <span class="sh_string">"foo"<span class="sh_symbol">);
</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
</div>
</li>
<li>
<p>Setup a property so that it will automatically start tracking its value (also known as Stub)</p>
<div id="accordion-code-4" class="ui-accordion ui-widget ui-helper-reset ui-accordion-icons">
<p class="ui-accordion-header ui-helper-reset ui-state-default ui-state-active ui-corner-top"><span class="ui-icon ui-icon-triangle-1-s"><a href="file:///C:/workspace/core_service/gxs_core/note/note/Language/CSharp/moq.htm#">Arguments Mock</a></span></p>
<pre class="sh_csharp sh_sourceCode ui-accordion-content ui-helper-reset ui-widget-content ui-corner-bottom ui-accordion-content-active"><span class="sh_comment">// start "tracking" sets/gets to this property
mock<span class="sh_symbol">.<span class="sh_function">SetupProperty<span class="sh_symbol">(f <span class="sh_symbol">=&gt; f<span class="sh_symbol">.Name<span class="sh_symbol">);

<span class="sh_comment">// alternatively, provide a default value for the stubbed property
mock<span class="sh_symbol">.<span class="sh_function">SetupProperty<span class="sh_symbol">(f <span class="sh_symbol">=&gt; f<span class="sh_symbol">.Name<span class="sh_symbol">, <span class="sh_string">"foo"<span class="sh_symbol">);


<span class="sh_comment">// Now you can do:

<span class="sh_usertype">IFoo<span class="sh_normal"> foo <span class="sh_symbol">= mock<span class="sh_symbol">.Object<span class="sh_symbol">;
<span class="sh_comment">// Initial value was stored
Assert<span class="sh_symbol">.<span class="sh_function">Equal<span class="sh_symbol">(<span class="sh_string">"foo"<span class="sh_symbol">, foo<span class="sh_symbol">.Name<span class="sh_symbol">);

<span class="sh_comment">// New value set which changes the initial value
foo<span class="sh_symbol">.Name <span class="sh_symbol">= <span class="sh_string">"bar"<span class="sh_symbol">;
Assert<span class="sh_symbol">.<span class="sh_function">Equal<span class="sh_symbol">(<span class="sh_string">"bar"<span class="sh_symbol">, foo<span class="sh_symbol">.Name<span class="sh_symbol">);
</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
</div>
</li>
<li>
<p>Stub all properties on a mock (not available on Silverlight)</p>
<pre><code>mock<span class="sh_symbol">.<span class="sh_function">SetupAllProperties<span class="sh_symbol">();
</span></span></span></pre>
</li>
</ul>
<h2><a id="h2-4"></a>2.4 Events</h2>
<div id="accordion-code-6" class="ui-accordion ui-widget ui-helper-reset ui-accordion-icons">
<p class="ui-accordion-header ui-helper-reset ui-state-default ui-state-active ui-corner-top"><span class="ui-icon ui-icon-triangle-1-s"><a href="file:///C:/workspace/core_service/gxs_core/note/note/Language/CSharp/moq.htm#">Events Mock</a></span></p>
<pre class="sh_csharp sh_sourceCode ui-accordion-content ui-helper-reset ui-widget-content ui-corner-bottom ui-accordion-content-active"><span class="sh_comment">// Raising an event on the mock
mock<span class="sh_symbol">.<span class="sh_function">Raise<span class="sh_symbol">(m <span class="sh_symbol">=&gt; m<span class="sh_symbol">.FooEvent <span class="sh_symbol">+= <span class="sh_keyword">null<span class="sh_symbol">, <span class="sh_keyword">new <span class="sh_function">FooEventArgs<span class="sh_symbol">(fooValue<span class="sh_symbol">));

<span class="sh_comment">// Raising an event on the mock that has sender in handler parameters
mock<span class="sh_symbol">.<span class="sh_function">Raise<span class="sh_symbol">(m <span class="sh_symbol">=&gt; m<span class="sh_symbol">.FooEvent <span class="sh_symbol">+= <span class="sh_keyword">null<span class="sh_symbol">, <span class="sh_keyword">this<span class="sh_symbol">, <span class="sh_keyword">new <span class="sh_function">FooEventArgs<span class="sh_symbol">(fooValue<span class="sh_symbol">));

<span class="sh_comment">// Raising an event on a descendant down the hierarchy
mock<span class="sh_symbol">.<span class="sh_function">Raise<span class="sh_symbol">(m <span class="sh_symbol">=&gt; m<span class="sh_symbol">.Child<span class="sh_symbol">.First<span class="sh_symbol">.FooEvent <span class="sh_symbol">+= <span class="sh_keyword">null<span class="sh_symbol">, <span class="sh_keyword">new <span class="sh_function">FooEventArgs<span class="sh_symbol">(fooValue<span class="sh_symbol">));

<span class="sh_comment">// Causing an event to raise automatically when Submit is invoked
mock<span class="sh_symbol">.<span class="sh_function">Setup<span class="sh_symbol">(foo <span class="sh_symbol">=&gt; foo<span class="sh_symbol">.<span class="sh_function">Submit<span class="sh_symbol">()).<span class="sh_function">Raises<span class="sh_symbol">(f <span class="sh_symbol">=&gt; f<span class="sh_symbol">.Sent <span class="sh_symbol">+= <span class="sh_keyword">null<span class="sh_symbol">, EventArgs<span class="sh_symbol">.Empty<span class="sh_symbol">);
<span class="sh_comment">// The raised event would trigger behavior on the object under test, which 
<span class="sh_comment">// you would make assertions about later (how its state changed as a consequence, typically)

<span class="sh_comment">// Raising a custom event which does not adhere to the EventHandler pattern
<span class="sh_keyword">public <span class="sh_keyword">delegate <span class="sh_type">void <span class="sh_function">MyEventHandler<span class="sh_symbol">(<span class="sh_type">int i<span class="sh_symbol">, <span class="sh_type">bool b<span class="sh_symbol">);
<span class="sh_keyword">public <span class="sh_keyword">interface IFoo
<span class="sh_cbracket">{
  <span class="sh_keyword">event <span class="sh_usertype">MyEventHandler<span class="sh_normal"> MyEvent<span class="sh_symbol">; 
<span class="sh_cbracket">}

<span class="sh_usertype">var<span class="sh_normal"> mock <span class="sh_symbol">= <span class="sh_keyword">new Mock<span class="sh_symbol">&lt;IFoo<span class="sh_symbol">&gt;();
<span class="sh_symbol">...
<span class="sh_comment">// Raise passing the custom arguments expected by the event delegate
mock<span class="sh_symbol">.<span class="sh_function">Raise<span class="sh_symbol">(foo <span class="sh_symbol">=&gt; foo<span class="sh_symbol">.MyEvent <span class="sh_symbol">+= <span class="sh_keyword">null<span class="sh_symbol">, <span class="sh_number">25<span class="sh_symbol">, <span class="sh_keyword">true<span class="sh_symbol">);
</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
</div>
<h2><a id="h2-5"></a>2.5 Callbacks</h2>
<div id="accordion-code-7" class="ui-accordion ui-widget ui-helper-reset ui-accordion-icons">
<p class="ui-accordion-header ui-helper-reset ui-state-default ui-state-active ui-corner-top"><span class="ui-icon ui-icon-triangle-1-s"><a href="file:///C:/workspace/core_service/gxs_core/note/note/Language/CSharp/moq.htm#">Mock Callback</a></span></p>
<pre class="sh_csharp sh_sourceCode ui-accordion-content ui-helper-reset ui-widget-content ui-corner-bottom ui-accordion-content-active"><span class="sh_usertype">var<span class="sh_normal"> mock <span class="sh_symbol">= <span class="sh_keyword">new Mock<span class="sh_symbol">&lt;IFoo<span class="sh_symbol">&gt;();
<span class="sh_usertype">var<span class="sh_normal"> calls <span class="sh_symbol">= <span class="sh_number">0<span class="sh_symbol">;
<span class="sh_usertype">var<span class="sh_normal"> callArgs <span class="sh_symbol">= <span class="sh_keyword">new List<span class="sh_symbol">&lt;<span class="sh_type">string<span class="sh_symbol">&gt;();

mock<span class="sh_symbol">.<span class="sh_function">Setup<span class="sh_symbol">(foo <span class="sh_symbol">=&gt; foo<span class="sh_symbol">.<span class="sh_function">DoSomething<span class="sh_symbol">(<span class="sh_string">"ping"<span class="sh_symbol">))
    <span class="sh_symbol">.<span class="sh_function">Returns<span class="sh_symbol">(<span class="sh_keyword">true<span class="sh_symbol">)
    <span class="sh_symbol">.<span class="sh_function">Callback<span class="sh_symbol">(() <span class="sh_symbol">=&gt; calls<span class="sh_symbol">++);

<span class="sh_comment">// access invocation arguments
mock<span class="sh_symbol">.<span class="sh_function">Setup<span class="sh_symbol">(foo <span class="sh_symbol">=&gt; foo<span class="sh_symbol">.<span class="sh_function">DoSomething<span class="sh_symbol">(It<span class="sh_symbol">.IsAny<span class="sh_symbol">&lt;<span class="sh_type">string<span class="sh_symbol">&gt;()))
    <span class="sh_symbol">.<span class="sh_function">Returns<span class="sh_symbol">(<span class="sh_keyword">true<span class="sh_symbol">)
    <span class="sh_symbol">.<span class="sh_function">Callback<span class="sh_symbol">((<span class="sh_type">string s<span class="sh_symbol">) <span class="sh_symbol">=&gt; callArgs<span class="sh_symbol">.<span class="sh_function">Add<span class="sh_symbol">(s<span class="sh_symbol">));

<span class="sh_comment">// alternate equivalent generic method syntax
mock<span class="sh_symbol">.<span class="sh_function">Setup<span class="sh_symbol">(foo <span class="sh_symbol">=&gt; foo<span class="sh_symbol">.<span class="sh_function">DoSomething<span class="sh_symbol">(It<span class="sh_symbol">.IsAny<span class="sh_symbol">&lt;<span class="sh_type">string<span class="sh_symbol">&gt;()))
    <span class="sh_symbol">.<span class="sh_function">Returns<span class="sh_symbol">(<span class="sh_keyword">true<span class="sh_symbol">)
    <span class="sh_symbol">.<span class="sh_usertype">Callback&lt;string&gt;(s =&gt;<span class="sh_normal"> callArgs<span class="sh_symbol">.<span class="sh_function">Add<span class="sh_symbol">(s<span class="sh_symbol">));

<span class="sh_comment">// access arguments for methods with multiple parameters
mock<span class="sh_symbol">.<span class="sh_function">Setup<span class="sh_symbol">(foo <span class="sh_symbol">=&gt; foo<span class="sh_symbol">.<span class="sh_function">DoSomething<span class="sh_symbol">(It<span class="sh_symbol">.IsAny<span class="sh_symbol">&lt;<span class="sh_type">int<span class="sh_symbol">&gt;(), It<span class="sh_symbol">.IsAny<span class="sh_symbol">&lt;<span class="sh_type">string<span class="sh_symbol">&gt;()))
    <span class="sh_symbol">.<span class="sh_function">Returns<span class="sh_symbol">(<span class="sh_keyword">true<span class="sh_symbol">)
    <span class="sh_symbol">.<span class="sh_usertype">Callback&lt;int, string&gt;((i, s) =&gt;<span class="sh_normal"> callArgs<span class="sh_symbol">.<span class="sh_function">Add<span class="sh_symbol">(s<span class="sh_symbol">));

<span class="sh_comment">// callbacks can be specified before and after invocation
mock<span class="sh_symbol">.<span class="sh_function">Setup<span class="sh_symbol">(foo <span class="sh_symbol">=&gt; foo<span class="sh_symbol">.<span class="sh_function">DoSomething<span class="sh_symbol">(<span class="sh_string">"ping"<span class="sh_symbol">))
    <span class="sh_symbol">.<span class="sh_function">Callback<span class="sh_symbol">(() <span class="sh_symbol">=&gt; Console<span class="sh_symbol">.<span class="sh_function">WriteLine<span class="sh_symbol">(<span class="sh_string">"Before returns"<span class="sh_symbol">))
    <span class="sh_symbol">.<span class="sh_function">Returns<span class="sh_symbol">(<span class="sh_keyword">true<span class="sh_symbol">)
    <span class="sh_symbol">.<span class="sh_function">Callback<span class="sh_symbol">(() <span class="sh_symbol">=&gt; Console<span class="sh_symbol">.<span class="sh_function">WriteLine<span class="sh_symbol">(<span class="sh_string">"After returns"<span class="sh_symbol">));

<span class="sh_comment">// callbacks for methods with `ref` / `out` parameters are possible but require some work (and Moq 4.8 or later):
<span class="sh_keyword">delegate <span class="sh_type">void <span class="sh_function">SubmitCallback<span class="sh_symbol">(<span class="sh_keyword">ref <span class="sh_usertype">Bar<span class="sh_normal"> bar<span class="sh_symbol">);

mock<span class="sh_symbol">.<span class="sh_function">Setup<span class="sh_symbol">(foo <span class="sh_symbol">=&gt; foo<span class="sh_symbol">.<span class="sh_function">Submit<span class="sh_symbol">(<span class="sh_keyword">ref It<span class="sh_symbol">.Ref<span class="sh_symbol">&lt;Bar<span class="sh_symbol">&gt;.IsAny<span class="sh_symbol">)
    <span class="sh_symbol">.<span class="sh_function">Callback<span class="sh_symbol">(<span class="sh_keyword">new <span class="sh_function">SubmitCallback<span class="sh_symbol">((<span class="sh_keyword">ref <span class="sh_usertype">Bar<span class="sh_normal"> bar<span class="sh_symbol">) <span class="sh_symbol">=&gt; Console<span class="sh_symbol">.<span class="sh_function">WriteLine<span class="sh_symbol">(<span class="sh_string">"Submitting a Bar!"<span class="sh_symbol">));
</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
</div>
<h2><a id="h2-6"></a>2.6 Verification</h2>
<div id="accordion-code-8" class="ui-accordion ui-widget ui-helper-reset ui-accordion-icons">
<p class="ui-accordion-header ui-helper-reset ui-state-default ui-state-active ui-corner-top"><span class="ui-icon ui-icon-triangle-1-s"><a href="file:///C:/workspace/core_service/gxs_core/note/note/Language/CSharp/moq.htm#">Mock Verification</a></span></p>
<pre class="sh_csharp sh_sourceCode ui-accordion-content ui-helper-reset ui-widget-content ui-corner-bottom ui-accordion-content-active">mock<span class="sh_symbol">.<span class="sh_function">Verify<span class="sh_symbol">(foo <span class="sh_symbol">=&gt; foo<span class="sh_symbol">.<span class="sh_function">DoSomething<span class="sh_symbol">(<span class="sh_string">"ping"<span class="sh_symbol">));

<span class="sh_comment">// Verify with custom error message for failure
mock<span class="sh_symbol">.<span class="sh_function">Verify<span class="sh_symbol">(foo <span class="sh_symbol">=&gt; foo<span class="sh_symbol">.<span class="sh_function">DoSomething<span class="sh_symbol">(<span class="sh_string">"ping"<span class="sh_symbol">), <span class="sh_string">"When doing operation X, the service should be pinged always"<span class="sh_symbol">);

<span class="sh_comment">// Method should never be called
mock<span class="sh_symbol">.<span class="sh_function">Verify<span class="sh_symbol">(foo <span class="sh_symbol">=&gt; foo<span class="sh_symbol">.<span class="sh_function">DoSomething<span class="sh_symbol">(<span class="sh_string">"ping"<span class="sh_symbol">), Times<span class="sh_symbol">.<span class="sh_function">Never<span class="sh_symbol">());

<span class="sh_comment">// Called at least once
mock<span class="sh_symbol">.<span class="sh_function">Verify<span class="sh_symbol">(foo <span class="sh_symbol">=&gt; foo<span class="sh_symbol">.<span class="sh_function">DoSomething<span class="sh_symbol">(<span class="sh_string">"ping"<span class="sh_symbol">), Times<span class="sh_symbol">.<span class="sh_function">AtLeastOnce<span class="sh_symbol">());

<span class="sh_comment">// Verify getter invocation, regardless of value.
mock<span class="sh_symbol">.<span class="sh_function">VerifyGet<span class="sh_symbol">(foo <span class="sh_symbol">=&gt; foo<span class="sh_symbol">.Name<span class="sh_symbol">);

<span class="sh_comment">// Verify setter invocation, regardless of value.
mock<span class="sh_symbol">.<span class="sh_function">VerifySet<span class="sh_symbol">(foo <span class="sh_symbol">=&gt; foo<span class="sh_symbol">.Name<span class="sh_symbol">);

<span class="sh_comment">// Verify setter called with specific value
mock<span class="sh_symbol">.<span class="sh_function">VerifySet<span class="sh_symbol">(foo <span class="sh_symbol">=&gt; foo<span class="sh_symbol">.Name <span class="sh_symbol">=<span class="sh_string">"foo"<span class="sh_symbol">);

<span class="sh_comment">// Verify setter with an argument matcher
mock<span class="sh_symbol">.<span class="sh_function">VerifySet<span class="sh_symbol">(foo <span class="sh_symbol">=&gt; foo<span class="sh_symbol">.Value <span class="sh_symbol">= It<span class="sh_symbol">.<span class="sh_function">IsInRange<span class="sh_symbol">(<span class="sh_number">1<span class="sh_symbol">, <span class="sh_number">5<span class="sh_symbol">, Range<span class="sh_symbol">.Inclusive<span class="sh_symbol">));

<span class="sh_comment">// Verify that no other invocations were made other than those already verified (requires Moq 4.8 or later)
mock<span class="sh_symbol">.<span class="sh_function">VerifyNoOtherCalls<span class="sh_symbol">();
</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
</div>
<h2><a id="h2-7"></a>2.7 Customizing Mock Behavior</h2>
<ul>
<li>
<p>Make mock behave like a "true Mock", raising exceptions for anything that doesn't have a corresponding expectation: in Moq slang a "Strict" mock; default behavior is "Loose" mock, which never throws and returns default values or empty arrays, enumerables, etc. if no expectation is set for a member</p>
<pre><code><span class="sh_usertype">var<span class="sh_normal"> mock <span class="sh_symbol">= <span class="sh_keyword">new Mock<span class="sh_symbol">&lt;IFoo<span class="sh_symbol">&gt;(MockBehavior<span class="sh_symbol">.Strict<span class="sh_symbol">);
</span></span></span></span></span></span></span></span></pre>
</li>
<li>
<p>Invoke base class implementation if no expectation overrides the member (a.k.a. "Partial Mocks" in Rhino Mocks): default is false. (this is required if you are mocking Web/Html controls in System.Web!)</p>
<pre><code><span class="sh_usertype">var<span class="sh_normal"> mock <span class="sh_symbol">= <span class="sh_keyword">new Mock<span class="sh_symbol">&lt;IFoo<span class="sh_symbol">&gt; <span class="sh_cbracket">{ CallBase <span class="sh_symbol">= <span class="sh_keyword">true <span class="sh_cbracket">}<span class="sh_symbol">;
</span></span></span></span></span></span></span></span></span></span></span></pre>
</li>
<li>
<p>Make an automatic recursive mock: a mock that will return a new mock for every member that doesn't have an expectation and whose return value can be mocked (i.e. it is not a value type)</p>
<pre><code><span class="sh_usertype">var<span class="sh_normal"> mock <span class="sh_symbol">= <span class="sh_keyword">new Mock<span class="sh_symbol">&lt;IFoo<span class="sh_symbol">&gt; <span class="sh_cbracket">{ DefaultValue <span class="sh_symbol">= DefaultValue<span class="sh_symbol">.Mock <span class="sh_cbracket">}<span class="sh_symbol">;
<span class="sh_comment">// default is DefaultValue.Empty

<span class="sh_comment">// this property access would return a new mock of Bar as it's "mock-able"
<span class="sh_usertype">Bar<span class="sh_normal"> <span class="sh_keyword">value <span class="sh_symbol">= mock<span class="sh_symbol">.Object<span class="sh_symbol">.Bar<span class="sh_symbol">;

<span class="sh_comment">// the returned mock is reused, so further accesses to the property return 
<span class="sh_comment">// the same mock instance. this allows us to also use this instance to 
<span class="sh_comment">// set further expectations on it if we want
<span class="sh_usertype">var<span class="sh_normal"> barMock <span class="sh_symbol">= Mock<span class="sh_symbol">.<span class="sh_function">Get<span class="sh_symbol">(<span class="sh_keyword">value<span class="sh_symbol">);
barMock<span class="sh_symbol">.<span class="sh_function">Setup<span class="sh_symbol">(b <span class="sh_symbol">=&gt; b<span class="sh_symbol">.<span class="sh_function">Submit<span class="sh_symbol">()).<span class="sh_function">Returns<span class="sh_symbol">(<span class="sh_keyword">true<span class="sh_symbol">);
</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
</li>
<li>
<p>Centralizing mock instance creation and management: you can create and verify all mocks in a single place by using a MockRepository, which allows setting the MockBehavior, its CallBase and DefaultValue consistently</p>
<pre><code><span class="sh_usertype">var<span class="sh_normal"> repository <span class="sh_symbol">= <span class="sh_keyword">new <span class="sh_function">MockRepository<span class="sh_symbol">(MockBehavior<span class="sh_symbol">.Strict<span class="sh_symbol">) <span class="sh_cbracket">{ DefaultValue <span class="sh_symbol">= DefaultValue<span class="sh_symbol">.Mock <span class="sh_cbracket">}<span class="sh_symbol">;

<span class="sh_comment">// Create a mock using the repository settings
<span class="sh_usertype">var<span class="sh_normal"> fooMock <span class="sh_symbol">= repository<span class="sh_symbol">.Create<span class="sh_symbol">&lt;IFoo<span class="sh_symbol">&gt;();

<span class="sh_comment">// Create a mock overriding the repository settings
<span class="sh_usertype">var<span class="sh_normal"> barMock <span class="sh_symbol">= repository<span class="sh_symbol">.Create<span class="sh_symbol">&lt;Bar<span class="sh_symbol">&gt;(MockBehavior<span class="sh_symbol">.Loose<span class="sh_symbol">);

<span class="sh_comment">// Verify all verifiable expectations on all mocks created through the repository
repository<span class="sh_symbol">.<span class="sh_function">Verify<span class="sh_symbol">();
</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
</li>
</ul>
<h2><a id="h2-8"></a>2.8 Miscellaneous</h2>
<ul>
<li>
<p>Setting up a member to return different values / throw exceptions on sequential calls:</p>
<pre><code><span class="sh_usertype">var<span class="sh_normal"> mock <span class="sh_symbol">= <span class="sh_keyword">new Mock<span class="sh_symbol">&lt;IFoo<span class="sh_symbol">&gt;();
mock<span class="sh_symbol">.<span class="sh_function">SetupSequence<span class="sh_symbol">(f <span class="sh_symbol">=&gt; f<span class="sh_symbol">.<span class="sh_function">GetCount<span class="sh_symbol">())
    <span class="sh_symbol">.<span class="sh_function">Returns<span class="sh_symbol">(<span class="sh_number">3<span class="sh_symbol">)  <span class="sh_comment">// will be returned on 1st invocation
    <span class="sh_symbol">.<span class="sh_function">Returns<span class="sh_symbol">(<span class="sh_number">2<span class="sh_symbol">)  <span class="sh_comment">// will be returned on 2nd invocation
    <span class="sh_symbol">.<span class="sh_function">Returns<span class="sh_symbol">(<span class="sh_number">1<span class="sh_symbol">)  <span class="sh_comment">// will be returned on 3rd invocation
    <span class="sh_symbol">.<span class="sh_function">Returns<span class="sh_symbol">(<span class="sh_number">0<span class="sh_symbol">)  <span class="sh_comment">// will be returned on 4th invocation
    <span class="sh_symbol">.<span class="sh_function">Throws<span class="sh_symbol">(<span class="sh_keyword">new <span class="sh_function">InvalidOperationException<span class="sh_symbol">());  <span class="sh_comment">// will be thrown on 5th invocation
</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
</li>
<li>
<p>Setting expectations for protected members (you can't get IntelliSense for these, so you access them using the member name as a string):</p>
<pre><code><span class="sh_comment">// at the top of the test fixture
<span class="sh_preproc">using Moq<span class="sh_symbol">.Protected<span class="sh_symbol">;

<span class="sh_comment">// in the test
<span class="sh_usertype">var<span class="sh_normal"> mock <span class="sh_symbol">= <span class="sh_keyword">new Mock<span class="sh_symbol">&lt;CommandBase<span class="sh_symbol">&gt;();
mock<span class="sh_symbol">.<span class="sh_function">Protected<span class="sh_symbol">()
     <span class="sh_symbol">.Setup<span class="sh_symbol">&lt;<span class="sh_type">int<span class="sh_symbol">&gt;(<span class="sh_string">"Execute"<span class="sh_symbol">)
     <span class="sh_symbol">.<span class="sh_function">Returns<span class="sh_symbol">(<span class="sh_number">5<span class="sh_symbol">);

<span class="sh_comment">// if you need argument matching, you MUST use ItExpr rather than It
<span class="sh_comment">// planning on improving this for vNext (see below for an alternative in Moq 4.8)
mock<span class="sh_symbol">.<span class="sh_function">Protected<span class="sh_symbol">()
    <span class="sh_symbol">.Setup<span class="sh_symbol">&lt;<span class="sh_type">bool<span class="sh_symbol">&gt;(<span class="sh_string">"Execute"<span class="sh_symbol">,
        ItExpr<span class="sh_symbol">.IsAny<span class="sh_symbol">&lt;<span class="sh_type">string<span class="sh_symbol">&gt;())
    <span class="sh_symbol">.<span class="sh_function">Returns<span class="sh_symbol">(<span class="sh_keyword">true<span class="sh_symbol">);
</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
</li>
<li>
<p>Moq 4.8 and later allows you to set up protected members through a completely unrelated type that has the same members and thus provides the type information necessary for IntelliSense to work. You can also use this interface to set up protected generic methods and those having by-ref parameters:</p>
<pre><code><span class="sh_keyword">interface CommandBaseProtectedMembers
<span class="sh_cbracket">{
    <span class="sh_type">bool <span class="sh_function">Execute<span class="sh_symbol">(<span class="sh_type">string arg<span class="sh_symbol">);
<span class="sh_cbracket">}

mock<span class="sh_symbol">.<span class="sh_function">Protected<span class="sh_symbol">().As<span class="sh_symbol">&lt;CommandBaseProtectedMembers<span class="sh_symbol">&gt;()
    <span class="sh_symbol">.<span class="sh_function">Setup<span class="sh_symbol">(m <span class="sh_symbol">=&gt; m<span class="sh_symbol">.<span class="sh_function">Execute<span class="sh_symbol">(It<span class="sh_symbol">.IsAny<span class="sh_symbol">&lt;<span class="sh_type">string<span class="sh_symbol">&gt;()))  <span class="sh_comment">// will set up CommandBase.Execute
    <span class="sh_symbol">.<span class="sh_function">Returns<span class="sh_symbol">(<span class="sh_keyword">true<span class="sh_symbol">);
</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
</li>
</ul>
<h2><a id="h2-9"></a>2.9 Advanced Features</h2>
<ul>
<li>
<p>Common</p>
<pre><code><span class="sh_comment">// get mock from a mocked instance
<span class="sh_usertype">IFoo<span class="sh_normal"> foo <span class="sh_symbol">= <span class="sh_comment">// get mock instance somehow
<span class="sh_usertype">var<span class="sh_normal"> fooMock <span class="sh_symbol">= Mock<span class="sh_symbol">.<span class="sh_function">Get<span class="sh_symbol">(foo<span class="sh_symbol">);
fooMock<span class="sh_symbol">.<span class="sh_function">Setup<span class="sh_symbol">(f <span class="sh_symbol">=&gt; f<span class="sh_symbol">.<span class="sh_function">GetCount<span class="sh_symbol">()).<span class="sh_function">Returns<span class="sh_symbol">(<span class="sh_number">42<span class="sh_symbol">);


<span class="sh_comment">// implementing multiple interfaces in mock
<span class="sh_usertype">var<span class="sh_normal"> mock <span class="sh_symbol">= <span class="sh_keyword">new Mock<span class="sh_symbol">&lt;IFoo<span class="sh_symbol">&gt;();
<span class="sh_usertype">var<span class="sh_normal"> disposableFoo <span class="sh_symbol">= mock<span class="sh_symbol">.As<span class="sh_symbol">&lt;IDisposable<span class="sh_symbol">&gt;();
<span class="sh_comment">// now the IFoo mock also implements IDisposable :)
disposableFoo<span class="sh_symbol">.<span class="sh_function">Setup<span class="sh_symbol">(disposable <span class="sh_symbol">=&gt; disposable<span class="sh_symbol">.<span class="sh_function">Dispose<span class="sh_symbol">());

<span class="sh_comment">// implementing multiple interfaces in single mock
<span class="sh_usertype">var<span class="sh_normal"> mock <span class="sh_symbol">= <span class="sh_keyword">new Mock<span class="sh_symbol">&lt;IFoo<span class="sh_symbol">&gt;();
mock<span class="sh_symbol">.<span class="sh_function">Setup<span class="sh_symbol">(foo <span class="sh_symbol">=&gt; foo<span class="sh_symbol">.Name<span class="sh_symbol">).<span class="sh_function">Returns<span class="sh_symbol">(<span class="sh_string">"Fred"<span class="sh_symbol">);
mock<span class="sh_symbol">.<span class="sh_usertype">As&lt;IDisposable&gt;().Setup(disposable =&gt;<span class="sh_normal"> disposable<span class="sh_symbol">.<span class="sh_function">Dispose<span class="sh_symbol">());


<span class="sh_comment">// custom matchers
mock<span class="sh_symbol">.<span class="sh_function">Setup<span class="sh_symbol">(foo <span class="sh_symbol">=&gt; foo<span class="sh_symbol">.<span class="sh_function">DoSomething<span class="sh_symbol">(<span class="sh_function">IsLarge<span class="sh_symbol">())).Throws<span class="sh_symbol">&lt;ArgumentException<span class="sh_symbol">&gt;();
<span class="sh_symbol">...
<span class="sh_keyword">public <span class="sh_type">string <span class="sh_function">IsLarge<span class="sh_symbol">() 
<span class="sh_cbracket">{ 
  <span class="sh_keyword">return Match<span class="sh_symbol">.Create<span class="sh_symbol">&lt;<span class="sh_type">string<span class="sh_symbol">&gt;(s <span class="sh_symbol">=&gt; <span class="sh_symbol">!String<span class="sh_symbol">.<span class="sh_function">IsNullOrEmpty<span class="sh_symbol">(s<span class="sh_symbol">) <span class="sh_symbol">&amp;&amp; s<span class="sh_symbol">.Length <span class="sh_symbol">&gt; <span class="sh_number">100<span class="sh_symbol">);
<span class="sh_cbracket">}
</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
</li>
<li>
<p>Mocking internal types: Add either of the following custom attributes (typically in AssemblyInfo.cs) to the project containing the internal types &mdash; which one you need depends on whether your own project is strong-named or not:</p>
<pre><code><span class="sh_comment">// This assembly is the default dynamic assembly generated by Castle DynamicProxy, 
<span class="sh_comment">// used by Moq. If your assembly is strong-named, paste the following in a single line:
<span class="sh_symbol">[assembly<span class="sh_symbol">:<span class="sh_function">InternalsVisibleTo<span class="sh_symbol">(<span class="sh_string">"DynamicProxyGenAssembly2,PublicKey=00...cc7"<span class="sh_symbol">)]

<span class="sh_comment">// Or, if your own assembly is not strong-named, omit the public key:
<span class="sh_symbol">[assembly<span class="sh_symbol">:<span class="sh_function">InternalsVisibleTo<span class="sh_symbol">(<span class="sh_string">"DynamicProxyGenAssembly2"<span class="sh_symbol">)]
</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
</li>
<li>
<p>Starting in Moq 4.8, you can create your own custom default value generation strategies (besides DefaultValue.Empty and DefaultValue.Mock) by subclassing DefaultValueProvider, or, if you want some more convenience, LookupOrFallbackDefaultValueProvider:</p>
<pre><code><span class="sh_keyword">class<span class="sh_normal"> <span class="sh_classname">MyEmptyDefaultValueProvider <span class="sh_symbol">: LookupOrFallbackDefaultValueProvider
<span class="sh_cbracket">{
    <span class="sh_keyword">public <span class="sh_function">MyEmptyDefaultValueProvider<span class="sh_symbol">()
    <span class="sh_cbracket">{
        <span class="sh_keyword">base<span class="sh_symbol">.<span class="sh_function">Register<span class="sh_symbol">(<span class="sh_keyword">typeof<span class="sh_symbol">(<span class="sh_type">string<span class="sh_symbol">), <span class="sh_symbol">(type<span class="sh_symbol">, mock<span class="sh_symbol">) <span class="sh_symbol">=&gt; <span class="sh_string">"?"<span class="sh_symbol">);
        <span class="sh_keyword">base<span class="sh_symbol">.<span class="sh_function">Register<span class="sh_symbol">(<span class="sh_keyword">typeof<span class="sh_symbol">(<span class="sh_usertype">List&lt;&gt;), (type, mock) =&gt;<span class="sh_normal"> Activator<span class="sh_symbol">.<span class="sh_function">CreateInstance<span class="sh_symbol">(type<span class="sh_symbol">));
    <span class="sh_cbracket">}
<span class="sh_cbracket">}

<span class="sh_usertype">var<span class="sh_normal"> mock <span class="sh_symbol">= <span class="sh_keyword">new Mock<span class="sh_symbol">&lt;IFoo<span class="sh_symbol">&gt; <span class="sh_cbracket">{ DefaultValueProvider <span class="sh_symbol">= <span class="sh_keyword">new <span class="sh_function">MyEmptyDefaultValueProvider<span class="sh_symbol">() <span class="sh_cbracket">}<span class="sh_symbol">;
<span class="sh_usertype">var<span class="sh_normal"> name <span class="sh_symbol">= mock<span class="sh_symbol">.Object<span class="sh_symbol">.Name<span class="sh_symbol">;  <span class="sh_comment">// =&gt; "?"
</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
<div class="ui-widget">
<div class="ui-state-highlight ui-corner-all">
<p><span class="ui-icon ui-icon-info">Note: When you pass the mock for consumption, you must pass mock.Object, not mock itself.</span></p>
</div>
</div>
</li>
</ul>
<h2><a id="h2-10"></a>2.10 LINQ to Mocks</h2>
<p>Moq is the one and only mocking framework that allows specifying mock behavior via declarative specification queries. You can think of LINQ to Mocks as:</p>
<p>Keep that query form in mind when reading the specifications:</p>
<pre><code><span class="sh_usertype">var<span class="sh_normal"> services <span class="sh_symbol">= Mock<span class="sh_symbol">.Of<span class="sh_symbol">&lt;IServiceProvider<span class="sh_symbol">&gt;(sp <span class="sh_symbol">=&gt;
    sp<span class="sh_symbol">.<span class="sh_function">GetService<span class="sh_symbol">(<span class="sh_keyword">typeof<span class="sh_symbol">(IRepository<span class="sh_symbol">)) <span class="sh_symbol">== Mock<span class="sh_symbol">.<span class="sh_usertype">Of&lt;IRepository&gt;(r =&gt;<span class="sh_normal"> r<span class="sh_symbol">.IsAuthenticated <span class="sh_symbol">== <span class="sh_keyword">true<span class="sh_symbol">) <span class="sh_symbol">&amp;&amp;
    sp<span class="sh_symbol">.<span class="sh_function">GetService<span class="sh_symbol">(<span class="sh_keyword">typeof<span class="sh_symbol">(IAuthentication<span class="sh_symbol">)) <span class="sh_symbol">== Mock<span class="sh_symbol">.<span class="sh_usertype">Of&lt;IAuthentication&gt;(a =&gt;<span class="sh_normal"> a<span class="sh_symbol">.AuthenticationType <span class="sh_symbol">== <span class="sh_string">"OAuth"<span class="sh_symbol">));

<span class="sh_comment">// Multiple setups on a single mock and its recursive mocks
<span class="sh_usertype">ControllerContext<span class="sh_normal"> context <span class="sh_symbol">= Mock<span class="sh_symbol">.Of<span class="sh_symbol">&lt;ControllerContext<span class="sh_symbol">&gt;(ctx <span class="sh_symbol">=&gt;
     ctx<span class="sh_symbol">.HttpContext<span class="sh_symbol">.User<span class="sh_symbol">.Identity<span class="sh_symbol">.Name <span class="sh_symbol">== <span class="sh_string">"kzu" <span class="sh_symbol">&amp;&amp;
     ctx<span class="sh_symbol">.HttpContext<span class="sh_symbol">.Request<span class="sh_symbol">.IsAuthenticated <span class="sh_symbol">== <span class="sh_keyword">true <span class="sh_symbol">&amp;&amp;
     ctx<span class="sh_symbol">.HttpContext<span class="sh_symbol">.Request<span class="sh_symbol">.Url <span class="sh_symbol">== <span class="sh_keyword">new <span class="sh_function">Uri<span class="sh_symbol">(<span class="sh_string">"http://moqthis.com"<span class="sh_symbol">) <span class="sh_symbol">&amp;&amp;
     ctx<span class="sh_symbol">.HttpContext<span class="sh_symbol">.Response<span class="sh_symbol">.ContentType <span class="sh_symbol">== <span class="sh_string">"application/xml"<span class="sh_symbol">);

<span class="sh_comment">// Setting up multiple chained mocks:
<span class="sh_usertype">var<span class="sh_normal"> context <span class="sh_symbol">= Mock<span class="sh_symbol">.Of<span class="sh_symbol">&lt;ControllerContext<span class="sh_symbol">&gt;(ctx <span class="sh_symbol">=&gt;
     ctx<span class="sh_symbol">.HttpContext<span class="sh_symbol">.Request<span class="sh_symbol">.Url <span class="sh_symbol">== <span class="sh_keyword">new <span class="sh_function">Uri<span class="sh_symbol">(<span class="sh_string">"http://moqthis.me"<span class="sh_symbol">) <span class="sh_symbol">&amp;&amp;
     ctx<span class="sh_symbol">.HttpContext<span class="sh_symbol">.Response<span class="sh_symbol">.ContentType <span class="sh_symbol">== <span class="sh_string">"application/xml" <span class="sh_symbol">&amp;&amp;
     <span class="sh_comment">// Chained mock specification
     ctx<span class="sh_symbol">.HttpContext<span class="sh_symbol">.<span class="sh_function">GetSection<span class="sh_symbol">(<span class="sh_string">"server"<span class="sh_symbol">) <span class="sh_symbol">== Mock<span class="sh_symbol">.Of<span class="sh_symbol">&lt;ServerSection<span class="sh_symbol">&gt;(config <span class="sh_symbol">=&gt;
         config<span class="sh_symbol">.Server<span class="sh_symbol">.ServerUrl <span class="sh_symbol">== <span class="sh_keyword">new <span class="sh_function">Uri<span class="sh_symbol">(<span class="sh_string">"http://moqthis.com/api"<span class="sh_symbol">));
</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>
<p>LINQ to Mocks is great for quickly stubbing out dependencies that typically don't need further verification. If you do need to verify later some invocation on those mocks, you can easily retrieve them with Mock.Get(instance).</p>
<h1><a id="h3"></a>3 FAQ</h1>
<h2><a id="h3-1"></a>3.1 static class/method</h2>
<p>Moq 不支持对静态类或方法的 mock. 作为变通，可以使用实例方法来调用静态方法，再去 mock 实例方法。</p>
<p class="index"><a href="file:///C:/workspace/core_service/gxs_core/note/note/Language/CSharp/index.htm">&nbsp;</a></p>
</div>
</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>