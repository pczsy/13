<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修C# async 和 await 理解' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>C# async 和 await 理解</center></div><div class='banquan'>原文出处:本文由博客园博主soon123提供。<br/>
原文连接:https://www.cnblogs.com/need/p/11288329.html</div><br>
    <h1 id="c-async-和-await-理解" style="margin: 8px 0px 16px; padding: 0px; outline: 0px; color: #4f4f4f; line-height: 36px; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: 28px; font-weight: bold; box-sizing: border-box; overflow-wrap: break-word;">C# async 和 await 理解</h1>
<p style="margin: 0px 0px 16px; padding: 0px; outline: 0px; color: #4d4d4d; line-height: 26px; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: 16px; font-weight: 400; box-sizing: border-box; overflow-wrap: break-word;">先假设如下场景：</p>
<p style="margin: 0px 0px 16px; padding: 0px; outline: 0px; color: #4d4d4d; line-height: 26px; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: 16px; font-weight: 400; box-sizing: border-box; overflow-wrap: break-word;">主函数 Main，循环等待用户输入；</p>
<p style="margin: 0px 0px 16px; padding: 0px; outline: 0px; color: #4d4d4d; line-height: 26px; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: 16px; font-weight: 400; box-sizing: border-box; overflow-wrap: break-word;">计算函数 Cal，耗时计算大量数据；</p>
<pre><code><code><span class="hljs-class" style="margin: 0px; padding: 0px; outline: 0px; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;"><span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">class <span class="hljs-title" style="margin: 0px; padding: 0px; outline: 0px; color: #4f4f4f !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">Test 
{
     <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">static <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">int Main(string[] args)
     {
        <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">while(<span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">true)
        {
            <span class="hljs-comment" style="margin: 0px; padding: 0px; outline: 0px; color: #880000 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; font-style: italic; box-sizing: border-box; overflow-wrap: break-word;">// 等待用户输入
        }
     }

    <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">public <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">static <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">int Cal() {
        <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">int <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">sum = <span class="hljs-number" style="margin: 0px; padding: 0px; outline: 0px; color: #006666 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">0;
        <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">for (<span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">int i = <span class="hljs-number" style="margin: 0px; padding: 0px; outline: 0px; color: #006666 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">0; i &lt; <span class="hljs-number" style="margin: 0px; padding: 0px; outline: 0px; color: #006666 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">999; i++)
        {
            <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">sum = <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">sum + i;
        }
        Console.WriteLine($<span class="hljs-string" style="margin: 0px; padding: 0px; outline: 0px; color: #009900 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">"sum={sum}");
        <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">return <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">sum;
    }
}</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></code></pre>
<p style="margin: 0px 0px 16px; padding: 0px; outline: 0px; color: #4d4d4d; line-height: 26px; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: 16px; font-weight: 400; box-sizing: border-box; overflow-wrap: break-word;">为了在Main函数中调用Cal函数，同时Cal函数不阻塞主函数的循环，此时需要考虑增加一个CalAsync函数使Cal函数异步执行。</p>
<p style="margin: 0px 0px 16px; padding: 0px; outline: 0px; color: #4d4d4d; line-height: 26px; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: 16px; font-weight: 400; box-sizing: border-box; overflow-wrap: break-word;"><strong>传统的思维方法</strong>&nbsp; 在CalAsync函数中启动一个线程，并在线程中执行Cal函数：</p>
<pre><code><code class="language-C# hljs cs has-numbering" style="background: #f6f8fa; margin: 0px; padding: 8px; outline: 0px; border-radius: 4px; color: #4f4f4f !important; line-height: 22px; font-family: 'Source Code Pro', 'DejaVu Sans Mono', 'Ubuntu Mono', 'Anonymous Pro', 'Droid Sans Mono', Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, 'PingFang SC', 'Microsoft YaHei', sans-serif; font-size: 14px; display: block; white-space: pre; -ms-overflow-x: auto; min-width: 94%; box-sizing: border-box; overflow-wrap: break-word; text-size-adjust: none;"><span class="hljs-comment" style="margin: 0px; padding: 0px; outline: 0px; color: #880000 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; font-style: italic; box-sizing: border-box; overflow-wrap: break-word;">// using System.Threading;
<span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">public <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">static <span class="hljs-title" style="margin: 0px; padding: 0px; outline: 0px; color: #009900 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">CalAsync()
{
    Thread td = <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">new Thread(<span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">new ThreadStart(Cal));
    td.start();
}</span></span></span></span></span></span></code></pre>
<p style="margin: 0px 0px 16px; padding: 0px; outline: 0px; color: #4d4d4d; line-height: 26px; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: 16px; font-weight: 400; box-sizing: border-box; overflow-wrap: break-word;">这种方法显示地创建了一个线程并启动执行，CalAsync函数本身还是在主线程执行并且无法直接获取Cal函数的结果。</p>
<p style="margin: 0px 0px 16px; padding: 0px; outline: 0px; color: #4d4d4d; line-height: 26px; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: 16px; font-weight: 400; box-sizing: border-box; overflow-wrap: break-word;"><strong>async 和 await 异步编程方法</strong>&nbsp; 使用async标记CalAsync函数，并在CalAsync函数中创建任务Task异步执行Cal函数，同时使用await标记获取Cal函数的执行结果：</p>
<pre><code><code class="language-C# hljs cs has-numbering" style="background: #f6f8fa; margin: 0px; padding: 8px; outline: 0px; border-radius: 4px; color: #4f4f4f !important; line-height: 22px; font-family: 'Source Code Pro', 'DejaVu Sans Mono', 'Ubuntu Mono', 'Anonymous Pro', 'Droid Sans Mono', Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, 'PingFang SC', 'Microsoft YaHei', sans-serif; font-size: 14px; display: block; white-space: pre; -ms-overflow-x: auto; min-width: 94%; box-sizing: border-box; overflow-wrap: break-word; text-size-adjust: none;"><span class="hljs-comment" style="margin: 0px; padding: 0px; outline: 0px; color: #880000 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; font-style: italic; box-sizing: border-box; overflow-wrap: break-word;">// using System.Threading.Tasks;
<span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">public <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">static aysnc <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">void <span class="hljs-title" style="margin: 0px; padding: 0px; outline: 0px; color: #009900 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">CalAsync()
{
    <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">int result = <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">await Task.Run(<span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">new Func&lt;<span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">int&gt;(Cal));
    <span class="hljs-comment" style="margin: 0px; padding: 0px; outline: 0px; color: #880000 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; font-style: italic; box-sizing: border-box; overflow-wrap: break-word;">// 或使用lambda书写方式
    <span class="hljs-comment" style="margin: 0px; padding: 0px; outline: 0px; color: #880000 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; font-style: italic; box-sizing: border-box; overflow-wrap: break-word;">//  int result = await Task.Run(() =&gt; test());
    Console.WriteLine(result);
}</span></span></span></span></span></span></span></span></span></span></span></code></pre>
<p style="margin: 0px 0px 16px; padding: 0px; outline: 0px; color: #4d4d4d; line-height: 26px; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: 16px; font-weight: 400; box-sizing: border-box; overflow-wrap: break-word;">在Main函数中直接调用CalAsync函数，可以发现CalAsync成功调用了Cal函数并在一段时间后输出了结果，同时Main函数并不会被阻塞。</p>
<p style="margin: 0px 0px 16px; padding: 0px; outline: 0px; color: #4d4d4d; line-height: 26px; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: 16px; font-weight: 400; box-sizing: border-box; overflow-wrap: break-word;">分别在Main、Cal、CalAsync函数中增加代码打印当前线程ID：</p>
<pre><code><code class="language-C# hljs cs has-numbering" style="background: #f6f8fa; margin: 0px; padding: 8px; outline: 0px; border-radius: 4px; color: #4f4f4f !important; line-height: 22px; font-family: 'Source Code Pro', 'DejaVu Sans Mono', 'Ubuntu Mono', 'Anonymous Pro', 'Droid Sans Mono', Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, 'PingFang SC', 'Microsoft YaHei', sans-serif; font-size: 14px; display: block; white-space: pre; -ms-overflow-x: auto; min-width: 94%; box-sizing: border-box; overflow-wrap: break-word; text-size-adjust: none;">class Test
{
    <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">static <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">void Main(<span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">string[] args)
    {
        <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">string tid = Thread.CurrentThread.ManagedThreadId.ToString();
        Console.WriteLine($<span class="hljs-string" style="margin: 0px; padding: 0px; outline: 0px; color: #009900 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">"Main1 tid {tid}");
        Task&lt;<span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">int&gt; t = CalAsync();
        Console.WriteLine($<span class="hljs-string" style="margin: 0px; padding: 0px; outline: 0px; color: #009900 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">"Main after CalAsync");
        Console.Read();
    }

    <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">public <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">static <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">int <span class="hljs-title" style="margin: 0px; padding: 0px; outline: 0px; color: #009900 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">Cal()
    {
        <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">string tid = Thread.CurrentThread.ManagedThreadId.ToString();
        Console.WriteLine($<span class="hljs-string" style="margin: 0px; padding: 0px; outline: 0px; color: #009900 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">"Cal tid {tid}");
        <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">int sum = <span class="hljs-number" style="margin: 0px; padding: 0px; outline: 0px; color: #006666 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">0;
        <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">for (<span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">int i = <span class="hljs-number" style="margin: 0px; padding: 0px; outline: 0px; color: #006666 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">0; i &lt; <span class="hljs-number" style="margin: 0px; padding: 0px; outline: 0px; color: #006666 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">999; i++)
        {
            sum = sum + i;
        }
        Console.WriteLine($<span class="hljs-string" style="margin: 0px; padding: 0px; outline: 0px; color: #009900 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">"sum={sum}");
        <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">return sum;
    }

    <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">public <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">static <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">async Task&lt;<span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">int&gt; <span class="hljs-title" style="margin: 0px; padding: 0px; outline: 0px; color: #009900 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">CalAsync()
    {
        <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">string tid = Thread.CurrentThread.ManagedThreadId.ToString();
        Console.WriteLine($<span class="hljs-string" style="margin: 0px; padding: 0px; outline: 0px; color: #009900 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">"CalAsync1 tid {tid}");
        <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">int result = <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">await Task.Run(<span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">new Func&lt;<span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">int&gt;(Cal));
        tid = Thread.CurrentThread.ManagedThreadId.ToString();
        Console.WriteLine($<span class="hljs-string" style="margin: 0px; padding: 0px; outline: 0px; color: #009900 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">"CalAsync2 tid {tid}, result={result}");
        <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">return result;
    }
}</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></code></pre>
<p style="margin: 0px 0px 16px; padding: 0px; outline: 0px; color: #4d4d4d; line-height: 26px; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: 16px; font-weight: 400; box-sizing: border-box; overflow-wrap: break-word;">结果如图：&nbsp;&nbsp;</p>
<p style="margin: 0px 0px 16px; padding: 0px; outline: 0px; color: #4d4d4d; line-height: 26px; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: 16px; font-weight: 400; box-sizing: border-box; overflow-wrap: break-word;"><img title="C# async 和 await 理解" src="./images/C# async 和 await 理解0.png" alt="C# async 和 await 理解" /></p>
<p>&nbsp;</p>
<p style="margin: 0px 0px 16px; padding: 0px; outline: 0px; color: #4d4d4d; line-height: 26px; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: 16px; font-weight: 400; box-sizing: border-box; overflow-wrap: break-word;">可以看出，在CalAsync函数中，await标记之前，代码在主线程中执行，而await标记之后，代码在子线程中执行。</p>
<p style="margin: 0px 0px 16px; padding: 0px; outline: 0px; color: #4d4d4d; line-height: 26px; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: 16px; font-weight: 400; box-sizing: border-box; overflow-wrap: break-word;"><strong>理解与结论：</strong></p>
<ul style="list-style: none; margin: 0px 0px 24px; padding: 0px; outline: 0px; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: 16px; box-sizing: border-box; overflow-wrap: break-word;">
<li style="margin: 8px 0px 0px 32px; padding: 0px; outline: 0px; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; list-style-type: disc; box-sizing: border-box; overflow-wrap: break-word;">
<p style="margin: 0px 0px 16px; padding: 0px; outline: 0px; color: #4d4d4d; line-height: 26px; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: 16px; font-weight: 400; box-sizing: border-box; overflow-wrap: break-word;">在C#中， async标记了一个包含异步执行的函数，通过async标记的函数若在主线程中直接调用，则函数一开始仍在主线程中执行；</p>
</li>
<li style="margin: 8px 0px 0px 32px; padding: 0px; outline: 0px; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; list-style-type: disc; box-sizing: border-box; overflow-wrap: break-word;">
<p style="margin: 0px 0px 16px; padding: 0px; outline: 0px; color: #4d4d4d; line-height: 26px; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: 16px; font-weight: 400; box-sizing: border-box; overflow-wrap: break-word;">aysnc标记的函数内部必须包含await标记需要异步执行的函数（根据vs2017编译提示），若当前函数在主线程中直接调用，则await标记前的代码在主线程中执行，await标记后的代码在其异步子线程中执行；</p>
</li>
<li style="margin: 8px 0px 0px 32px; padding: 0px; outline: 0px; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; list-style-type: disc; box-sizing: border-box; overflow-wrap: break-word;">
<p style="margin: 0px 0px 16px; padding: 0px; outline: 0px; color: #4d4d4d; line-height: 26px; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: 16px; font-weight: 400; box-sizing: border-box; overflow-wrap: break-word;">async标记的函数返回值必须为void、Task、Task&lt; TResult&gt; 类型，可以理解为async标记的函数返回的是 &ldquo;空&rdquo;、&ldquo;即将执行的任务&rdquo;、&ldquo;带结果的即将执行的任务&rdquo;实例；</p>
</li>
<li style="margin: 8px 0px 0px 32px; padding: 0px; outline: 0px; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; list-style-type: disc; box-sizing: border-box; overflow-wrap: break-word;">
<p style="margin: 0px 0px 16px; padding: 0px; outline: 0px; color: #4d4d4d; line-height: 26px; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: 16px; font-weight: 400; box-sizing: border-box; overflow-wrap: break-word;">async标记的函数可以继续往下调用async标记函数，调用形式如下例， 从调用逻辑可以理解为await实际上用来触发所标记的Task任务异步执行，并最后获取异步执行的返回值，从运行过程看该触发应该仅对最终的Task任务有效：</p>
</li>
</ul>
<pre><code><code class="hljs cs has-numbering" style="background: #f6f8fa; margin: 0px; padding: 8px; outline: 0px; border-radius: 4px; color: #4f4f4f !important; line-height: 22px; font-family: 'Source Code Pro', 'DejaVu Sans Mono', 'Ubuntu Mono', 'Anonymous Pro', 'Droid Sans Mono', Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, 'PingFang SC', 'Microsoft YaHei', sans-serif; font-size: 14px; display: block; white-space: pre; -ms-overflow-x: auto; min-width: 94%; box-sizing: border-box; overflow-wrap: break-word; text-size-adjust: none;"> <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">public <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">static <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">async Task&lt;<span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">int&gt; <span class="hljs-title" style="margin: 0px; padding: 0px; outline: 0px; color: #009900 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">CallCalAsync()
        {
            <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">string tid = Thread.CurrentThread.ManagedThreadId.ToString();
            Console.WriteLine($<span class="hljs-string" style="margin: 0px; padding: 0px; outline: 0px; color: #009900 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">"CallCalAsync1 tid {tid}");
            <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">int result = <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">await CalAsync();
            tid = Thread.CurrentThread.ManagedThreadId.ToString();
            Console.WriteLine($<span class="hljs-string" style="margin: 0px; padding: 0px; outline: 0px; color: #009900 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">"CallCalAsync2 tid {tid}, result={result}");
            <span class="hljs-keyword" style="margin: 0px; padding: 0px; outline: 0px; color: #000088 !important; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: inherit; box-sizing: border-box; overflow-wrap: break-word;">return result;
        }</span></span></span></span></span></span></span></span></span></span></span></code></pre>
<p style="margin: 0px 0px 16px; padding: 0px; outline: 0px; color: #4d4d4d; line-height: 26px; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: 16px; font-weight: 400; box-sizing: border-box; overflow-wrap: break-word;">&nbsp;<img title="C# async 和 await 理解" src="./images/C# async 和 await 理解1.png" alt="" /></p>
<p>&nbsp;</p>
<h3 id="总结" style="margin: 8px 0px 16px; padding: 0px; outline: 0px; color: #4f4f4f; line-height: 30px; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: 22px; font-weight: bold; box-sizing: border-box; overflow-wrap: break-word;">总结</h3>
<p style="margin: 0px 0px 16px; padding: 0px; outline: 0px; color: #4d4d4d; line-height: 26px; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: 16px; font-weight: 400; box-sizing: border-box; overflow-wrap: break-word;">C#中async与await异步编程，可以理解为：</p>
<p style="margin: 0px 0px 16px; padding: 0px; outline: 0px; color: #4d4d4d; line-height: 26px; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: 16px; font-weight: 400; box-sizing: border-box; overflow-wrap: break-word;"><strong>1. async声明了一个包含异步执行代码的函数，该函数执行时不会阻塞调用线程；</strong></p>
<p style="margin: 0px 0px 16px; padding: 0px; outline: 0px; color: #4d4d4d; line-height: 26px; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: 16px; font-weight: 400; box-sizing: border-box; overflow-wrap: break-word;"><strong>2. await存在于async函数中，声明了一个异步执行入口，程序动态运行时从该入口创建并进入一个异步线程环境，并在该线程执行任务实例及任务实例返回之后的代码；</strong></p>
<p style="margin: 0px 0px 16px; padding: 0px; outline: 0px; color: #4d4d4d; line-height: 26px; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: 16px; font-weight: 400; box-sizing: border-box; overflow-wrap: break-word;"><strong>3. 一个async函数中声明多个await关键字时，程序将代码顺序创建并进入异步子线程执行任务实例及任务实例返回之后的代码直到下一个await声明处， 最后一个await声明之后的代码会在最后一个异步子线程中执行 ；</strong></p>
<p style="margin: 0px 0px 16px; padding: 0px; outline: 0px; color: #4d4d4d; line-height: 26px; font-family: 'Microsoft YaHei', 'SF Pro Display', Roboto, Noto, Arial, 'PingFang SC', sans-serif; font-size: 16px; font-weight: 400; box-sizing: border-box; overflow-wrap: break-word;"><strong>3. await标记的右侧代码返回或定义了一个任务实例，该实例由需要异步执行的目标耗时函数初始化，并在最终定义处触发异步执行。</strong></p>
</div>
</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>