<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修一个类搞定SQL条件映射解析，实现轻量简单实用ORM功能' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>一个类搞定SQL条件映射解析，实现轻量简单实用ORM功能</center></div><div class='banquan'>原文出处:本文由博客园博主util6提供。<br/>
原文连接:https://www.cnblogs.com/dreamman/p/10805041.html</div><br>
    <p>个人觉得轻简级的ORM既要支持强类型编码，又要有执行效率，还要通俗易懂给开发者友好提示，结合Expression可轻松定制自己所需要功能。</p>
<p>&nbsp;</p>
<p>Orm成品开源项目地址<br />https://github.com/PlugNT/util6</p>
<p>&nbsp;</p>
<p>表达式解析类：</p>
<div class="cnblogs_code">
<pre><code><span style="color: #008080;">  1</span> <span style="color: #0000ff;">using</span><span style="color: #000000;"> System;
</span><span style="color: #008080;">  2</span> <span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Collections;
</span><span style="color: #008080;">  3</span> <span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Collections.Generic;
</span><span style="color: #008080;">  4</span> <span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Data.Common;
</span><span style="color: #008080;">  5</span> <span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Linq;
</span><span style="color: #008080;">  6</span> <span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Linq.Expressions;
</span><span style="color: #008080;">  7</span> <span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Text;
</span><span style="color: #008080;">  8</span> <span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Reflection;
</span><span style="color: #008080;">  9</span> <span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Text.RegularExpressions;
</span><span style="color: #008080;"> 10</span> 
<span style="color: #008080;"> 11</span> <span style="color: #0000ff;">using</span><span style="color: #000000;"> Util.Database;
</span><span style="color: #008080;"> 12</span> <span style="color: #0000ff;">namespace</span><span style="color: #000000;"> Util.EntityMapping
</span><span style="color: #008080;"> 13</span> <span style="color: #000000;">{
</span><span style="color: #008080;"> 14</span> 
<span style="color: #008080;"> 15</span> 
<span style="color: #008080;"> 16</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> SqlLmdResolver
</span><span style="color: #008080;"> 17</span> <span style="color: #000000;">    {
</span><span style="color: #008080;"> 18</span> 
<span style="color: #008080;"> 19</span>         <span style="color: #0000ff;">internal</span> <span style="color: #0000ff;">int</span> ParaIndex = <span style="color: #800080;">1</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 20</span> 
<span style="color: #008080;"> 21</span> 
<span style="color: #008080;"> 22</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">string</span> _SqlWhere = <span style="color: #0000ff;">null</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 23</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">string</span><span style="color: #000000;"> SqlWhere
</span><span style="color: #008080;"> 24</span> <span style="color: #000000;">        {
</span><span style="color: #008080;"> 25</span>             <span style="color: #0000ff;">get</span> { <span style="color: #0000ff;">return</span><span style="color: #000000;"> _SqlWhere; }
</span><span style="color: #008080;"> 26</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 27</span> 
<span style="color: #008080;"> 28</span> 
<span style="color: #008080;"> 29</span>         <span style="color: #0000ff;">private</span> List&lt;DbParameter&gt; _Parameters = <span style="color: #0000ff;">null</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 30</span>         <span style="color: #0000ff;">public</span> List&lt;DbParameter&gt;<span style="color: #000000;"> Parameters
</span><span style="color: #008080;"> 31</span> <span style="color: #000000;">        {
</span><span style="color: #008080;"> 32</span>             <span style="color: #0000ff;">get</span> { <span style="color: #0000ff;">return</span><span style="color: #000000;"> _Parameters; }
</span><span style="color: #008080;"> 33</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 34</span> 
<span style="color: #008080;"> 35</span> 
<span style="color: #008080;"> 36</span>         <span style="color: #0000ff;">private</span> DbConfig _DbConfig = <span style="color: #0000ff;">null</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 37</span> 
<span style="color: #008080;"> 38</span> 
<span style="color: #008080;"> 39</span>         <span style="color: #0000ff;">public</span> SqlLmdResolver(DbConfig config = <span style="color: #0000ff;">null</span><span style="color: #000000;">)
</span><span style="color: #008080;"> 40</span> <span style="color: #000000;">        {
</span><span style="color: #008080;"> 41</span>             _DbConfig = config ??<span style="color: #000000;"> DbConfig.Default;
</span><span style="color: #008080;"> 42</span>             _SqlWhere = <span style="color: #0000ff;">string</span><span style="color: #000000;">.Empty;
</span><span style="color: #008080;"> 43</span>             _Parameters = <span style="color: #0000ff;">new</span> List&lt;DbParameter&gt;<span style="color: #000000;">();
</span><span style="color: #008080;"> 44</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 45</span> 
<span style="color: #008080;"> 46</span> 
<span style="color: #008080;"> 47</span> 
<span style="color: #008080;"> 48</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> ResolveExpression(Expression expression = <span style="color: #0000ff;">null</span>, SqlWhereType whereType =<span style="color: #000000;"> SqlWhereType.And)
</span><span style="color: #008080;"> 49</span> <span style="color: #000000;">        {
</span><span style="color: #008080;"> 50</span>             <span style="color: #0000ff;">if</span> (expression == <span style="color: #0000ff;">null</span><span style="color: #000000;">)
</span><span style="color: #008080;"> 51</span> <span style="color: #000000;">            {
</span><span style="color: #008080;"> 52</span>                 _SqlWhere = <span style="color: #0000ff;">string</span><span style="color: #000000;">.Empty;
</span><span style="color: #008080;"> 53</span>                 <span style="color: #0000ff;">return</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 54</span> <span style="color: #000000;">            }
</span><span style="color: #008080;"> 55</span>             <span style="color: #0000ff;">var</span> sqlFormat = (whereType == SqlWhereType.And) ? <span style="color: #800000;">"</span><span style="color: #800000;"> AND {0} </span><span style="color: #800000;">"</span> : <span style="color: #800000;">"</span><span style="color: #800000;"> OR {0} </span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 56</span>             SqlLmdResolver.MemberType type =<span style="color: #000000;"> SqlLmdResolver.MemberType.None;
</span><span style="color: #008080;"> 57</span>             <span style="color: #0000ff;">this</span>._SqlWhere = <span style="color: #0000ff;">string</span>.Format(sqlFormat, GetResolveAll(expression, <span style="color: #0000ff;">ref</span><span style="color: #000000;"> type).SqlConditions);
</span><span style="color: #008080;"> 58</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 59</span> 
<span style="color: #008080;"> 60</span>         
<span style="color: #008080;"> 61</span>         <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">enum</span><span style="color: #000000;"> MemberType
</span><span style="color: #008080;"> 62</span> <span style="color: #000000;">        {
</span><span style="color: #008080;"> 63</span>             None = <span style="color: #800080;">0</span><span style="color: #000000;">,
</span><span style="color: #008080;"> 64</span>             Left = <span style="color: #800080;">1</span><span style="color: #000000;">,
</span><span style="color: #008080;"> 65</span>             Right = <span style="color: #800080;">2</span>
<span style="color: #008080;"> 66</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 67</span> 
<span style="color: #008080;"> 68</span>         <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">struct</span><span style="color: #000000;"> ParamInfo
</span><span style="color: #008080;"> 69</span> <span style="color: #000000;">        {
</span><span style="color: #008080;"> 70</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">string</span><span style="color: #000000;"> SqlConditions;
</span><span style="color: #008080;"> 71</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">object</span><span style="color: #000000;"> ObjectValue;
</span><span style="color: #008080;"> 72</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 73</span> 
<span style="color: #008080;"> 74</span> 
<span style="color: #008080;"> 75</span> 
<span style="color: #008080;"> 76</span>         <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">string</span> AddParametersReturnLeft(<span style="color: #0000ff;">ref</span><span style="color: #000000;"> ParamInfo left, ParamInfo right)
</span><span style="color: #008080;"> 77</span> <span style="color: #000000;">        {
</span><span style="color: #008080;"> 78</span>             <span style="color: #0000ff;">string</span> oldLeftKey =<span style="color: #000000;"> left.SqlConditions;
</span><span style="color: #008080;"> 79</span>             left.SqlConditions = <span style="color: #800000;">"</span><span style="color: #800000;">P</span><span style="color: #800000;">"</span>+ ParaIndex +<span style="color: #000000;"> oldLeftKey;
</span><span style="color: #008080;"> 80</span>             ParaIndex++<span style="color: #000000;">;
</span><span style="color: #008080;"> 81</span>             <span style="color: #0000ff;">if</span> (right.ObjectValue == <span style="color: #0000ff;">null</span><span style="color: #000000;">)
</span><span style="color: #008080;"> 82</span> <span style="color: #000000;">            {
</span><span style="color: #008080;"> 83</span>                 <span style="color: #0000ff;">this</span>._Parameters.Add(DbProvider.MakeParam(_DbConfig, <span style="color: #800000;">"</span><span style="color: #800000;">@</span><span style="color: #800000;">"</span> +<span style="color: #000000;"> left.SqlConditions, DBNull.Value));
</span><span style="color: #008080;"> 84</span> <span style="color: #000000;">            }
</span><span style="color: #008080;"> 85</span>             <span style="color: #0000ff;">else</span>
<span style="color: #008080;"> 86</span> <span style="color: #000000;">            {
</span><span style="color: #008080;"> 87</span>                 <span style="color: #0000ff;">this</span>._Parameters.Add(DbProvider.MakeParam(_DbConfig, <span style="color: #800000;">"</span><span style="color: #800000;">@</span><span style="color: #800000;">"</span> +<span style="color: #000000;"> left.SqlConditions, right.ObjectValue));
</span><span style="color: #008080;"> 88</span> <span style="color: #000000;">            }
</span><span style="color: #008080;"> 89</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> oldLeftKey;
</span><span style="color: #008080;"> 90</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 91</span>         <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">string</span> AddParametersReturnRight(ParamInfo left, <span style="color: #0000ff;">ref</span><span style="color: #000000;"> ParamInfo right)
</span><span style="color: #008080;"> 92</span> <span style="color: #000000;">        {
</span><span style="color: #008080;"> 93</span>             <span style="color: #0000ff;">string</span> oldRightKey =<span style="color: #000000;"> right.SqlConditions;
</span><span style="color: #008080;"> 94</span>             right.SqlConditions = <span style="color: #800000;">"</span><span style="color: #800000;">P</span><span style="color: #800000;">"</span> + ParaIndex +<span style="color: #000000;"> oldRightKey;
</span><span style="color: #008080;"> 95</span>             ParaIndex++<span style="color: #000000;">;
</span><span style="color: #008080;"> 96</span>             <span style="color: #0000ff;">if</span> (left.ObjectValue == <span style="color: #0000ff;">null</span><span style="color: #000000;">)
</span><span style="color: #008080;"> 97</span> <span style="color: #000000;">            {
</span><span style="color: #008080;"> 98</span>                 <span style="color: #0000ff;">this</span>._Parameters.Add(DbProvider.MakeParam(_DbConfig, <span style="color: #800000;">"</span><span style="color: #800000;">@</span><span style="color: #800000;">"</span> +<span style="color: #000000;"> right.SqlConditions, DBNull.Value));
</span><span style="color: #008080;"> 99</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">100</span>             <span style="color: #0000ff;">else</span>
<span style="color: #008080;">101</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">102</span>                 <span style="color: #0000ff;">this</span>._Parameters.Add(DbProvider.MakeParam(_DbConfig, <span style="color: #800000;">"</span><span style="color: #800000;">@</span><span style="color: #800000;">"</span> +<span style="color: #000000;"> right.SqlConditions, left.ObjectValue));
</span><span style="color: #008080;">103</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">104</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> oldRightKey;
</span><span style="color: #008080;">105</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">106</span> 
<span style="color: #008080;">107</span> 
<span style="color: #008080;">108</span> 
<span style="color: #008080;">109</span>         <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">string</span><span style="color: #000000;"> GetOperator(ExpressionType expressiontype)
</span><span style="color: #008080;">110</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">111</span>             <span style="color: #0000ff;">switch</span><span style="color: #000000;"> (expressiontype)
</span><span style="color: #008080;">112</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">113</span>                 <span style="color: #0000ff;">case</span><span style="color: #000000;"> ExpressionType.And:
</span><span style="color: #008080;">114</span>                 <span style="color: #0000ff;">case</span><span style="color: #000000;"> ExpressionType.AndAlso:
</span><span style="color: #008080;">115</span>                     <span style="color: #0000ff;">return</span> <span style="color: #800000;">"</span><span style="color: #800000;"> AND </span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">116</span>                 <span style="color: #0000ff;">case</span><span style="color: #000000;"> ExpressionType.Equal:
</span><span style="color: #008080;">117</span>                     <span style="color: #0000ff;">return</span> <span style="color: #800000;">"</span><span style="color: #800000;"> =</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">118</span>                 <span style="color: #0000ff;">case</span><span style="color: #000000;"> ExpressionType.GreaterThan:
</span><span style="color: #008080;">119</span>                     <span style="color: #0000ff;">return</span> <span style="color: #800000;">"</span><span style="color: #800000;"> &gt;</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">120</span>                 <span style="color: #0000ff;">case</span><span style="color: #000000;"> ExpressionType.GreaterThanOrEqual:
</span><span style="color: #008080;">121</span>                     <span style="color: #0000ff;">return</span> <span style="color: #800000;">"</span><span style="color: #800000;">&gt;=</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">122</span>                 <span style="color: #0000ff;">case</span><span style="color: #000000;"> ExpressionType.LessThan:
</span><span style="color: #008080;">123</span>                     <span style="color: #0000ff;">return</span> <span style="color: #800000;">"</span><span style="color: #800000;">&lt;</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">124</span>                 <span style="color: #0000ff;">case</span><span style="color: #000000;"> ExpressionType.LessThanOrEqual:
</span><span style="color: #008080;">125</span>                     <span style="color: #0000ff;">return</span> <span style="color: #800000;">"</span><span style="color: #800000;">&lt;=</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">126</span>                 <span style="color: #0000ff;">case</span><span style="color: #000000;"> ExpressionType.NotEqual:
</span><span style="color: #008080;">127</span>                     <span style="color: #0000ff;">return</span> <span style="color: #800000;">"</span><span style="color: #800000;">&lt;&gt;</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">128</span>                 <span style="color: #0000ff;">case</span><span style="color: #000000;"> ExpressionType.Or:
</span><span style="color: #008080;">129</span>                 <span style="color: #0000ff;">case</span><span style="color: #000000;"> ExpressionType.OrElse:
</span><span style="color: #008080;">130</span>                     <span style="color: #0000ff;">return</span> <span style="color: #800000;">"</span><span style="color: #800000;"> OR </span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">131</span>                 <span style="color: #0000ff;">case</span><span style="color: #000000;"> ExpressionType.Add:
</span><span style="color: #008080;">132</span>                 <span style="color: #0000ff;">case</span><span style="color: #000000;"> ExpressionType.AddChecked:
</span><span style="color: #008080;">133</span>                     <span style="color: #0000ff;">return</span> <span style="color: #800000;">"</span><span style="color: #800000;">+</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">134</span>                 <span style="color: #0000ff;">case</span><span style="color: #000000;"> ExpressionType.Subtract:
</span><span style="color: #008080;">135</span>                 <span style="color: #0000ff;">case</span><span style="color: #000000;"> ExpressionType.SubtractChecked:
</span><span style="color: #008080;">136</span>                     <span style="color: #0000ff;">return</span> <span style="color: #800000;">"</span><span style="color: #800000;">-</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">137</span>                 <span style="color: #0000ff;">case</span><span style="color: #000000;"> ExpressionType.Divide:
</span><span style="color: #008080;">138</span>                     <span style="color: #0000ff;">return</span> <span style="color: #800000;">"</span><span style="color: #800000;">/</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">139</span>                 <span style="color: #0000ff;">case</span><span style="color: #000000;"> ExpressionType.Multiply:
</span><span style="color: #008080;">140</span>                 <span style="color: #0000ff;">case</span><span style="color: #000000;"> ExpressionType.MultiplyChecked:
</span><span style="color: #008080;">141</span>                     <span style="color: #0000ff;">return</span> <span style="color: #800000;">"</span><span style="color: #800000;">*</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">142</span>                 <span style="color: #0000ff;">default</span><span style="color: #000000;">:
</span><span style="color: #008080;">143</span>                     <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> Exception(<span style="color: #0000ff;">string</span>.Format(<span style="color: #800000;">"</span><span style="color: #800000;">不支持{0}此种运算符查找！</span><span style="color: #800000;">"</span><span style="color: #000000;">, expressiontype.ToString()));
</span><span style="color: #008080;">144</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">145</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">146</span> 
<span style="color: #008080;">147</span> 
<span style="color: #008080;">148</span>         <span style="color: #0000ff;">private</span> ParamInfo GetResolveAll(Expression exp, <span style="color: #0000ff;">ref</span> MemberType type, <span style="color: #0000ff;">bool</span> isTure = <span style="color: #0000ff;">true</span><span style="color: #000000;">)
</span><span style="color: #008080;">149</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">150</span>             <span style="color: #0000ff;">if</span> (exp <span style="color: #0000ff;">is</span><span style="color: #000000;"> LambdaExpression)
</span><span style="color: #008080;">151</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">152</span>                 <span style="color: #0000ff;">return</span><span style="color: #000000;"> GetResolveLambda(exp);
</span><span style="color: #008080;">153</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">154</span>             <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (exp <span style="color: #0000ff;">is</span><span style="color: #000000;"> BinaryExpression)
</span><span style="color: #008080;">155</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">156</span>                 <span style="color: #0000ff;">return</span><span style="color: #000000;"> GetResolveBinary(exp);
</span><span style="color: #008080;">157</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">158</span>             <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (exp <span style="color: #0000ff;">is</span><span style="color: #000000;"> MethodCallExpression)
</span><span style="color: #008080;">159</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">160</span>                 <span style="color: #0000ff;">return</span> GetResolveMethodCall(exp, <span style="color: #0000ff;">ref</span><span style="color: #000000;"> type, isTure);
</span><span style="color: #008080;">161</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">162</span>             <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (exp <span style="color: #0000ff;">is</span><span style="color: #000000;"> ConstantExpression)
</span><span style="color: #008080;">163</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">164</span>                 <span style="color: #0000ff;">return</span> GetResolveConstant(exp, <span style="color: #0000ff;">ref</span><span style="color: #000000;"> type);
</span><span style="color: #008080;">165</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">166</span>             <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (exp <span style="color: #0000ff;">is</span><span style="color: #000000;"> MemberExpression)
</span><span style="color: #008080;">167</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">168</span>                 <span style="color: #0000ff;">return</span> GetResolveMember(exp, <span style="color: #0000ff;">ref</span><span style="color: #000000;"> type);
</span><span style="color: #008080;">169</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">170</span>             <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (exp <span style="color: #0000ff;">is</span><span style="color: #000000;"> UnaryExpression)
</span><span style="color: #008080;">171</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">172</span>                 <span style="color: #0000ff;">return</span> GetResolveUnary(exp, <span style="color: #0000ff;">ref</span><span style="color: #000000;"> type);
</span><span style="color: #008080;">173</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">174</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> ParamInfo();
</span><span style="color: #008080;">175</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">176</span>         
<span style="color: #008080;">177</span>         <span style="color: #0000ff;">private</span><span style="color: #000000;"> ParamInfo GetResolveLambda(Expression exp)
</span><span style="color: #008080;">178</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">179</span>             LambdaExpression lambda = exp <span style="color: #0000ff;">as</span><span style="color: #000000;"> LambdaExpression;
</span><span style="color: #008080;">180</span>             <span style="color: #0000ff;">var</span> expression =<span style="color: #000000;"> lambda.Body;
</span><span style="color: #008080;">181</span>             MemberType EleType =<span style="color: #000000;"> MemberType.None;
</span><span style="color: #008080;">182</span> 
<span style="color: #008080;">183</span>             <span style="color: #0000ff;">if</span> (expression <span style="color: #0000ff;">is</span><span style="color: #000000;"> UnaryExpression)
</span><span style="color: #008080;">184</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">185</span>                 <span style="color: #0000ff;">var</span> me = expression <span style="color: #0000ff;">as</span><span style="color: #000000;"> UnaryExpression;
</span><span style="color: #008080;">186</span>                 <span style="color: #0000ff;">if</span> (me.Operand <span style="color: #0000ff;">is</span><span style="color: #000000;"> MemberExpression)
</span><span style="color: #008080;">187</span> <span style="color: #000000;">                {
</span><span style="color: #008080;">188</span>                     <span style="color: #0000ff;">var</span> ime = me.Operand <span style="color: #0000ff;">as</span><span style="color: #000000;"> MemberExpression;
</span><span style="color: #008080;">189</span>                     <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> ParamInfo { SqlConditions = ime.Member.Name.ToString() + <span style="color: #800000;">"</span><span style="color: #800000;">=0</span><span style="color: #800000;">"</span><span style="color: #000000;"> };
</span><span style="color: #008080;">190</span> <span style="color: #000000;">                }
</span><span style="color: #008080;">191</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">192</span>             <span style="color: #0000ff;">if</span> (expression <span style="color: #0000ff;">is</span><span style="color: #000000;"> MemberExpression)
</span><span style="color: #008080;">193</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">194</span>                 <span style="color: #0000ff;">var</span> me = expression <span style="color: #0000ff;">as</span><span style="color: #000000;"> MemberExpression;
</span><span style="color: #008080;">195</span>                 <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> ParamInfo { SqlConditions = me.Member.Name.ToString() + <span style="color: #800000;">"</span><span style="color: #800000;">=1</span><span style="color: #800000;">"</span><span style="color: #000000;"> };
</span><span style="color: #008080;">196</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">197</span>             <span style="color: #0000ff;">return</span> GetResolveAll(expression, <span style="color: #0000ff;">ref</span><span style="color: #000000;"> EleType);
</span><span style="color: #008080;">198</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">199</span>         <span style="color: #0000ff;">private</span><span style="color: #000000;"> ParamInfo GetResolveBinary(Expression exp)
</span><span style="color: #008080;">200</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">201</span>             <span style="color: #0000ff;">var</span> expression = exp <span style="color: #0000ff;">as</span><span style="color: #000000;"> BinaryExpression;
</span><span style="color: #008080;">202</span>             MemberType leftType =<span style="color: #000000;"> MemberType.None;
</span><span style="color: #008080;">203</span>             MemberType rightType =<span style="color: #000000;"> MemberType.None;
</span><span style="color: #008080;">204</span> 
<span style="color: #008080;">205</span>             <span style="color: #0000ff;">var</span> left = GetResolveAll(expression.Left, <span style="color: #0000ff;">ref</span><span style="color: #000000;"> leftType);
</span><span style="color: #008080;">206</span>             <span style="color: #0000ff;">var</span> right = GetResolveAll(expression.Right, <span style="color: #0000ff;">ref</span><span style="color: #000000;"> rightType);
</span><span style="color: #008080;">207</span>             <span style="color: #0000ff;">var</span> oper =<span style="color: #000000;"> GetOperator(expression.NodeType);
</span><span style="color: #008080;">208</span>             <span style="color: #0000ff;">var</span> isKeyOperValue = leftType == MemberType.Left &amp;&amp; rightType ==<span style="color: #000000;"> MemberType.Right;
</span><span style="color: #008080;">209</span>             <span style="color: #0000ff;">var</span> isValueOperKey = rightType == MemberType.Left &amp;&amp; leftType ==<span style="color: #000000;"> MemberType.Right;
</span><span style="color: #008080;">210</span> 
<span style="color: #008080;">211</span>             <span style="color: #0000ff;">if</span> (leftType == MemberType.Left &amp;&amp; rightType ==<span style="color: #000000;"> MemberType.None)
</span><span style="color: #008080;">212</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">213</span>                 <span style="color: #0000ff;">if</span> (expression.Left <span style="color: #0000ff;">is</span><span style="color: #000000;"> UnaryExpression)
</span><span style="color: #008080;">214</span> <span style="color: #000000;">                {
</span><span style="color: #008080;">215</span>                     <span style="color: #0000ff;">var</span> me = expression.Left <span style="color: #0000ff;">as</span><span style="color: #000000;"> UnaryExpression;
</span><span style="color: #008080;">216</span>                     <span style="color: #0000ff;">if</span> (me.Operand <span style="color: #0000ff;">is</span><span style="color: #000000;"> MemberExpression)
</span><span style="color: #008080;">217</span> <span style="color: #000000;">                    {
</span><span style="color: #008080;">218</span>                         left.SqlConditions = left.SqlConditions + <span style="color: #800000;">"</span><span style="color: #800000;">=0</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">219</span> <span style="color: #000000;">                    }
</span><span style="color: #008080;">220</span> <span style="color: #000000;">                }
</span><span style="color: #008080;">221</span>                 <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (expression.Left <span style="color: #0000ff;">is</span><span style="color: #000000;"> MemberExpression)
</span><span style="color: #008080;">222</span> <span style="color: #000000;">                {
</span><span style="color: #008080;">223</span>                     left.SqlConditions = left.SqlConditions + <span style="color: #800000;">"</span><span style="color: #800000;">=1</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">224</span> <span style="color: #000000;">                }
</span><span style="color: #008080;">225</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">226</span>             <span style="color: #0000ff;">if</span> (leftType == MemberType.None &amp;&amp; rightType ==<span style="color: #000000;"> MemberType.Left)
</span><span style="color: #008080;">227</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">228</span>                 <span style="color: #0000ff;">if</span> (expression.Right <span style="color: #0000ff;">is</span><span style="color: #000000;"> UnaryExpression)
</span><span style="color: #008080;">229</span> <span style="color: #000000;">                {
</span><span style="color: #008080;">230</span>                     <span style="color: #0000ff;">var</span> me = expression.Right <span style="color: #0000ff;">as</span><span style="color: #000000;"> UnaryExpression;
</span><span style="color: #008080;">231</span>                     <span style="color: #0000ff;">if</span> (me.Operand <span style="color: #0000ff;">is</span><span style="color: #000000;"> MemberExpression)
</span><span style="color: #008080;">232</span> <span style="color: #000000;">                    {
</span><span style="color: #008080;">233</span>                         right.SqlConditions = right.SqlConditions + <span style="color: #800000;">"</span><span style="color: #800000;">=0</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">234</span> <span style="color: #000000;">                    }
</span><span style="color: #008080;">235</span> <span style="color: #000000;">                }
</span><span style="color: #008080;">236</span>                 <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (expression.Right <span style="color: #0000ff;">is</span><span style="color: #000000;"> MemberExpression)
</span><span style="color: #008080;">237</span> <span style="color: #000000;">                {
</span><span style="color: #008080;">238</span>                     right.SqlConditions = right.SqlConditions + <span style="color: #800000;">"</span><span style="color: #800000;">=1</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">239</span> <span style="color: #000000;">                }
</span><span style="color: #008080;">240</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">241</span> 
<span style="color: #008080;">242</span>             <span style="color: #0000ff;">if</span> (isKeyOperValue &amp; (right.ObjectValue == <span style="color: #0000ff;">null</span>) &amp;&amp; oper.Trim() == <span style="color: #800000;">"</span><span style="color: #800000;">=</span><span style="color: #800000;">"</span><span style="color: #000000;">)
</span><span style="color: #008080;">243</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">244</span>                 <span style="color: #0000ff;">var</span> oldLeft = AddParametersReturnLeft(<span style="color: #0000ff;">ref</span><span style="color: #000000;"> left, right);
</span><span style="color: #008080;">245</span>                 <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> ParamInfo { SqlConditions = <span style="color: #0000ff;">string</span>.Format(<span style="color: #800000;">"</span><span style="color: #800000;"> ({0} is null) </span><span style="color: #800000;">"</span><span style="color: #000000;">, oldLeft) };
</span><span style="color: #008080;">246</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">247</span>             <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (isKeyOperValue &amp; (right.ObjectValue == <span style="color: #0000ff;">null</span>) &amp;&amp; oper.Trim() == <span style="color: #800000;">"</span><span style="color: #800000;">&lt;&gt;</span><span style="color: #800000;">"</span><span style="color: #000000;">)
</span><span style="color: #008080;">248</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">249</span>                 <span style="color: #0000ff;">var</span> oldLeft = AddParametersReturnLeft(<span style="color: #0000ff;">ref</span><span style="color: #000000;"> left, right);
</span><span style="color: #008080;">250</span>                 <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> ParamInfo { SqlConditions = <span style="color: #0000ff;">string</span>.Format(<span style="color: #800000;">"</span><span style="color: #800000;"> ({0} is not null) </span><span style="color: #800000;">"</span><span style="color: #000000;">, oldLeft) };
</span><span style="color: #008080;">251</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">252</span>             <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (isValueOperKey &amp; (left.ObjectValue == <span style="color: #0000ff;">null</span>) &amp;&amp; oper.Trim() == <span style="color: #800000;">"</span><span style="color: #800000;">=</span><span style="color: #800000;">"</span><span style="color: #000000;">)
</span><span style="color: #008080;">253</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">254</span>                 <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> ParamInfo { SqlConditions = <span style="color: #0000ff;">string</span>.Format(<span style="color: #800000;">"</span><span style="color: #800000;"> ({0} is null) </span><span style="color: #800000;">"</span><span style="color: #000000;">, right.SqlConditions) };
</span><span style="color: #008080;">255</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">256</span>             <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (isValueOperKey &amp; (left.ObjectValue == <span style="color: #0000ff;">null</span>) &amp;&amp; oper.Trim() == <span style="color: #800000;">"</span><span style="color: #800000;">&lt;&gt;</span><span style="color: #800000;">"</span><span style="color: #000000;">)
</span><span style="color: #008080;">257</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">258</span>                 <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> ParamInfo { SqlConditions = <span style="color: #0000ff;">string</span>.Format(<span style="color: #800000;">"</span><span style="color: #800000;"> ({0} is not null) </span><span style="color: #800000;">"</span><span style="color: #000000;">, right.SqlConditions) };
</span><span style="color: #008080;">259</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">260</span> 
<span style="color: #008080;">261</span>             <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span><span style="color: #000000;"> (isKeyOperValue)
</span><span style="color: #008080;">262</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">263</span>                 <span style="color: #0000ff;">var</span> oldLeft = AddParametersReturnLeft(<span style="color: #0000ff;">ref</span><span style="color: #000000;"> left, right);
</span><span style="color: #008080;">264</span>                 <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> ParamInfo { SqlConditions = <span style="color: #0000ff;">string</span>.Format(<span style="color: #800000;">"</span><span style="color: #800000;"> ({0} {1} @{2}) </span><span style="color: #800000;">"</span><span style="color: #000000;">, oldLeft, oper, left.SqlConditions) };
</span><span style="color: #008080;">265</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">266</span>             <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span><span style="color: #000000;"> (isValueOperKey)
</span><span style="color: #008080;">267</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">268</span>                 <span style="color: #0000ff;">var</span> oldRight = AddParametersReturnRight(left, <span style="color: #0000ff;">ref</span><span style="color: #000000;"> right);
</span><span style="color: #008080;">269</span>                 <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> ParamInfo { SqlConditions = <span style="color: #0000ff;">string</span>.Format(<span style="color: #800000;">"</span><span style="color: #800000;"> (@{0} {1} {2}) </span><span style="color: #800000;">"</span><span style="color: #000000;">, right.SqlConditions, oper, oldRight) };
</span><span style="color: #008080;">270</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">271</span>             <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (leftType == MemberType.Right &amp;&amp; rightType ==<span style="color: #000000;"> MemberType.Right)
</span><span style="color: #008080;">272</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">273</span>                 <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> ParamInfo { SqlConditions = <span style="color: #0000ff;">string</span>.Format(<span style="color: #800000;">"</span><span style="color: #800000;"> ('{0}' {1} '{2}') </span><span style="color: #800000;">"</span><span style="color: #000000;">, left.SqlConditions, oper, right.SqlConditions) };
</span><span style="color: #008080;">274</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">275</span>             <span style="color: #0000ff;">else</span>
<span style="color: #008080;">276</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">277</span>                 <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> ParamInfo { SqlConditions = <span style="color: #0000ff;">string</span>.Format(<span style="color: #800000;">"</span><span style="color: #800000;"> ({0} {1} {2}) </span><span style="color: #800000;">"</span><span style="color: #000000;">, left.SqlConditions, oper, right.SqlConditions) };
</span><span style="color: #008080;">278</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">279</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">280</span>         <span style="color: #0000ff;">private</span> ParamInfo GetResolveMethodCall(Expression exp, <span style="color: #0000ff;">ref</span> MemberType type, <span style="color: #0000ff;">bool</span><span style="color: #000000;"> isTure)
</span><span style="color: #008080;">281</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">282</span>             MethodCallExpression mce =<span style="color: #000000;"> (MethodCallExpression)exp;
</span><span style="color: #008080;">283</span>             <span style="color: #0000ff;">string</span> methodName =<span style="color: #000000;"> mce.Method.Name;
</span><span style="color: #008080;">284</span>             <span style="color: #0000ff;">if</span> (methodName == <span style="color: #800000;">"</span><span style="color: #800000;">Contains</span><span style="color: #800000;">"</span><span style="color: #000000;">)
</span><span style="color: #008080;">285</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">286</span>                 MemberType leftType =<span style="color: #000000;"> MemberType.None;
</span><span style="color: #008080;">287</span>                 MemberType rightType =<span style="color: #000000;"> MemberType.None;
</span><span style="color: #008080;">288</span>                 <span style="color: #0000ff;">if</span> (mce.Method.DeclaringType != <span style="color: #0000ff;">typeof</span>(<span style="color: #0000ff;">string</span>) &amp;&amp; mce.Method.DeclaringType.GetInterface(<span style="color: #800000;">"</span><span style="color: #800000;">IEnumerable</span><span style="color: #800000;">"</span>) != <span style="color: #0000ff;">null</span><span style="color: #000000;">)
</span><span style="color: #008080;">289</span> <span style="color: #000000;">                {
</span><span style="color: #008080;">290</span>                     <span style="color: #0000ff;">var</span> left = GetResolveAll(mce.Arguments[<span style="color: #800080;">0</span>], <span style="color: #0000ff;">ref</span><span style="color: #000000;"> rightType);
</span><span style="color: #008080;">291</span>                     <span style="color: #0000ff;">var</span> right = GetResolveAll(mce.Object, <span style="color: #0000ff;">ref</span><span style="color: #000000;"> leftType);
</span><span style="color: #008080;">292</span>                     <span style="color: #0000ff;">string</span> oldLeftKey =<span style="color: #000000;"> left.SqlConditions;
</span><span style="color: #008080;">293</span> 
<span style="color: #008080;">294</span>                     <span style="color: #0000ff;">string</span> leftKey = <span style="color: #800000;">"</span><span style="color: #800000;">P</span><span style="color: #800000;">"</span> + ParaIndex +<span style="color: #000000;"> left.SqlConditions;
</span><span style="color: #008080;">295</span>                     ParaIndex++<span style="color: #000000;">;
</span><span style="color: #008080;">296</span>                     <span style="color: #0000ff;">var</span> sqlParameterNames = <span style="color: #800000;">""</span><span style="color: #000000;">;
</span><span style="color: #008080;">297</span>                     <span style="color: #0000ff;">var</span> memberType =<span style="color: #000000;"> MemberType.Right;
</span><span style="color: #008080;">298</span>                     <span style="color: #0000ff;">var</span> list = GetResolveMember(mce.Object <span style="color: #0000ff;">as</span> MemberExpression, <span style="color: #0000ff;">ref</span> memberType).ObjectValue <span style="color: #0000ff;">as</span><span style="color: #000000;"> IEnumerable;
</span><span style="color: #008080;">299</span>                     <span style="color: #0000ff;">var</span> count = <span style="color: #800080;">1</span><span style="color: #000000;">;
</span><span style="color: #008080;">300</span>                     <span style="color: #0000ff;">foreach</span> (<span style="color: #0000ff;">var</span> item <span style="color: #0000ff;">in</span><span style="color: #000000;"> list)
</span><span style="color: #008080;">301</span> <span style="color: #000000;">                    {
</span><span style="color: #008080;">302</span>                         <span style="color: #0000ff;">var</span> parameterName = leftKey +<span style="color: #000000;"> count;
</span><span style="color: #008080;">303</span>                         sqlParameterNames += <span style="color: #800000;">"</span><span style="color: #800000;">,@</span><span style="color: #800000;">"</span> +<span style="color: #000000;"> parameterName;
</span><span style="color: #008080;">304</span>                         <span style="color: #0000ff;">if</span> (item == <span style="color: #0000ff;">null</span><span style="color: #000000;">)
</span><span style="color: #008080;">305</span> <span style="color: #000000;">                        {
</span><span style="color: #008080;">306</span>                             <span style="color: #0000ff;">this</span>._Parameters.Add(DbProvider.MakeParam(_DbConfig, <span style="color: #800000;">"</span><span style="color: #800000;">@</span><span style="color: #800000;">"</span> +<span style="color: #000000;"> parameterName, DBNull.Value));
</span><span style="color: #008080;">307</span> <span style="color: #000000;">                        }
</span><span style="color: #008080;">308</span>                         <span style="color: #0000ff;">else</span>
<span style="color: #008080;">309</span> <span style="color: #000000;">                        {
</span><span style="color: #008080;">310</span>                             <span style="color: #0000ff;">this</span>._Parameters.Add(DbProvider.MakeParam(_DbConfig, <span style="color: #800000;">"</span><span style="color: #800000;">@</span><span style="color: #800000;">"</span> +<span style="color: #000000;"> parameterName, item));
</span><span style="color: #008080;">311</span> <span style="color: #000000;">                        }
</span><span style="color: #008080;">312</span>                         count++<span style="color: #000000;">;
</span><span style="color: #008080;">313</span> <span style="color: #000000;">                    }
</span><span style="color: #008080;">314</span>                     sqlParameterNames = sqlParameterNames.TrimStart(<span style="color: #800000;">'</span><span style="color: #800000;">,</span><span style="color: #800000;">'</span><span style="color: #000000;">);
</span><span style="color: #008080;">315</span>                     <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> ParamInfo { SqlConditions = <span style="color: #0000ff;">string</span>.Format(<span style="color: #800000;">"</span><span style="color: #800000;">({0} {1} IN ({2}))</span><span style="color: #800000;">"</span>, oldLeftKey, isTure == <span style="color: #0000ff;">false</span> ? <span style="color: #800000;">"</span><span style="color: #800000;">  NOT </span><span style="color: #800000;">"</span> : <span style="color: #800000;">""</span><span style="color: #000000;">, sqlParameterNames) };
</span><span style="color: #008080;">316</span> <span style="color: #000000;">                }
</span><span style="color: #008080;">317</span>                 <span style="color: #0000ff;">else</span>
<span style="color: #008080;">318</span> <span style="color: #000000;">                {
</span><span style="color: #008080;">319</span>                     <span style="color: #0000ff;">var</span> left = GetResolveAll(mce.Object, <span style="color: #0000ff;">ref</span><span style="color: #000000;"> leftType);
</span><span style="color: #008080;">320</span>                     <span style="color: #0000ff;">var</span> right = GetResolveAll(mce.Arguments[<span style="color: #800080;">0</span>], <span style="color: #0000ff;">ref</span><span style="color: #000000;"> rightType);
</span><span style="color: #008080;">321</span>                     <span style="color: #0000ff;">var</span> oldLeft = AddParametersReturnLeft(<span style="color: #0000ff;">ref</span><span style="color: #000000;"> left, right);
</span><span style="color: #008080;">322</span>                     <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> ParamInfo { SqlConditions = <span style="color: #0000ff;">string</span>.Format(<span style="color: #800000;">"</span><span style="color: #800000;">({0} {1} LIKE '%'+@{2}+'%')</span><span style="color: #800000;">"</span>, oldLeft, isTure == <span style="color: #0000ff;">false</span> ? <span style="color: #800000;">"</span><span style="color: #800000;">  NOT </span><span style="color: #800000;">"</span> : <span style="color: #800000;">""</span><span style="color: #000000;">, left.SqlConditions) };
</span><span style="color: #008080;">323</span> <span style="color: #000000;">                }
</span><span style="color: #008080;">324</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">325</span>             <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (methodName == <span style="color: #800000;">"</span><span style="color: #800000;">StartsWith</span><span style="color: #800000;">"</span><span style="color: #000000;">)
</span><span style="color: #008080;">326</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">327</span>                 MemberType leftType =<span style="color: #000000;"> MemberType.None;
</span><span style="color: #008080;">328</span>                 MemberType rightType =<span style="color: #000000;"> MemberType.None;
</span><span style="color: #008080;">329</span>                 <span style="color: #0000ff;">var</span> left = GetResolveAll(mce.Object, <span style="color: #0000ff;">ref</span><span style="color: #000000;"> leftType);
</span><span style="color: #008080;">330</span>                 <span style="color: #0000ff;">var</span> right = GetResolveAll(mce.Arguments[<span style="color: #800080;">0</span>], <span style="color: #0000ff;">ref</span><span style="color: #000000;"> rightType);
</span><span style="color: #008080;">331</span>                 <span style="color: #0000ff;">var</span> oldLeft = AddParametersReturnLeft(<span style="color: #0000ff;">ref</span><span style="color: #000000;"> left, right);
</span><span style="color: #008080;">332</span>                 <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> ParamInfo { SqlConditions = <span style="color: #0000ff;">string</span>.Format(<span style="color: #800000;">"</span><span style="color: #800000;">({0} {1} LIKE @{2}+'%')</span><span style="color: #800000;">"</span>, oldLeft, isTure == <span style="color: #0000ff;">false</span> ? <span style="color: #800000;">"</span><span style="color: #800000;">  NOT </span><span style="color: #800000;">"</span> : <span style="color: #800000;">""</span><span style="color: #000000;">, left.SqlConditions) };
</span><span style="color: #008080;">333</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">334</span>             <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (methodName == <span style="color: #800000;">"</span><span style="color: #800000;">EndWith</span><span style="color: #800000;">"</span><span style="color: #000000;">)
</span><span style="color: #008080;">335</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">336</span>                 MemberType leftType =<span style="color: #000000;"> MemberType.None;
</span><span style="color: #008080;">337</span>                 MemberType rightType =<span style="color: #000000;"> MemberType.None;
</span><span style="color: #008080;">338</span>                 <span style="color: #0000ff;">var</span> left = GetResolveAll(mce.Object, <span style="color: #0000ff;">ref</span><span style="color: #000000;"> leftType);
</span><span style="color: #008080;">339</span>                 <span style="color: #0000ff;">var</span> right = GetResolveAll(mce.Arguments[<span style="color: #800080;">0</span>], <span style="color: #0000ff;">ref</span><span style="color: #000000;"> rightType);
</span><span style="color: #008080;">340</span>                 <span style="color: #0000ff;">var</span> oldLeft = AddParametersReturnLeft(<span style="color: #0000ff;">ref</span><span style="color: #000000;"> left, right);
</span><span style="color: #008080;">341</span>                 <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> ParamInfo { SqlConditions = <span style="color: #0000ff;">string</span>.Format(<span style="color: #800000;">"</span><span style="color: #800000;">({0} {1} LIKE '%'+@{2})</span><span style="color: #800000;">"</span>, oldLeft, isTure == <span style="color: #0000ff;">false</span> ? <span style="color: #800000;">"</span><span style="color: #800000;">  NOT </span><span style="color: #800000;">"</span> : <span style="color: #800000;">""</span><span style="color: #000000;">, left.SqlConditions) };
</span><span style="color: #008080;">342</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">343</span>             <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (methodName == <span style="color: #800000;">"</span><span style="color: #800000;">ToString</span><span style="color: #800000;">"</span><span style="color: #000000;">)
</span><span style="color: #008080;">344</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">345</span>                 type =<span style="color: #000000;"> MemberType.Right;
</span><span style="color: #008080;">346</span>                 <span style="color: #0000ff;">return</span> GetResolveAll(mce.Object, <span style="color: #0000ff;">ref</span><span style="color: #000000;"> type);
</span><span style="color: #008080;">347</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">348</span>             <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (methodName.StartsWith(<span style="color: #800000;">"</span><span style="color: #800000;">To</span><span style="color: #800000;">"</span><span style="color: #000000;">))
</span><span style="color: #008080;">349</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">350</span>                 type =<span style="color: #000000;"> MemberType.Right;
</span><span style="color: #008080;">351</span>                 <span style="color: #0000ff;">return</span> GetResolveAll(mce.Arguments[<span style="color: #800080;">0</span>], <span style="color: #0000ff;">ref</span><span style="color: #000000;"> type);
</span><span style="color: #008080;">352</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">353</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> ParamInfo();
</span><span style="color: #008080;">354</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">355</span> 
<span style="color: #008080;">356</span>         <span style="color: #0000ff;">private</span> ParamInfo GetResolveConstant(Expression exp, <span style="color: #0000ff;">ref</span><span style="color: #000000;"> MemberType type)
</span><span style="color: #008080;">357</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">358</span>             type =<span style="color: #000000;"> MemberType.Right;
</span><span style="color: #008080;">359</span>             ConstantExpression ce =<span style="color: #000000;"> ((ConstantExpression)exp);
</span><span style="color: #008080;">360</span>             <span style="color: #0000ff;">if</span> (ce.Value == <span style="color: #0000ff;">null</span><span style="color: #000000;">)
</span><span style="color: #008080;">361</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">362</span>                 <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> ParamInfo();
</span><span style="color: #008080;">363</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">364</span>             <span style="color: #0000ff;">else</span>
<span style="color: #008080;">365</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">366</span>                 <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> ParamInfo { ObjectValue =<span style="color: #000000;"> ce.Value };
</span><span style="color: #008080;">367</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">368</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">369</span>         <span style="color: #0000ff;">private</span> ParamInfo GetResolveUnary(Expression exp, <span style="color: #0000ff;">ref</span><span style="color: #000000;"> MemberType type)
</span><span style="color: #008080;">370</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">371</span>             UnaryExpression ue =<span style="color: #000000;"> ((UnaryExpression)exp);
</span><span style="color: #008080;">372</span>             <span style="color: #0000ff;">var</span> mex =<span style="color: #000000;"> ue.Operand;
</span><span style="color: #008080;">373</span>             <span style="color: #0000ff;">return</span> GetResolveAll(mex, <span style="color: #0000ff;">ref</span> type, <span style="color: #0000ff;">false</span><span style="color: #000000;">);
</span><span style="color: #008080;">374</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">375</span> 
<span style="color: #008080;">376</span>         <span style="color: #0000ff;">private</span><span style="color: #000000;"> ParamInfo GetResolveMemberMethod(MemberExpression exp)
</span><span style="color: #008080;">377</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">378</span>             <span style="color: #0000ff;">var</span> proInfo = exp.Member <span style="color: #0000ff;">as</span><span style="color: #000000;"> System.Reflection.PropertyInfo;
</span><span style="color: #008080;">379</span>             <span style="color: #0000ff;">if</span> (proInfo != <span style="color: #0000ff;">null</span><span style="color: #000000;">)
</span><span style="color: #008080;">380</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">381</span>                 <span style="color: #0000ff;">object</span> dynInv = proInfo.GetValue(<span style="color: #0000ff;">null</span>, <span style="color: #0000ff;">null</span><span style="color: #000000;">);
</span><span style="color: #008080;">382</span>                 <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> ParamInfo { ObjectValue =<span style="color: #000000;"> dynInv };
</span><span style="color: #008080;">383</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">384</span>             <span style="color: #0000ff;">else</span>
<span style="color: #008080;">385</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">386</span>                 <span style="color: #0000ff;">var</span> fieInfo = exp.Member <span style="color: #0000ff;">as</span><span style="color: #000000;"> System.Reflection.FieldInfo;
</span><span style="color: #008080;">387</span>                 <span style="color: #0000ff;">if</span> (fieInfo != <span style="color: #0000ff;">null</span><span style="color: #000000;">)
</span><span style="color: #008080;">388</span> <span style="color: #000000;">                {
</span><span style="color: #008080;">389</span>                     <span style="color: #0000ff;">object</span> dynInv = fieInfo.GetValue(<span style="color: #0000ff;">null</span><span style="color: #000000;">);
</span><span style="color: #008080;">390</span>                     <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> ParamInfo { ObjectValue =<span style="color: #000000;"> dynInv };
</span><span style="color: #008080;">391</span> <span style="color: #000000;">                }
</span><span style="color: #008080;">392</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">393</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> ParamInfo();
</span><span style="color: #008080;">394</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">395</span>         <span style="color: #0000ff;">private</span> ParamInfo GetResolveMemberConstant(MemberExpression exp, <span style="color: #0000ff;">object</span><span style="color: #000000;"> obj)
</span><span style="color: #008080;">396</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">397</span>             <span style="color: #0000ff;">var</span> proInfo = exp.Member <span style="color: #0000ff;">as</span><span style="color: #000000;"> System.Reflection.PropertyInfo;
</span><span style="color: #008080;">398</span>             <span style="color: #0000ff;">if</span> (proInfo != <span style="color: #0000ff;">null</span><span style="color: #000000;">)
</span><span style="color: #008080;">399</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">400</span>                 <span style="color: #0000ff;">var</span> dynInv = proInfo.GetValue(obj, <span style="color: #0000ff;">null</span><span style="color: #000000;">);
</span><span style="color: #008080;">401</span>                 <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> ParamInfo { ObjectValue =<span style="color: #000000;"> dynInv };
</span><span style="color: #008080;">402</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">403</span>             <span style="color: #0000ff;">else</span>
<span style="color: #008080;">404</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">405</span>                 <span style="color: #0000ff;">var</span> fieInfo = exp.Member <span style="color: #0000ff;">as</span><span style="color: #000000;"> System.Reflection.FieldInfo;
</span><span style="color: #008080;">406</span>                 <span style="color: #0000ff;">if</span> (fieInfo != <span style="color: #0000ff;">null</span><span style="color: #000000;">)
</span><span style="color: #008080;">407</span> <span style="color: #000000;">                {
</span><span style="color: #008080;">408</span>                     <span style="color: #0000ff;">var</span> dynInv =<span style="color: #000000;"> fieInfo.GetValue(obj);
</span><span style="color: #008080;">409</span>                     <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> ParamInfo { ObjectValue =<span style="color: #000000;"> dynInv };
</span><span style="color: #008080;">410</span> <span style="color: #000000;">                }
</span><span style="color: #008080;">411</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">412</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> ParamInfo();
</span><span style="color: #008080;">413</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">414</span>         <span style="color: #0000ff;">private</span> ParamInfo GetResolveMember(Expression exp, <span style="color: #0000ff;">ref</span><span style="color: #000000;"> MemberType type)
</span><span style="color: #008080;">415</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">416</span>             MemberExpression me =<span style="color: #000000;"> ((MemberExpression)exp);
</span><span style="color: #008080;">417</span>             <span style="color: #0000ff;">if</span> (me.Expression == <span style="color: #0000ff;">null</span><span style="color: #000000;">)
</span><span style="color: #008080;">418</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">419</span>                 type =<span style="color: #000000;"> MemberType.Right;
</span><span style="color: #008080;">420</span>                 <span style="color: #0000ff;">return</span><span style="color: #000000;"> GetResolveMemberMethod(me);
</span><span style="color: #008080;">421</span> <span style="color: #000000;">            }          
</span><span style="color: #008080;">422</span> 
<span style="color: #008080;">423</span>             <span style="color: #0000ff;">if</span> (me.Expression.NodeType !=<span style="color: #000000;"> ExpressionType.Parameter)
</span><span style="color: #008080;">424</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">425</span>                 type =<span style="color: #000000;"> MemberType.Right;
</span><span style="color: #008080;">426</span>                 <span style="color: #0000ff;">object</span> dynInv = <span style="color: #0000ff;">null</span><span style="color: #000000;">;
</span><span style="color: #008080;">427</span>                 <span style="color: #0000ff;">try</span>
<span style="color: #008080;">428</span> <span style="color: #000000;">                {
</span><span style="color: #008080;">429</span>                     <span style="color: #0000ff;">var</span> conExp = me.Expression <span style="color: #0000ff;">as</span><span style="color: #000000;"> ConstantExpression;
</span><span style="color: #008080;">430</span>                     <span style="color: #0000ff;">if</span> (conExp != <span style="color: #0000ff;">null</span><span style="color: #000000;">)
</span><span style="color: #008080;">431</span> <span style="color: #000000;">                    {
</span><span style="color: #008080;">432</span>                         <span style="color: #0000ff;">return</span><span style="color: #000000;"> GetResolveMemberConstant(me, conExp.Value);
</span><span style="color: #008080;">433</span> <span style="color: #000000;">                    }
</span><span style="color: #008080;">434</span>                     <span style="color: #0000ff;">else</span>
<span style="color: #008080;">435</span> <span style="color: #000000;">                    {
</span><span style="color: #008080;">436</span>                         <span style="color: #0000ff;">var</span> memberInfos = <span style="color: #0000ff;">new</span> Stack&lt;MemberInfo&gt;<span style="color: #000000;">();
</span><span style="color: #008080;">437</span>                         <span style="color: #0000ff;">while</span> (exp <span style="color: #0000ff;">is</span><span style="color: #000000;"> MemberExpression)
</span><span style="color: #008080;">438</span> <span style="color: #000000;">                        {
</span><span style="color: #008080;">439</span>                             <span style="color: #0000ff;">var</span> memberExpr = exp <span style="color: #0000ff;">as</span><span style="color: #000000;"> MemberExpression;
</span><span style="color: #008080;">440</span> <span style="color: #000000;">                            memberInfos.Push(memberExpr.Member);
</span><span style="color: #008080;">441</span>                             exp =<span style="color: #000000;"> memberExpr.Expression;
</span><span style="color: #008080;">442</span> <span style="color: #000000;">                        }
</span><span style="color: #008080;">443</span>                         
<span style="color: #008080;">444</span>                         <span style="color: #0000ff;">var</span> constExpr = exp <span style="color: #0000ff;">as</span><span style="color: #000000;"> ConstantExpression;
</span><span style="color: #008080;">445</span>                         <span style="color: #0000ff;">if</span> (constExpr == <span style="color: #0000ff;">null</span><span style="color: #000000;">)
</span><span style="color: #008080;">446</span> <span style="color: #000000;">                        {
</span><span style="color: #008080;">447</span>                             <span style="color: #0000ff;">var</span> member = exp <span style="color: #0000ff;">as</span><span style="color: #000000;"> MemberExpression;
</span><span style="color: #008080;">448</span>                             <span style="color: #0000ff;">if</span> (member == <span style="color: #0000ff;">null</span><span style="color: #000000;">)
</span><span style="color: #008080;">449</span> <span style="color: #000000;">                            {
</span><span style="color: #008080;">450</span>                                 <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> Exception(<span style="color: #800000;">"</span><span style="color: #800000;">不支持的子表达式</span><span style="color: #800000;">"</span> +<span style="color: #000000;"> me.Member.Name);
</span><span style="color: #008080;">451</span> <span style="color: #000000;">                            }
</span><span style="color: #008080;">452</span>                             <span style="color: #0000ff;">return</span><span style="color: #000000;"> GetResolveMemberMethod(member);
</span><span style="color: #008080;">453</span> <span style="color: #000000;">                        }
</span><span style="color: #008080;">454</span>                         <span style="color: #0000ff;">var</span> objReference =<span style="color: #000000;"> constExpr.Value;
</span><span style="color: #008080;">455</span> 
<span style="color: #008080;">456</span>                         <span style="color: #0000ff;">while</span> (memberInfos.Count &gt; <span style="color: #800080;">0</span><span style="color: #000000;">)  
</span><span style="color: #008080;">457</span> <span style="color: #000000;">                        {
</span><span style="color: #008080;">458</span>                             <span style="color: #0000ff;">var</span> mi =<span style="color: #000000;"> memberInfos.Pop();
</span><span style="color: #008080;">459</span>                             <span style="color: #0000ff;">if</span> (mi.MemberType ==<span style="color: #000000;"> MemberTypes.Property)
</span><span style="color: #008080;">460</span> <span style="color: #000000;">                            {
</span><span style="color: #008080;">461</span>                                 objReference = objReference.GetType().GetProperty(mi.Name).GetValue(objReference, <span style="color: #0000ff;">null</span><span style="color: #000000;">);
</span><span style="color: #008080;">462</span> <span style="color: #000000;">                            }
</span><span style="color: #008080;">463</span>                             <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (mi.MemberType ==<span style="color: #000000;"> MemberTypes.Field)
</span><span style="color: #008080;">464</span> <span style="color: #000000;">                            {
</span><span style="color: #008080;">465</span>                                 objReference =<span style="color: #000000;"> objReference.GetType().GetField(mi.Name).GetValue(objReference);
</span><span style="color: #008080;">466</span> <span style="color: #000000;">                            }
</span><span style="color: #008080;">467</span> <span style="color: #000000;">                        }
</span><span style="color: #008080;">468</span>                         dynInv =<span style="color: #000000;"> objReference;
</span><span style="color: #008080;">469</span> <span style="color: #000000;">                    }
</span><span style="color: #008080;">470</span> <span style="color: #000000;">                }
</span><span style="color: #008080;">471</span>                 <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception ex)
</span><span style="color: #008080;">472</span> <span style="color: #000000;">                {
</span><span style="color: #008080;">473</span>                     <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> Exception(<span style="color: #800000;">"</span><span style="color: #800000;">表达式解析出错(</span><span style="color: #800000;">"</span> + me.NodeType.ToString() + <span style="color: #800000;">"</span><span style="color: #800000;">):</span><span style="color: #800000;">"</span> +<span style="color: #000000;"> ex.Message);
</span><span style="color: #008080;">474</span> <span style="color: #000000;">                }
</span><span style="color: #008080;">475</span> 
<span style="color: #008080;">476</span>                 <span style="color: #0000ff;">if</span> (dynInv == <span style="color: #0000ff;">null</span><span style="color: #000000;">)
</span><span style="color: #008080;">477</span> <span style="color: #000000;">                {
</span><span style="color: #008080;">478</span>                     <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> ParamInfo();
</span><span style="color: #008080;">479</span> <span style="color: #000000;">                }
</span><span style="color: #008080;">480</span>                 <span style="color: #0000ff;">else</span>
<span style="color: #008080;">481</span> <span style="color: #000000;">                {
</span><span style="color: #008080;">482</span>                     <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> ParamInfo { ObjectValue =<span style="color: #000000;"> dynInv };
</span><span style="color: #008080;">483</span> <span style="color: #000000;">                }
</span><span style="color: #008080;">484</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">485</span>             <span style="color: #0000ff;">else</span>
<span style="color: #008080;">486</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">487</span>                 <span style="color: #0000ff;">string</span> name =<span style="color: #000000;"> me.Member.Name;
</span><span style="color: #008080;">488</span>                 type =<span style="color: #000000;"> MemberType.Left;
</span><span style="color: #008080;">489</span>                 <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> ParamInfo { SqlConditions =<span style="color: #000000;"> name };
</span><span style="color: #008080;">490</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">491</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">492</span> 
<span style="color: #008080;">493</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">494</span> 
<span style="color: #008080;">495</span> }</pre>
</div>
<p>&nbsp;</p>
<p>测试代码如下：</p>
<div class="cnblogs_code">
<pre><code><span style="color: #008080;"> 1</span> <span style="color: #000000;">[TestMethod]
</span><span style="color: #008080;"> 2</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> TestSqlLmdResolve()
</span><span style="color: #008080;"> 3</span> <span style="color: #000000;">{
</span><span style="color: #008080;"> 4</span>     <span style="color: #008000;">//</span><span style="color: #008000;">ORM数据映射</span>
<span style="color: #008080;"> 5</span>     DbConfig.UseDefaultConfig(<span style="color: #0000ff;">new</span><span style="color: #000000;"> TModelDbConfig(GetDbPath()));
</span><span style="color: #008080;"> 6</span> 
<span style="color: #008080;"> 7</span> 
<span style="color: #008080;"> 8</span>     <span style="color: #0000ff;">var</span> <span style="color: #0000ff;">where</span> = GetSqlWhere&lt;cms_category&gt;(m =&gt; m.enabled &amp;&amp; m.name == <span style="color: #800000;">"</span><span style="color: #800000;">test</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 9</span>     Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">LmdSql1:</span><span style="color: #800000;">"</span> + <span style="color: #0000ff;">where</span><span style="color: #000000;">);
</span><span style="color: #008080;">10</span>     <span style="color: #0000ff;">where</span> = GetSqlWhere&lt;cms_category&gt;(m =&gt; !m.enabled &amp;&amp; m.name.Contains(<span style="color: #800000;">"</span><span style="color: #800000;">test</span><span style="color: #800000;">"</span>) &amp;&amp;<span style="color: #000000;"> m.enabled);
</span><span style="color: #008080;">11</span>     Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">LmdSql2:</span><span style="color: #800000;">"</span> + <span style="color: #0000ff;">where</span><span style="color: #000000;">);
</span><span style="color: #008080;">12</span> 
<span style="color: #008080;">13</span>     <span style="color: #008000;">//</span><span style="color: #008000;">条件优先级</span>
<span style="color: #008080;">14</span>     <span style="color: #0000ff;">where</span> = GetSqlWhere&lt;cms_category&gt;(m =&gt; (!m.enabled &amp;&amp; m.name.Contains(<span style="color: #800000;">"</span><span style="color: #800000;">test</span><span style="color: #800000;">"</span>) &amp;&amp; m.enabled) || m.name.StartsWith(<span style="color: #800000;">"</span><span style="color: #800000;">test</span><span style="color: #800000;">"</span><span style="color: #000000;">));
</span><span style="color: #008080;">15</span>     Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">LmdSql3:</span><span style="color: #800000;">"</span> + <span style="color: #0000ff;">where</span><span style="color: #000000;">);
</span><span style="color: #008080;">16</span>     <span style="color: #0000ff;">where</span> = GetSqlWhere&lt;cms_category&gt;(m =&gt; (m.enabled &amp;&amp; m.name.Contains(<span style="color: #800000;">"</span><span style="color: #800000;">test</span><span style="color: #800000;">"</span>) &amp;&amp; m.enabled) || (m.name.StartsWith(<span style="color: #800000;">"</span><span style="color: #800000;">test</span><span style="color: #800000;">"</span>) &amp;&amp; !m.isused &amp;&amp;<span style="color: #000000;"> m.isused));
</span><span style="color: #008080;">17</span> 
<span style="color: #008080;">18</span>     <span style="color: #008000;">//</span><span style="color: #008000;">其他判断</span>
<span style="color: #008080;">19</span>     Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">LmdSql4:</span><span style="color: #800000;">"</span> + <span style="color: #0000ff;">where</span><span style="color: #000000;">);
</span><span style="color: #008080;">20</span>     <span style="color: #0000ff;">where</span> = GetSqlWhere&lt;cms_category&gt;(m =&gt; !m.enabled &amp;&amp; m.name.Contains(<span style="color: #800000;">"</span><span style="color: #800000;">test</span><span style="color: #800000;">"</span>) &amp;&amp; !<span style="color: #000000;">m.enabled);
</span><span style="color: #008080;">21</span>     Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">LmdSql5:</span><span style="color: #800000;">"</span> + <span style="color: #0000ff;">where</span><span style="color: #000000;">);
</span><span style="color: #008080;">22</span>     <span style="color: #0000ff;">where</span> = GetSqlWhere&lt;cms_category&gt;(m =&gt; !m.enabled &amp;&amp; m.name.Contains(<span style="color: #800000;">"</span><span style="color: #800000;">test</span><span style="color: #800000;">"</span>) &amp;&amp; m.enabled == <span style="color: #0000ff;">true</span><span style="color: #000000;">);
</span><span style="color: #008080;">23</span>     Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">LmdSql6:</span><span style="color: #800000;">"</span> + <span style="color: #0000ff;">where</span><span style="color: #000000;">);
</span><span style="color: #008080;">24</span>     <span style="color: #0000ff;">where</span> = GetSqlWhere&lt;cms_category&gt;(m =&gt; m.name.Contains(<span style="color: #800000;">"</span><span style="color: #800000;">test</span><span style="color: #800000;">"</span>) &amp;&amp; m.enabled || m.name.StartsWith(<span style="color: #800000;">"</span><span style="color: #800000;">test</span><span style="color: #800000;">"</span><span style="color: #000000;">));
</span><span style="color: #008080;">25</span>     Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">LmdSql7:</span><span style="color: #800000;">"</span> + <span style="color: #0000ff;">where</span><span style="color: #000000;">);
</span><span style="color: #008080;">26</span>     <span style="color: #0000ff;">where</span> = GetSqlWhere&lt;cms_category&gt;(m =&gt;<span style="color: #000000;"> m.enabled);
</span><span style="color: #008080;">27</span>     Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">LmdSql8:</span><span style="color: #800000;">"</span> + <span style="color: #0000ff;">where</span><span style="color: #000000;">);
</span><span style="color: #008080;">28</span>     <span style="color: #0000ff;">where</span> = GetSqlWhere&lt;cms_category&gt;(m =&gt; !<span style="color: #000000;">m.enabled);
</span><span style="color: #008080;">29</span>     Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">LmdSql9:</span><span style="color: #800000;">"</span> + <span style="color: #0000ff;">where</span><span style="color: #000000;">);
</span><span style="color: #008080;">30</span>     <span style="color: #0000ff;">where</span> = GetSqlWhere&lt;cms_category&gt;(m =&gt; m.name.StartsWith(<span style="color: #800000;">"</span><span style="color: #800000;">test</span><span style="color: #800000;">"</span><span style="color: #000000;">));
</span><span style="color: #008080;">31</span>     Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">LmdSql10:</span><span style="color: #800000;">"</span> + <span style="color: #0000ff;">where</span><span style="color: #000000;">);
</span><span style="color: #008080;">32</span>     <span style="color: #0000ff;">where</span> = GetSqlWhere&lt;cms_category&gt;(m =&gt; !m.name.StartsWith(<span style="color: #800000;">"</span><span style="color: #800000;">test</span><span style="color: #800000;">"</span><span style="color: #000000;">));
</span><span style="color: #008080;">33</span>     Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">LmdSql11:</span><span style="color: #800000;">"</span> + <span style="color: #0000ff;">where</span><span style="color: #000000;">);
</span><span style="color: #008080;">34</span>     <span style="color: #0000ff;">where</span> = GetSqlWhere&lt;cms_category&gt;(m =&gt; m.name.StartsWith(<span style="color: #800000;">"</span><span style="color: #800000;">test</span><span style="color: #800000;">"</span>) || m.name.Contains(<span style="color: #800000;">"</span><span style="color: #800000;">test</span><span style="color: #800000;">"</span><span style="color: #000000;">));
</span><span style="color: #008080;">35</span>     Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">LmdSql12:</span><span style="color: #800000;">"</span> + <span style="color: #0000ff;">where</span><span style="color: #000000;">);
</span><span style="color: #008080;">36</span> 
<span style="color: #008080;">37</span>     <span style="color: #008000;">//</span><span style="color: #008000;">条件判断是否前包含，判断常量相等，多层判断</span>
<span style="color: #008080;">38</span>     <span style="color: #0000ff;">var</span> extend = <span style="color: #0000ff;">new</span><span style="color: #000000;"> cms_category_extend();
</span><span style="color: #008080;">39</span>     extend.mytest2 = <span style="color: #0000ff;">new</span><span style="color: #000000;"> cms_category_extend();
</span><span style="color: #008080;">40</span>     extend.mytest2.mytest1 = <span style="color: #0000ff;">new</span> cms_category { name = <span style="color: #800000;">"</span><span style="color: #800000;">hehhe</span><span style="color: #800000;">"</span><span style="color: #000000;"> };
</span><span style="color: #008080;">41</span>     <span style="color: #0000ff;">where</span> = GetSqlWhere&lt;cms_category&gt;(m =&gt; m.name.StartsWith(<span style="color: #800000;">"</span><span style="color: #800000;">test</span><span style="color: #800000;">"</span>) || m.name == cms_category.TestConst ||
<span style="color: #008080;">42</span>         m.name ==<span style="color: #000000;"> extend.mytest2.mytest1.name);
</span><span style="color: #008080;">43</span>     Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">LmdSql13:</span><span style="color: #800000;">"</span> + <span style="color: #0000ff;">where</span><span style="color: #000000;">);
</span><span style="color: #008080;">44</span> 
<span style="color: #008080;">45</span>     <span style="color: #008000;">//</span><span style="color: #008000;">判断列表包含</span>
<span style="color: #008080;">46</span>     <span style="color: #0000ff;">var</span> list = <span style="color: #0000ff;">new</span> List&lt;<span style="color: #0000ff;">string</span>&gt; { <span style="color: #800000;">"</span><span style="color: #800000;">a</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">b</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">c</span><span style="color: #800000;">"</span><span style="color: #000000;"> };
</span><span style="color: #008080;">47</span>     <span style="color: #0000ff;">where</span> = GetSqlWhere&lt;cms_category&gt;(m =&gt;<span style="color: #000000;"> list.Contains(m.name));
</span><span style="color: #008080;">48</span>     Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">LmdSql14:</span><span style="color: #800000;">"</span> + <span style="color: #0000ff;">where</span><span style="color: #000000;">);
</span><span style="color: #008080;">49</span> 
<span style="color: #008080;">50</span>     <span style="color: #0000ff;">object</span> testName = <span style="color: #800000;">"</span><span style="color: #800000;">test</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">51</span>     <span style="color: #0000ff;">where</span> = GetSqlWhere&lt;cms_category&gt;(m =&gt; m.enabled &amp;&amp; m.name == (<span style="color: #0000ff;">string</span><span style="color: #000000;">)testName);
</span><span style="color: #008080;">52</span>     Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">LmdSql15:</span><span style="color: #800000;">"</span> + <span style="color: #0000ff;">where</span><span style="color: #000000;">);
</span><span style="color: #008080;">53</span>     <span style="color: #0000ff;">object</span> testParent_id = <span style="color: #800080;">1</span><span style="color: #000000;">;
</span><span style="color: #008080;">54</span>     <span style="color: #008000;">//</span><span style="color: #008000;">枚举判断</span>
<span style="color: #008080;">55</span>     <span style="color: #0000ff;">where</span> = GetSqlWhere&lt;cms_category&gt;(m =&gt; (m.id == (<span style="color: #0000ff;">int</span>)testParent_id) || (m.enabled &amp;&amp; m.parent_id ==<span style="color: #000000;"> Status.Success));
</span><span style="color: #008080;">56</span>     Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">LmdSql16:</span><span style="color: #800000;">"</span> + <span style="color: #0000ff;">where</span><span style="color: #000000;">);
</span><span style="color: #008080;">57</span> 
<span style="color: #008080;">58</span>     <span style="color: #008000;">//</span><span style="color: #008000;">静态字段判断</span>
<span style="color: #008080;">59</span>     <span style="color: #0000ff;">where</span> = GetSqlWhere&lt;cms_category&gt;(m =&gt; m.name ==<span style="color: #000000;"> cms_category.TestStatic);
</span><span style="color: #008080;">60</span>     Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">LmdSql17:</span><span style="color: #800000;">"</span> + <span style="color: #0000ff;">where</span><span style="color: #000000;">);
</span><span style="color: #008080;">61</span> <span style="color: #000000;">}
</span><span style="color: #008080;">62</span> 
<span style="color: #008080;">63</span> <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">string</span> GetSqlWhere&lt;T&gt;(Expression&lt;Func&lt;T, <span style="color: #0000ff;">bool</span>&gt;&gt;<span style="color: #000000;"> expression)
</span><span style="color: #008080;">64</span> <span style="color: #000000;">{
</span><span style="color: #008080;">65</span>     SqlLmdResolver exp = <span style="color: #0000ff;">new</span><span style="color: #000000;"> SqlLmdResolver();
</span><span style="color: #008080;">66</span> <span style="color: #000000;">    exp.ResolveExpression(expression);
</span><span style="color: #008080;">67</span>     <span style="color: #0000ff;">return</span> exp.SqlWhere + <span style="color: #800000;">"</span><span style="color: #800000;">\r\n</span><span style="color: #800000;">"</span> + <span style="color: #0000ff;">string</span>.Join(<span style="color: #800000;">"</span><span style="color: #800000;">,</span><span style="color: #800000;">"</span>, exp.Parameters.Select(m =&gt; m.ParameterName + <span style="color: #800000;">"</span><span style="color: #800000;">:</span><span style="color: #800000;">"</span> +<span style="color: #000000;"> m.Value.ToString()));
</span><span style="color: #008080;">68</span> }</pre>
</div>
<p>&nbsp;</p>
<p>成品测试如下：</p>
<div class="cnblogs_code">
<pre><code><span style="color: #008080;">  1</span> <span style="color: #0000ff;">using</span><span style="color: #000000;"> System;
</span><span style="color: #008080;">  2</span> <span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Collections.Generic;
</span><span style="color: #008080;">  3</span> <span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Collections.Concurrent;
</span><span style="color: #008080;">  4</span> <span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Linq;
</span><span style="color: #008080;">  5</span> <span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Text;
</span><span style="color: #008080;">  6</span> <span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Data;
</span><span style="color: #008080;">  7</span> <span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Data.Common;
</span><span style="color: #008080;">  8</span> <span style="color: #0000ff;">using</span><span style="color: #000000;"> Microsoft.VisualStudio.TestTools.UnitTesting;
</span><span style="color: #008080;">  9</span> 
<span style="color: #008080;"> 10</span> <span style="color: #0000ff;">using</span><span style="color: #000000;"> Util.Database;
</span><span style="color: #008080;"> 11</span> <span style="color: #0000ff;">using</span><span style="color: #000000;"> Util.EntityMapping;
</span><span style="color: #008080;"> 12</span> <span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Linq.Expressions;
</span><span style="color: #008080;"> 13</span> <span style="color: #0000ff;">namespace</span><span style="color: #000000;"> Util.UnitTest
</span><span style="color: #008080;"> 14</span> <span style="color: #000000;">{
</span><span style="color: #008080;"> 15</span> <span style="color: #000000;">    [TestClass]
</span><span style="color: #008080;"> 16</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> TestDatabase_Unit
</span><span style="color: #008080;"> 17</span> <span style="color: #000000;">    {
</span><span style="color: #008080;"> 18</span> 
<span style="color: #008080;"> 19</span>         <span style="color: #0000ff;">#region</span> lmd生成sql条件测试
<span style="color: #008080;"> 20</span> 
<span style="color: #008080;"> 21</span>         
<span style="color: #008080;"> 22</span> <span style="color: #000000;">        [TestMethod]
</span><span style="color: #008080;"> 23</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> TestSqlLmdResolve()
</span><span style="color: #008080;"> 24</span> <span style="color: #000000;">        {
</span><span style="color: #008080;"> 25</span>             <span style="color: #008000;">//</span><span style="color: #008000;">ORM数据映射</span>
<span style="color: #008080;"> 26</span>             DbConfig.UseDefaultConfig(<span style="color: #0000ff;">new</span><span style="color: #000000;"> TModelDbConfig(GetDbPath()));
</span><span style="color: #008080;"> 27</span> 
<span style="color: #008080;"> 28</span> 
<span style="color: #008080;"> 29</span>             <span style="color: #0000ff;">var</span> <span style="color: #0000ff;">where</span> = GetSqlWhere&lt;cms_category&gt;(m =&gt; m.enabled &amp;&amp; m.name == <span style="color: #800000;">"</span><span style="color: #800000;">test</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 30</span>             Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">LmdSql1:</span><span style="color: #800000;">"</span> + <span style="color: #0000ff;">where</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 31</span>             <span style="color: #0000ff;">where</span> = GetSqlWhere&lt;cms_category&gt;(m =&gt; !m.enabled &amp;&amp; m.name.Contains(<span style="color: #800000;">"</span><span style="color: #800000;">test</span><span style="color: #800000;">"</span>) &amp;&amp;<span style="color: #000000;"> m.enabled);
</span><span style="color: #008080;"> 32</span>             Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">LmdSql2:</span><span style="color: #800000;">"</span> + <span style="color: #0000ff;">where</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 33</span> 
<span style="color: #008080;"> 34</span>             <span style="color: #008000;">//</span><span style="color: #008000;">条件优先级</span>
<span style="color: #008080;"> 35</span>             <span style="color: #0000ff;">where</span> = GetSqlWhere&lt;cms_category&gt;(m =&gt; (!m.enabled &amp;&amp; m.name.Contains(<span style="color: #800000;">"</span><span style="color: #800000;">test</span><span style="color: #800000;">"</span>) &amp;&amp; m.enabled) || m.name.StartsWith(<span style="color: #800000;">"</span><span style="color: #800000;">test</span><span style="color: #800000;">"</span><span style="color: #000000;">));
</span><span style="color: #008080;"> 36</span>             Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">LmdSql3:</span><span style="color: #800000;">"</span> + <span style="color: #0000ff;">where</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 37</span>             <span style="color: #0000ff;">where</span> = GetSqlWhere&lt;cms_category&gt;(m =&gt; (m.enabled &amp;&amp; m.name.Contains(<span style="color: #800000;">"</span><span style="color: #800000;">test</span><span style="color: #800000;">"</span>) &amp;&amp; m.enabled) || (m.name.StartsWith(<span style="color: #800000;">"</span><span style="color: #800000;">test</span><span style="color: #800000;">"</span>) &amp;&amp; !m.isused &amp;&amp;<span style="color: #000000;"> m.isused));
</span><span style="color: #008080;"> 38</span> 
<span style="color: #008080;"> 39</span>             <span style="color: #008000;">//</span><span style="color: #008000;">其他判断</span>
<span style="color: #008080;"> 40</span>             Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">LmdSql4:</span><span style="color: #800000;">"</span> + <span style="color: #0000ff;">where</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 41</span>             <span style="color: #0000ff;">where</span> = GetSqlWhere&lt;cms_category&gt;(m =&gt; !m.enabled &amp;&amp; m.name.Contains(<span style="color: #800000;">"</span><span style="color: #800000;">test</span><span style="color: #800000;">"</span>) &amp;&amp; !<span style="color: #000000;">m.enabled);
</span><span style="color: #008080;"> 42</span>             Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">LmdSql5:</span><span style="color: #800000;">"</span> + <span style="color: #0000ff;">where</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 43</span>             <span style="color: #0000ff;">where</span> = GetSqlWhere&lt;cms_category&gt;(m =&gt; !m.enabled &amp;&amp; m.name.Contains(<span style="color: #800000;">"</span><span style="color: #800000;">test</span><span style="color: #800000;">"</span>) &amp;&amp; m.enabled == <span style="color: #0000ff;">true</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 44</span>             Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">LmdSql6:</span><span style="color: #800000;">"</span> + <span style="color: #0000ff;">where</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 45</span>             <span style="color: #0000ff;">where</span> = GetSqlWhere&lt;cms_category&gt;(m =&gt; m.name.Contains(<span style="color: #800000;">"</span><span style="color: #800000;">test</span><span style="color: #800000;">"</span>) &amp;&amp; m.enabled || m.name.StartsWith(<span style="color: #800000;">"</span><span style="color: #800000;">test</span><span style="color: #800000;">"</span><span style="color: #000000;">));
</span><span style="color: #008080;"> 46</span>             Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">LmdSql7:</span><span style="color: #800000;">"</span> + <span style="color: #0000ff;">where</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 47</span>             <span style="color: #0000ff;">where</span> = GetSqlWhere&lt;cms_category&gt;(m =&gt;<span style="color: #000000;"> m.enabled);
</span><span style="color: #008080;"> 48</span>             Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">LmdSql8:</span><span style="color: #800000;">"</span> + <span style="color: #0000ff;">where</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 49</span>             <span style="color: #0000ff;">where</span> = GetSqlWhere&lt;cms_category&gt;(m =&gt; !<span style="color: #000000;">m.enabled);
</span><span style="color: #008080;"> 50</span>             Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">LmdSql9:</span><span style="color: #800000;">"</span> + <span style="color: #0000ff;">where</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 51</span>             <span style="color: #0000ff;">where</span> = GetSqlWhere&lt;cms_category&gt;(m =&gt; m.name.StartsWith(<span style="color: #800000;">"</span><span style="color: #800000;">test</span><span style="color: #800000;">"</span><span style="color: #000000;">));
</span><span style="color: #008080;"> 52</span>             Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">LmdSql10:</span><span style="color: #800000;">"</span> + <span style="color: #0000ff;">where</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 53</span>             <span style="color: #0000ff;">where</span> = GetSqlWhere&lt;cms_category&gt;(m =&gt; !m.name.StartsWith(<span style="color: #800000;">"</span><span style="color: #800000;">test</span><span style="color: #800000;">"</span><span style="color: #000000;">));
</span><span style="color: #008080;"> 54</span>             Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">LmdSql11:</span><span style="color: #800000;">"</span> + <span style="color: #0000ff;">where</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 55</span>             <span style="color: #0000ff;">where</span> = GetSqlWhere&lt;cms_category&gt;(m =&gt; m.name.StartsWith(<span style="color: #800000;">"</span><span style="color: #800000;">test</span><span style="color: #800000;">"</span>) || m.name.Contains(<span style="color: #800000;">"</span><span style="color: #800000;">test</span><span style="color: #800000;">"</span><span style="color: #000000;">));
</span><span style="color: #008080;"> 56</span>             Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">LmdSql12:</span><span style="color: #800000;">"</span> + <span style="color: #0000ff;">where</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 57</span> 
<span style="color: #008080;"> 58</span>             <span style="color: #008000;">//</span><span style="color: #008000;">条件判断是否前包含，判断常量相等，多层判断</span>
<span style="color: #008080;"> 59</span>             <span style="color: #0000ff;">var</span> extend = <span style="color: #0000ff;">new</span><span style="color: #000000;"> cms_category_extend();
</span><span style="color: #008080;"> 60</span>             extend.mytest2 = <span style="color: #0000ff;">new</span><span style="color: #000000;"> cms_category_extend();
</span><span style="color: #008080;"> 61</span>             extend.mytest2.mytest1 = <span style="color: #0000ff;">new</span> cms_category { name = <span style="color: #800000;">"</span><span style="color: #800000;">hehhe</span><span style="color: #800000;">"</span><span style="color: #000000;"> };
</span><span style="color: #008080;"> 62</span>             <span style="color: #0000ff;">where</span> = GetSqlWhere&lt;cms_category&gt;(m =&gt; m.name.StartsWith(<span style="color: #800000;">"</span><span style="color: #800000;">test</span><span style="color: #800000;">"</span>) || m.name == cms_category.TestConst ||
<span style="color: #008080;"> 63</span>                 m.name ==<span style="color: #000000;"> extend.mytest2.mytest1.name);
</span><span style="color: #008080;"> 64</span>             Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">LmdSql13:</span><span style="color: #800000;">"</span> + <span style="color: #0000ff;">where</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 65</span> 
<span style="color: #008080;"> 66</span>             <span style="color: #008000;">//</span><span style="color: #008000;">判断列表包含</span>
<span style="color: #008080;"> 67</span>             <span style="color: #0000ff;">var</span> list = <span style="color: #0000ff;">new</span> List&lt;<span style="color: #0000ff;">string</span>&gt; { <span style="color: #800000;">"</span><span style="color: #800000;">a</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">b</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">c</span><span style="color: #800000;">"</span><span style="color: #000000;"> };
</span><span style="color: #008080;"> 68</span>             <span style="color: #0000ff;">where</span> = GetSqlWhere&lt;cms_category&gt;(m =&gt;<span style="color: #000000;"> list.Contains(m.name));
</span><span style="color: #008080;"> 69</span>             Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">LmdSql14:</span><span style="color: #800000;">"</span> + <span style="color: #0000ff;">where</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 70</span> 
<span style="color: #008080;"> 71</span>             <span style="color: #0000ff;">object</span> testName = <span style="color: #800000;">"</span><span style="color: #800000;">test</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 72</span>             <span style="color: #0000ff;">where</span> = GetSqlWhere&lt;cms_category&gt;(m =&gt; m.enabled &amp;&amp; m.name == (<span style="color: #0000ff;">string</span><span style="color: #000000;">)testName);
</span><span style="color: #008080;"> 73</span>             Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">LmdSql15:</span><span style="color: #800000;">"</span> + <span style="color: #0000ff;">where</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 74</span>             <span style="color: #0000ff;">object</span> testParent_id = <span style="color: #800080;">1</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 75</span>             <span style="color: #008000;">//</span><span style="color: #008000;">枚举判断</span>
<span style="color: #008080;"> 76</span>             <span style="color: #0000ff;">where</span> = GetSqlWhere&lt;cms_category&gt;(m =&gt; (m.id == (<span style="color: #0000ff;">int</span>)testParent_id) || (m.enabled &amp;&amp; m.parent_id ==<span style="color: #000000;"> Status.Success));
</span><span style="color: #008080;"> 77</span>             Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">LmdSql16:</span><span style="color: #800000;">"</span> + <span style="color: #0000ff;">where</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 78</span> 
<span style="color: #008080;"> 79</span>             <span style="color: #008000;">//</span><span style="color: #008000;">静态字段判断</span>
<span style="color: #008080;"> 80</span>             <span style="color: #0000ff;">where</span> = GetSqlWhere&lt;cms_category&gt;(m =&gt; m.name ==<span style="color: #000000;"> cms_category.TestStatic);
</span><span style="color: #008080;"> 81</span>             Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">LmdSql17:</span><span style="color: #800000;">"</span> + <span style="color: #0000ff;">where</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 82</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 83</span> 
<span style="color: #008080;"> 84</span>         <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">string</span> GetSqlWhere&lt;T&gt;(Expression&lt;Func&lt;T, <span style="color: #0000ff;">bool</span>&gt;&gt;<span style="color: #000000;"> expression)
</span><span style="color: #008080;"> 85</span> <span style="color: #000000;">        {
</span><span style="color: #008080;"> 86</span>             SqlLmdResolver exp = <span style="color: #0000ff;">new</span><span style="color: #000000;"> SqlLmdResolver();
</span><span style="color: #008080;"> 87</span> <span style="color: #000000;">            exp.ResolveExpression(expression);
</span><span style="color: #008080;"> 88</span>             <span style="color: #0000ff;">return</span> exp.SqlWhere + <span style="color: #800000;">"</span><span style="color: #800000;">\r\n</span><span style="color: #800000;">"</span> + <span style="color: #0000ff;">string</span>.Join(<span style="color: #800000;">"</span><span style="color: #800000;">,</span><span style="color: #800000;">"</span>, exp.Parameters.Select(m =&gt; m.ParameterName + <span style="color: #800000;">"</span><span style="color: #800000;">:</span><span style="color: #800000;">"</span> +<span style="color: #000000;"> m.Value.ToString()));
</span><span style="color: #008080;"> 89</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 90</span> 
<span style="color: #008080;"> 91</span> 
<span style="color: #008080;"> 92</span>         <span style="color: #0000ff;">#endregion</span>
<span style="color: #008080;"> 93</span>         
<span style="color: #008080;"> 94</span>         <span style="color: #0000ff;">#region</span> access orm测试
<span style="color: #008080;"> 95</span> 
<span style="color: #008080;"> 96</span>         <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">string</span><span style="color: #000000;"> GetDbPath()
</span><span style="color: #008080;"> 97</span> <span style="color: #000000;">        {
</span><span style="color: #008080;"> 98</span>             <span style="color: #0000ff;">var</span> path =<span style="color: #000000;"> AppDomain.CurrentDomain.BaseDirectory;
</span><span style="color: #008080;"> 99</span>             <span style="color: #0000ff;">if</span> (path.EndsWith(<span style="color: #800000;">"</span><span style="color: #800000;">debug</span><span style="color: #800000;">"</span><span style="color: #000000;">, StringComparison.OrdinalIgnoreCase))
</span><span style="color: #008080;">100</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">101</span>                 path = path.Substring(<span style="color: #800080;">0</span>, path.LastIndexOf(<span style="color: #800000;">'</span><span style="color: #800000;">\\</span><span style="color: #800000;">'</span><span style="color: #000000;">));
</span><span style="color: #008080;">102</span>                 path = path.Substring(<span style="color: #800080;">0</span>, path.LastIndexOf(<span style="color: #800000;">'</span><span style="color: #800000;">\\</span><span style="color: #800000;">'</span><span style="color: #000000;">));
</span><span style="color: #008080;">103</span>                 path = path.Substring(<span style="color: #800080;">0</span>, path.LastIndexOf(<span style="color: #800000;">'</span><span style="color: #800000;">\\</span><span style="color: #800000;">'</span><span style="color: #000000;">));
</span><span style="color: #008080;">104</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">105</span>             path = path.TrimEnd(<span style="color: #800000;">'</span><span style="color: #800000;">\\</span><span style="color: #800000;">'</span>) + <span style="color: #800000;">@"</span><span style="color: #800000;">\DataBase</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">106</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> path;
</span><span style="color: #008080;">107</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">108</span> <span style="color: #000000;">        [TestMethod]
</span><span style="color: #008080;">109</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> TestDbConfig()
</span><span style="color: #008080;">110</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">111</span>             <span style="color: #008000;">//</span><span style="color: #008000;">初始化配置</span>
<span style="color: #008080;">112</span>             DbConfig.UseDefaultConfig(<span style="color: #0000ff;">new</span><span style="color: #000000;"> TModelDbConfig(GetDbPath()));
</span><span style="color: #008080;">113</span> 
<span style="color: #008080;">114</span>             <span style="color: #008000;">//</span><span style="color: #008000;">T4模版获取数据库信息</span>
<span style="color: #008080;">115</span>             List&lt;TableInfo&gt; list =<span style="color: #000000;"> DbFactory.GetShemaTables();
</span><span style="color: #008080;">116</span> <span style="color: #000000;">            Console.WriteLine(list.Count.ToString());
</span><span style="color: #008080;">117</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">118</span> 
<span style="color: #008080;">119</span> 
<span style="color: #008080;">120</span> <span style="color: #000000;">        [TestMethod]
</span><span style="color: #008080;">121</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> TestAccessOrm()
</span><span style="color: #008080;">122</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">123</span> 
<span style="color: #008080;">124</span>             <span style="color: #008000;">//</span><span style="color: #008000;">ORM数据映射</span>
<span style="color: #008080;">125</span>             DbConfig.UseDefaultConfig(<span style="color: #0000ff;">new</span><span style="color: #000000;"> TModelDbConfig(GetDbPath()));
</span><span style="color: #008080;">126</span>             Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">Start loadding...</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">127</span>             Console.WriteLine(<span style="color: #0000ff;">new</span> cms_category().Query(m =&gt; m.name == <span style="color: #800000;">"</span><span style="color: #800000;">城市</span><span style="color: #800000;">"</span><span style="color: #000000;">).ToCount());
</span><span style="color: #008080;">128</span>             <span style="color: #0000ff;">var</span> cat = <span style="color: #0000ff;">new</span> cms_category().Query(m =&gt; m.name == <span style="color: #800000;">"</span><span style="color: #800000;">城市</span><span style="color: #800000;">"</span>).SortAsc(m =&gt;<span style="color: #000000;"> m.name).ToModel();
</span><span style="color: #008080;">129</span> <span style="color: #000000;">            Console.WriteLine(cat.name);
</span><span style="color: #008080;">130</span> 
<span style="color: #008080;">131</span>             <span style="color: #008000;">//</span><span style="color: #008000;">设置只更新部分
</span><span style="color: #008080;">132</span>             <span style="color: #008000;">//</span><span style="color: #008000;">cat.SetPartHandled();
</span><span style="color: #008080;">133</span>             <span style="color: #008000;">//</span><span style="color: #008000;">cat.description = "test";
</span><span style="color: #008080;">134</span>             <span style="color: #008000;">//</span><span style="color: #008000;">cat.Update(m=&gt;m.id == 1);</span>
<span style="color: #008080;">135</span> 
<span style="color: #008080;">136</span>             Console.WriteLine(cat.ToValue(m =&gt;<span style="color: #000000;"> m.name));
</span><span style="color: #008080;">137</span>             Console.WriteLine(<span style="color: #0000ff;">new</span> cms_category().Query(m =&gt; m.name == <span style="color: #800000;">"</span><span style="color: #800000;">城市</span><span style="color: #800000;">"</span>).ToList()[<span style="color: #800080;">0</span><span style="color: #000000;">].name);
</span><span style="color: #008080;">138</span>             Console.WriteLine(<span style="color: #0000ff;">new</span> cms_category().Query(m =&gt; m.name == <span style="color: #800000;">"</span><span style="color: #800000;">城市</span><span style="color: #800000;">"</span> &amp;&amp; m.id &gt; <span style="color: #800080;">0</span> &amp;&amp; m.name == <span style="color: #800000;">""</span> || (m.id == <span style="color: #800080;">0</span> || m.name == <span style="color: #800000;">""</span><span style="color: #000000;">)).ToCount());
</span><span style="color: #008080;">139</span>             <span style="color: #008000;">//</span><span style="color: #008000;">指定条件规则查询</span>
<span style="color: #008080;">140</span>             Console.WriteLine(<span style="color: #0000ff;">new</span> cms_category().Query(m =&gt; (m.name == <span style="color: #800000;">"</span><span style="color: #800000;">城市</span><span style="color: #800000;">"</span> &amp;&amp; (m.id &gt; <span style="color: #800080;">0</span> || m.name == <span style="color: #800000;">""</span>)) || (m.id == <span style="color: #800080;">0</span> || m.name == <span style="color: #800000;">""</span><span style="color: #000000;">)).ToCount());
</span><span style="color: #008080;">141</span> 
<span style="color: #008080;">142</span>             <span style="color: #0000ff;">var</span> cityList = <span style="color: #0000ff;">new</span> List&lt;<span style="color: #0000ff;">string</span>&gt; { <span style="color: #800000;">"</span><span style="color: #800000;">城市</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">b</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">c</span><span style="color: #800000;">"</span><span style="color: #000000;"> };
</span><span style="color: #008080;">143</span>             <span style="color: #0000ff;">var</span> layer = <span style="color: #0000ff;">new</span> LayerModel { List =<span style="color: #000000;"> cityList };
</span><span style="color: #008080;">144</span>             Console.WriteLine(<span style="color: #0000ff;">new</span> cms_category().Query(m =&gt; m.name == <span style="color: #800000;">"</span><span style="color: #800000;">城市</span><span style="color: #800000;">"</span> || cityList.Contains(m.name) || m.parent_id ==<span style="color: #000000;"> Status.Success).ToCount());
</span><span style="color: #008080;">145</span>             Console.WriteLine(<span style="color: #0000ff;">new</span> cms_category().Query(m =&gt; m.name == <span style="color: #800000;">"</span><span style="color: #800000;">城市</span><span style="color: #800000;">"</span> ||<span style="color: #000000;"> layer.List.Contains(m.name)).ToCount());
</span><span style="color: #008080;">146</span>             
<span style="color: #008080;">147</span> 
<span style="color: #008080;">148</span>             <span style="color: #008000;">//</span><span style="color: #008000;">获取全部</span>
<span style="color: #008080;">149</span>             <span style="color: #0000ff;">var</span> datsList = <span style="color: #0000ff;">new</span><span style="color: #000000;"> cms_category().Query().ToList();
</span><span style="color: #008080;">150</span> <span style="color: #000000;">            Console.WriteLine(datsList.Count);
</span><span style="color: #008080;">151</span>             <span style="color: #008000;">//</span><span style="color: #008000;">获取N条</span>
<span style="color: #008080;">152</span>             datsList = <span style="color: #0000ff;">new</span> cms_category().Query().ToList(<span style="color: #800080;">6</span><span style="color: #000000;">);
</span><span style="color: #008080;">153</span> <span style="color: #000000;">            Console.WriteLine(datsList.Count);
</span><span style="color: #008080;">154</span>             <span style="color: #008000;">//</span><span style="color: #008000;">获取部分</span>
<span style="color: #008080;">155</span>             <span style="color: #0000ff;">var</span> partList = <span style="color: #0000ff;">new</span> cms_category().Query().ToPartList(<span style="color: #800080;">6</span>, <span style="color: #800000;">"</span><span style="color: #800000;">id</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">name</span><span style="color: #800000;">"</span>).Select(m =&gt; <span style="color: #0000ff;">new</span><span style="color: #000000;"> cms_category
</span><span style="color: #008080;">156</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">157</span>                 id = <span style="color: #0000ff;">int</span>.Parse(m[<span style="color: #800080;">0</span><span style="color: #000000;">]),
</span><span style="color: #008080;">158</span>                 name = m[<span style="color: #800080;">1</span><span style="color: #000000;">]
</span><span style="color: #008080;">159</span> <span style="color: #000000;">            }).ToList();
</span><span style="color: #008080;">160</span> <span style="color: #000000;">            Console.WriteLine(partList.Count);
</span><span style="color: #008080;">161</span>             <span style="color: #008000;">//</span><span style="color: #008000;">分页查询</span>
<span style="color: #008080;">162</span>             <span style="color: #0000ff;">var</span> mapper = <span style="color: #0000ff;">new</span><span style="color: #000000;"> cms_category().Query();
</span><span style="color: #008080;">163</span>             <span style="color: #0000ff;">var</span> dataCount =<span style="color: #000000;"> mapper.ToCount();
</span><span style="color: #008080;">164</span>             datsList = mapper.ToList(<span style="color: #800080;">20</span>, <span style="color: #800080;">1</span><span style="color: #000000;">, dataCount);
</span><span style="color: #008080;">165</span> <span style="color: #000000;">            Console.WriteLine(datsList.Count);
</span><span style="color: #008080;">166</span>             <span style="color: #008000;">//</span><span style="color: #008000;">条件拼接查询</span>
<span style="color: #008080;">167</span>             mapper.And(m =&gt; m.name == <span style="color: #800000;">"</span><span style="color: #800000;">test</span><span style="color: #800000;">"</span><span style="color: #000000;">)
</span><span style="color: #008080;">168</span>                 .And(m =&gt; m.id &gt; <span style="color: #800080;">0</span><span style="color: #000000;">)
</span><span style="color: #008080;">169</span>                 .Or(m =&gt; m.parent_id &gt; <span style="color: #800080;">0</span><span style="color: #000000;">);
</span><span style="color: #008080;">170</span>             mapper.Or(m =&gt; m.parent_id &gt; <span style="color: #800080;">0</span><span style="color: #000000;">);
</span><span style="color: #008080;">171</span> 
<span style="color: #008080;">172</span> 
<span style="color: #008080;">173</span> 
<span style="color: #008080;">174</span>             <span style="color: #0000ff;">var</span> channels = <span style="color: #0000ff;">new</span><span style="color: #000000;"> cms_channel().Query().ToList();
</span><span style="color: #008080;">175</span> <span style="color: #000000;">            Console.WriteLine(channels.Count);
</span><span style="color: #008080;">176</span>             <span style="color: #0000ff;">var</span> grade = <span style="color: #0000ff;">new</span> ucl_grade { id = <span style="color: #800080;">5</span><span style="color: #000000;"> };
</span><span style="color: #008080;">177</span>             grade.grade_name = <span style="color: #800000;">"</span><span style="color: #800000;">新手1</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">178</span>             <span style="color: #0000ff;">var</span> dal = <span style="color: #0000ff;">new</span><span style="color: #000000;"> UclGradeDataAccess(grade);
</span><span style="color: #008080;">179</span>             <span style="color: #008000;">//</span><span style="color: #008000;">保持数据库连接</span>
<span style="color: #008080;">180</span>             <span style="color: #0000ff;">using</span> (<span style="color: #0000ff;">var</span> db = <span style="color: #0000ff;">new</span> DbBuilder(<span style="color: #0000ff;">new</span><span style="color: #000000;"> TModelDbConfig(GetDbPath())).KeepConnect())
</span><span style="color: #008080;">181</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">182</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">使用数据库db操作并跟踪实体修改状态</span>
<span style="color: #008080;">183</span> <span style="color: #000000;">                dal.UseDatabase(db).SetPartHandled();
</span><span style="color: #008080;">184</span>                 grade.grade = <span style="color: #800080;">8</span><span style="color: #000000;">;
</span><span style="color: #008080;">185</span>                 grade.grade_name = <span style="color: #800000;">"</span><span style="color: #800000;">新手</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">186</span> <span style="color: #000000;">                dal.Update();
</span><span style="color: #008080;">187</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">188</span>             <span style="color: #008000;">//</span><span style="color: #008000;">db销毁后重连数据库</span>
<span style="color: #008080;">189</span>             Console.WriteLine(dal.ToValue(m =&gt;<span style="color: #000000;"> m.grade_name));
</span><span style="color: #008080;">190</span> 
<span style="color: #008080;">191</span> 
<span style="color: #008080;">192</span>             <span style="color: #008000;">//</span><span style="color: #008000;">使用事务(在事务中处理)</span>
<span style="color: #008080;">193</span>             <span style="color: #0000ff;">using</span> (<span style="color: #0000ff;">var</span> db = <span style="color: #0000ff;">new</span> DbBuilder(<span style="color: #0000ff;">new</span><span style="color: #000000;"> TModelDbConfig(GetDbPath())).KeepConnect())
</span><span style="color: #008080;">194</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">195</span>                 <span style="color: #0000ff;">try</span>
<span style="color: #008080;">196</span> <span style="color: #000000;">                {
</span><span style="color: #008080;">197</span> <span style="color: #000000;">                    db.BeginTransaction();
</span><span style="color: #008080;">198</span>                     <span style="color: #008000;">//</span><span style="color: #008000;">TODO:something
</span><span style="color: #008080;">199</span>                     <span style="color: #008000;">//</span><span style="color: #008000;">使用数据库db操作并跟踪实体修改状态</span>
<span style="color: #008080;">200</span> <span style="color: #000000;">                    dal.UseDatabase(db).SetPartHandled();
</span><span style="color: #008080;">201</span>                     grade.grade = <span style="color: #800080;">8</span><span style="color: #000000;">;
</span><span style="color: #008080;">202</span>                     grade.grade_name = <span style="color: #800000;">"</span><span style="color: #800000;">新手</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">203</span> <span style="color: #000000;">                    dal.Update();
</span><span style="color: #008080;">204</span> <span style="color: #000000;">                    db.CommitTransaction();
</span><span style="color: #008080;">205</span> <span style="color: #000000;">                }
</span><span style="color: #008080;">206</span>                 <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception ex)
</span><span style="color: #008080;">207</span> <span style="color: #000000;">                {
</span><span style="color: #008080;">208</span> <span style="color: #000000;">                    db.RollbackTransaction();
</span><span style="color: #008080;">209</span> <span style="color: #000000;">                }
</span><span style="color: #008080;">210</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">211</span>             
<span style="color: #008080;">212</span>             <span style="color: #008000;">//</span><span style="color: #008000;">使用事务(批处理事务)</span>
<span style="color: #008080;">213</span>             <span style="color: #0000ff;">var</span> parList = <span style="color: #0000ff;">new</span> List&lt;DbParamInfo&gt;<span style="color: #000000;">();
</span><span style="color: #008080;">214</span>             <span style="color: #008000;">//</span><span style="color: #008000;">添加到批处理事务中，如果执行失败则回滚事务</span>
<span style="color: #008080;">215</span> <span style="color: #000000;">            parList.Add(dal.GetUpdateDbParamInfo().UseVerifyExecResult());
</span><span style="color: #008080;">216</span>             <span style="color: #008000;">//</span><span style="color: #008000;">TODO:添加其他操作到parList</span>
<span style="color: #008080;">217</span>             <span style="color: #0000ff;">var</span> execCount = <span style="color: #0000ff;">new</span> DbBuilder(<span style="color: #0000ff;">new</span><span style="color: #000000;"> TModelDbConfig(GetDbPath())).ExecuteSqlTran(parList);
</span><span style="color: #008080;">218</span> <span style="color: #000000;">            Console.WriteLine(execCount);
</span><span style="color: #008080;">219</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">220</span> 
<span style="color: #008080;">221</span> 
<span style="color: #008080;">222</span> <span style="color: #000000;">        [TestMethod]
</span><span style="color: #008080;">223</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> TestMappingField()
</span><span style="color: #008080;">224</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">225</span>             <span style="color: #0000ff;">var</span> cat = <span style="color: #0000ff;">new</span><span style="color: #000000;"> cms_category();
</span><span style="color: #008080;">226</span>             <span style="color: #0000ff;">var</span> watch =<span style="color: #000000;"> System.Diagnostics.Stopwatch.StartNew();
</span><span style="color: #008080;">227</span>             <span style="color: #0000ff;">var</span> eachCount = <span style="color: #800080;">100000</span><span style="color: #000000;">;
</span><span style="color: #008080;">228</span>             <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">var</span> i = <span style="color: #800080;">0</span>; i &lt; eachCount; i++<span style="color: #000000;">)
</span><span style="color: #008080;">229</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">230</span>                 <span style="color: #0000ff;">var</span> field = <span style="color: #0000ff;">new</span> cms_category().ExpField(f =&gt;<span style="color: #000000;"> f.name);
</span><span style="color: #008080;">231</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">232</span> <span style="color: #000000;">            watch.Stop();
</span><span style="color: #008080;">233</span>             Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">Linq反射取</span><span style="color: #800000;">"</span> + eachCount + <span style="color: #800000;">"</span><span style="color: #800000;">次字段毫秒数:</span><span style="color: #800000;">"</span> +<span style="color: #000000;"> watch.ElapsedMilliseconds);
</span><span style="color: #008080;">234</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">235</span> 
<span style="color: #008080;">236</span> 
<span style="color: #008080;">237</span> 
<span style="color: #008080;">238</span>         <span style="color: #008000;">//</span><span style="color: #008000;">===============================================================================================
</span><span style="color: #008080;">239</span>         <span style="color: #008000;">//</span><span style="color: #008000;">access 测试配置类
</span><span style="color: #008080;">240</span>         <span style="color: #008000;">//</span><span style="color: #008000;">===============================================================================================</span>
<span style="color: #008080;">241</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> TModelDbConfig : DbConfig
</span><span style="color: #008080;">242</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">243</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> DBWriteLogInfo(<span style="color: #0000ff;">string</span> info, <span style="color: #0000ff;">string</span> title, <span style="color: #0000ff;">string</span> logpath, <span style="color: #0000ff;">string</span><span style="color: #000000;"> encoding)
</span><span style="color: #008080;">244</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">245</span>                 Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">dblog:</span><span style="color: #800000;">"</span> +<span style="color: #000000;"> info);
</span><span style="color: #008080;">246</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">247</span>             <span style="color: #0000ff;">public</span> TModelDbConfig(<span style="color: #0000ff;">string</span> solutionDir) : <span style="color: #0000ff;">base</span>(<span style="color: #800000;">"</span><span style="color: #800000;">System.Data.OleDb</span><span style="color: #800000;">"</span><span style="color: #000000;">,
</span><span style="color: #008080;">248</span>                 <span style="color: #800000;">@"</span><span style="color: #800000;">Provider=Microsoft.Jet.OLEDB.4.0;Data Source=</span><span style="color: #800000;">"</span> + solutionDir + <span style="color: #800000;">@"</span><span style="color: #800000;">\PlugNT_CMS.mdb;User ID=;Password=;</span><span style="color: #800000;">"</span><span style="color: #000000;">,
</span><span style="color: #008080;">249</span> <span style="color: #000000;">                DBWriteLogInfo)
</span><span style="color: #008080;">250</span> <span style="color: #000000;">            { }
</span><span style="color: #008080;">251</span> 
<span style="color: #008080;">252</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">253</span> 
<span style="color: #008080;">254</span> 
<span style="color: #008080;">255</span>         [Table(<span style="color: #800000;">"</span><span style="color: #800000;">cms_channel</span><span style="color: #800000;">"</span><span style="color: #000000;">)]
</span><span style="color: #008080;">256</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">partial</span> <span style="color: #0000ff;">class</span> cms_channel : BaseMapper&lt;cms_channel&gt;
<span style="color: #008080;">257</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">258</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span> id { <span style="color: #0000ff;">get</span>; <span style="color: #0000ff;">set</span><span style="color: #000000;">; }
</span><span style="color: #008080;">259</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">string</span> no { <span style="color: #0000ff;">get</span>; <span style="color: #0000ff;">set</span><span style="color: #000000;">; }
</span><span style="color: #008080;">260</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">string</span> title { <span style="color: #0000ff;">get</span>; <span style="color: #0000ff;">set</span><span style="color: #000000;">; }
</span><span style="color: #008080;">261</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">262</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> LayerModel
</span><span style="color: #008080;">263</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">264</span>             <span style="color: #0000ff;">public</span> List&lt;<span style="color: #0000ff;">string</span>&gt; List { <span style="color: #0000ff;">get</span>; <span style="color: #0000ff;">set</span><span style="color: #000000;">; }
</span><span style="color: #008080;">265</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">266</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">partial</span> <span style="color: #0000ff;">class</span> cms_category : BaseMapper&lt;cms_category&gt;
<span style="color: #008080;">267</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">268</span> 
<span style="color: #008080;">269</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">string</span> TestStatic = <span style="color: #800000;">"</span><span style="color: #800000;">TestStatic</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">270</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">const</span> <span style="color: #0000ff;">string</span> TestConst = <span style="color: #800000;">"</span><span style="color: #800000;">TestConst</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">271</span> 
<span style="color: #008080;">272</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span> id { <span style="color: #0000ff;">get</span>; <span style="color: #0000ff;">set</span><span style="color: #000000;">; }
</span><span style="color: #008080;">273</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">string</span> name { <span style="color: #0000ff;">get</span>; <span style="color: #0000ff;">set</span><span style="color: #000000;">; }
</span><span style="color: #008080;">274</span>             <span style="color: #008000;">//</span><span style="color: #008000;">public int parent_id { get; set; }</span>
<span style="color: #008080;">275</span>             <span style="color: #0000ff;">public</span> Status parent_id { <span style="color: #0000ff;">get</span>; <span style="color: #0000ff;">set</span><span style="color: #000000;">; }
</span><span style="color: #008080;">276</span> 
<span style="color: #008080;">277</span>             [Obsolete(<span style="color: #800000;">"</span><span style="color: #800000;">test</span><span style="color: #800000;">"</span><span style="color: #000000;">)]
</span><span style="color: #008080;">278</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">bool</span> enabled { <span style="color: #0000ff;">get</span>; <span style="color: #0000ff;">set</span><span style="color: #000000;">; }
</span><span style="color: #008080;">279</span>             [Obsolete(<span style="color: #800000;">"</span><span style="color: #800000;">test</span><span style="color: #800000;">"</span><span style="color: #000000;">)]
</span><span style="color: #008080;">280</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">bool</span> isused { <span style="color: #0000ff;">get</span>; <span style="color: #0000ff;">set</span><span style="color: #000000;">; }
</span><span style="color: #008080;">281</span> 
<span style="color: #008080;">282</span>             
<span style="color: #008080;">283</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">override</span> <span style="color: #0000ff;">string</span><span style="color: #000000;"> TableName
</span><span style="color: #008080;">284</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">285</span>                 <span style="color: #0000ff;">get</span> { <span style="color: #0000ff;">return</span> <span style="color: #800000;">"</span><span style="color: #800000;">cms_category</span><span style="color: #800000;">"</span><span style="color: #000000;">; }
</span><span style="color: #008080;">286</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">287</span>             <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">override</span><span style="color: #000000;"> cms_category ConvertEntity(IDataReader reader)
</span><span style="color: #008080;">288</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">289</span>                 <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> cms_category
</span><span style="color: #008080;">290</span> <span style="color: #000000;">                {
</span><span style="color: #008080;">291</span>                     id = <span style="color: #0000ff;">int</span>.Parse(reader[<span style="color: #800000;">"</span><span style="color: #800000;">id</span><span style="color: #800000;">"</span><span style="color: #000000;">].ToString()),
</span><span style="color: #008080;">292</span>                     name = reader[<span style="color: #800000;">"</span><span style="color: #800000;">name</span><span style="color: #800000;">"</span><span style="color: #000000;">].ToString(),
</span><span style="color: #008080;">293</span>                     parent_id = (Status)<span style="color: #0000ff;">int</span>.Parse(reader[<span style="color: #800000;">"</span><span style="color: #800000;">parent_id</span><span style="color: #800000;">"</span><span style="color: #000000;">].ToString()),
</span><span style="color: #008080;">294</span> <span style="color: #000000;">                };
</span><span style="color: #008080;">295</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">296</span>             <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">override</span> List&lt;DbFieldInfo&gt;<span style="color: #000000;"> ConvertFields(cms_category model)
</span><span style="color: #008080;">297</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">298</span>                 <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> List&lt;DbFieldInfo&gt;
<span style="color: #008080;">299</span> <span style="color: #000000;">                {
</span><span style="color: #008080;">300</span>                     <span style="color: #0000ff;">new</span> DbFieldInfo { Name = <span style="color: #800000;">"</span><span style="color: #800000;">id</span><span style="color: #800000;">"</span>, Value = model.id , IsIdentity =<span style="color: #0000ff;">true</span><span style="color: #000000;"> },
</span><span style="color: #008080;">301</span>                     <span style="color: #0000ff;">new</span> DbFieldInfo { Name = <span style="color: #800000;">"</span><span style="color: #800000;">name</span><span style="color: #800000;">"</span>, Value =<span style="color: #000000;"> model.name  },
</span><span style="color: #008080;">302</span>                     <span style="color: #0000ff;">new</span> DbFieldInfo { Name = <span style="color: #800000;">"</span><span style="color: #800000;">parent_id</span><span style="color: #800000;">"</span>, Value =<span style="color: #000000;"> model.parent_id  },
</span><span style="color: #008080;">303</span> <span style="color: #000000;">                };
</span><span style="color: #008080;">304</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">305</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">306</span> 
<span style="color: #008080;">307</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> cms_category_extend : cms_category
</span><span style="color: #008080;">308</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">309</span>             <span style="color: #0000ff;">public</span> cms_category mytest1 { <span style="color: #0000ff;">get</span>; <span style="color: #0000ff;">set</span><span style="color: #000000;">; }
</span><span style="color: #008080;">310</span>             <span style="color: #0000ff;">public</span> cms_category_extend mytest2 { <span style="color: #0000ff;">get</span>; <span style="color: #0000ff;">set</span><span style="color: #000000;">; }
</span><span style="color: #008080;">311</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">string</span> myname { <span style="color: #0000ff;">get</span>; <span style="color: #0000ff;">set</span><span style="color: #000000;">; }
</span><span style="color: #008080;">312</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">313</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> ucl_grade
</span><span style="color: #008080;">314</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">315</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span> id { <span style="color: #0000ff;">get</span>; <span style="color: #0000ff;">set</span><span style="color: #000000;">; }
</span><span style="color: #008080;">316</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span> grade { <span style="color: #0000ff;">get</span>; <span style="color: #0000ff;">set</span><span style="color: #000000;">; }
</span><span style="color: #008080;">317</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">string</span> grade_name { <span style="color: #0000ff;">get</span>; <span style="color: #0000ff;">set</span><span style="color: #000000;">; }
</span><span style="color: #008080;">318</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">319</span> 
<span style="color: #008080;">320</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> UclGradeDataAccess : BaseMapper&lt;ucl_grade&gt;
<span style="color: #008080;">321</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">322</span>             <span style="color: #0000ff;">public</span> UclGradeDataAccess(ucl_grade model = <span style="color: #0000ff;">null</span><span style="color: #000000;">)
</span><span style="color: #008080;">323</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">324</span>                 ContextEntity =<span style="color: #000000;"> model;
</span><span style="color: #008080;">325</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">326</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">override</span> <span style="color: #0000ff;">string</span><span style="color: #000000;"> TableName
</span><span style="color: #008080;">327</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">328</span>                 <span style="color: #0000ff;">get</span> { <span style="color: #0000ff;">return</span> <span style="color: #800000;">"</span><span style="color: #800000;">ucl_grade</span><span style="color: #800000;">"</span><span style="color: #000000;">; }
</span><span style="color: #008080;">329</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">330</span>             <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">override</span><span style="color: #000000;"> ucl_grade ConvertEntity(IDataReader reader)
</span><span style="color: #008080;">331</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">332</span>                 <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> ucl_grade
</span><span style="color: #008080;">333</span> <span style="color: #000000;">                {
</span><span style="color: #008080;">334</span>                     id = <span style="color: #0000ff;">int</span>.Parse(reader[<span style="color: #800000;">"</span><span style="color: #800000;">id</span><span style="color: #800000;">"</span><span style="color: #000000;">].ToString()),
</span><span style="color: #008080;">335</span>                     grade = <span style="color: #0000ff;">int</span>.Parse(reader[<span style="color: #800000;">"</span><span style="color: #800000;">grade</span><span style="color: #800000;">"</span><span style="color: #000000;">].ToString()),
</span><span style="color: #008080;">336</span>                     grade_name = reader[<span style="color: #800000;">"</span><span style="color: #800000;">grade_name</span><span style="color: #800000;">"</span><span style="color: #000000;">].ToString(),
</span><span style="color: #008080;">337</span> <span style="color: #000000;">                };
</span><span style="color: #008080;">338</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">339</span>             <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">override</span> List&lt;DbFieldInfo&gt;<span style="color: #000000;"> ConvertFields(ucl_grade model)
</span><span style="color: #008080;">340</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">341</span>                 <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> List&lt;DbFieldInfo&gt;
<span style="color: #008080;">342</span> <span style="color: #000000;">                {
</span><span style="color: #008080;">343</span>                     <span style="color: #0000ff;">new</span> DbFieldInfo { Name = <span style="color: #800000;">"</span><span style="color: #800000;">id</span><span style="color: #800000;">"</span>, Value = model.id , IsPrimaryKey =<span style="color: #0000ff;">true</span> , IsIdentity =<span style="color: #0000ff;">true</span><span style="color: #000000;"> },
</span><span style="color: #008080;">344</span>                     <span style="color: #0000ff;">new</span> DbFieldInfo { Name = <span style="color: #800000;">"</span><span style="color: #800000;">grade</span><span style="color: #800000;">"</span>, Value =<span style="color: #000000;"> model.grade  },
</span><span style="color: #008080;">345</span>                     <span style="color: #0000ff;">new</span> DbFieldInfo { Name = <span style="color: #800000;">"</span><span style="color: #800000;">grade_name</span><span style="color: #800000;">"</span>, Value =<span style="color: #000000;"> model.grade_name  },
</span><span style="color: #008080;">346</span> <span style="color: #000000;">                };
</span><span style="color: #008080;">347</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">348</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">349</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">enum</span><span style="color: #000000;"> Status
</span><span style="color: #008080;">350</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">351</span> <span style="color: #000000;">            Success
</span><span style="color: #008080;">352</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">353</span>         
<span style="color: #008080;">354</span>         <span style="color: #0000ff;">#endregion</span>
<span style="color: #008080;">355</span>         
<span style="color: #008080;">356</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">357</span> }</pre>
</div>
<p>&nbsp;</p>
<p>部分测试截图：</p>
<p><img src="./images/一个类搞定SQL条件映射解析，实现轻量简单实用ORM功能0.png" alt="" /></p>
<p><img src="./images/一个类搞定SQL条件映射解析，实现轻量简单实用ORM功能1.png" alt="" width="1172" height="636" /><br />Orm成品开源项目地址<br />https://github.com/PlugNT/util6</p>
<p>&nbsp;</p>
</div>
</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>