<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修Google Authenticator(谷歌身份验证器)C#版' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>Google Authenticator(谷歌身份验证器)C#版</center></div><div class='banquan'>原文出处:本文由博客园博主Hsyi提供。<br/>
原文连接:https://www.cnblogs.com/easyauthor/p/11054869.html</div><br>
    <div>摘要：Google Authenticator(谷歌身份验证器)，是谷歌公司推出的一款动态令牌工具，解决账户使用时遭到的一些不安全的操作进行的&ldquo;二次验证&rdquo;，认证器基于RFC文档中的HOTP/TOTP算法实现 ，是一种从共享秘钥和时间或次数一次性令牌的算法。在工作中可以通过认证器方式对账户有更好的保护，但是在查阅一些资料发现适合我这样的小白文章真的很少，针对于C#的文章就更加少了，本文主要是对C#如何使用Google Authenticator(谷歌身份验证器)进行探讨，有不足之处还请见谅。</div>
<h2>Google Authenticator(谷歌身份验证器)</h2>
<h3>什么是认证器？怎么对接？</h3>
<div>
<p>Google Authenticator(谷歌身份验证器)是微软推出的一个动态密令工具，它有两种密令模式。分别是&ldquo;TOTP 基于时间&rdquo;、&ldquo;HOTP 基于计数器&rdquo;，通过手机上 简单的设置就可以设定自己独一的动态密令， 那么我们怎么将我们的程序和认证器进行对接呢？其实谷歌认证器并不是需要我们对接这个工具的API而是通过算法来决定，谷歌使用使用HMAC算法生成密令，通过基于次数或者基于时间两个模板进行计算，因此在程序中只需要使用相同的算法即可与之匹配。</p>
</div>
<div>
<h4>TOTP 基于时间</h4>
<ul>
<li>HMAC算法使用固定为HmacSHA1</li>
<li>更新时长固定为30秒</li>
<li>APP端输入数据维度只有两个：账户名称（自己随意填写方便自己查看）和base32格式的key</li>
</ul>
</div>
<div>
<h4>HOTP 基于计数器</h4>
<p>基于计数器模式是根据一个共享秘钥K和一个C计数器进行算法计算</p>
</div>
<h3>认证器安装</h3>
<div>
<p>手机需要安装认证器：</p>
<ul>
<li>Android版：<a href="https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2" target="_back">安卓版下载</a></li>
<li>IOS版：<a href="https://itunes.apple.com/cn/app/google-authenticator/id388497605" target="_back">苹果版下载</a></li>
</ul>
</div>
<h3>效果图</h3>
<h3><img src="./images/Google Authenticator(谷歌身份验证器)C#版0.png" alt="" width="335" height="175" /><img src="./images/Google Authenticator(谷歌身份验证器)C#版1.png" alt="" />容</h3>
<h3><span style="font-size: 1.5em;">案例</span></h3>
<h3>控制台</h3>
<div>
<div class="cnblogs_code" onclick="cnblogs_code_show('055caeba-c22e-44bf-bf70-51c2bd4c2a79')"><img id="code_img_closed_055caeba-c22e-44bf-bf70-51c2bd4c2a79" class="code_img_closed" src="./images/Google Authenticator(谷歌身份验证器)C#版2.png" alt="" /><img id="code_img_opened_055caeba-c22e-44bf-bf70-51c2bd4c2a79" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('055caeba-c22e-44bf-bf70-51c2bd4c2a79',event)" src="./images/Google Authenticator(谷歌身份验证器)C#版3.png" alt="" />
<div id="cnblogs_code_open_055caeba-c22e-44bf-bf70-51c2bd4c2a79" class="cnblogs_code_hide">
<pre><code><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">using</span><span style="color: #000000;"> System;
</span><span style="color: #008080;"> 2</span> <span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Collections.Generic;
</span><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Linq;
</span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Text;
</span><span style="color: #008080;"> 5</span> 
<span style="color: #008080;"> 6</span> <span style="color: #0000ff;">namespace</span><span style="color: #000000;"> GoogleAuthenticator
</span><span style="color: #008080;"> 7</span> <span style="color: #000000;">{
</span><span style="color: #008080;"> 8</span>     <span style="color: #0000ff;">class</span><span style="color: #000000;"> Program
</span><span style="color: #008080;"> 9</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">10</span>         <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> Main(<span style="color: #0000ff;">string</span><span style="color: #000000;">[] args)
</span><span style="color: #008080;">11</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">12</span>             <span style="color: #0000ff;">long</span> duration = <span style="color: #800080;">30</span><span style="color: #000000;">;
</span><span style="color: #008080;">13</span>             <span style="color: #0000ff;">string</span> key = <span style="color: #800000;">"</span><span style="color: #800000;">xeon997@foxmail.com</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">14</span>             GoogleAuthenticator authenticator = <span style="color: #0000ff;">new</span><span style="color: #000000;"> GoogleAuthenticator(duration, key);
</span><span style="color: #008080;">15</span>             <span style="color: #0000ff;">var</span> mobileKey =<span style="color: #000000;"> authenticator.GetMobilePhoneKey();
</span><span style="color: #008080;">16</span> 
<span style="color: #008080;">17</span>             <span style="color: #0000ff;">while</span> (<span style="color: #0000ff;">true</span><span style="color: #000000;">)
</span><span style="color: #008080;">18</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">19</span> 
<span style="color: #008080;">20</span>                 Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">手机端秘钥为：</span><span style="color: #800000;">"</span> +<span style="color: #000000;"> mobileKey);
</span><span style="color: #008080;">21</span> 
<span style="color: #008080;">22</span>                 <span style="color: #0000ff;">var</span> code =<span style="color: #000000;"> authenticator.GenerateCode();
</span><span style="color: #008080;">23</span>                 Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">动态验证码为：</span><span style="color: #800000;">"</span> +<span style="color: #000000;"> code);
</span><span style="color: #008080;">24</span> 
<span style="color: #008080;">25</span>                 Console.WriteLine(<span style="color: #800000;">"</span><span style="color: #800000;">刷新倒计时：</span><span style="color: #800000;">"</span> +<span style="color: #000000;"> authenticator.EXPIRE_SECONDS);
</span><span style="color: #008080;">26</span> 
<span style="color: #008080;">27</span>                 System.Threading.Thread.Sleep(<span style="color: #800080;">1000</span><span style="color: #000000;">);
</span><span style="color: #008080;">28</span> <span style="color: #000000;">                Console.Clear();
</span><span style="color: #008080;">29</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">30</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">31</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">32</span> }</pre>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<p>&nbsp;</p>
</div>
<h3>认证器类</h3>
<div>
<div class="cnblogs_code" onclick="cnblogs_code_show('53732977-0088-4141-97be-dd6488d5880b')"><img id="code_img_closed_53732977-0088-4141-97be-dd6488d5880b" class="code_img_closed" src="./images/Google Authenticator(谷歌身份验证器)C#版2.png" alt="" /><img id="code_img_opened_53732977-0088-4141-97be-dd6488d5880b" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('53732977-0088-4141-97be-dd6488d5880b',event)" src="./images/Google Authenticator(谷歌身份验证器)C#版3.png" alt="" />
<div id="cnblogs_code_open_53732977-0088-4141-97be-dd6488d5880b" class="cnblogs_code_hide">
<pre><code><span style="color: #008080;">  1</span> <span style="color: #0000ff;">using</span><span style="color: #000000;"> GoogleAuthorization;
</span><span style="color: #008080;">  2</span> <span style="color: #0000ff;">using</span><span style="color: #000000;"> System;
</span><span style="color: #008080;">  3</span> <span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Security.Cryptography;
</span><span style="color: #008080;">  4</span> <span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Text;
</span><span style="color: #008080;">  5</span> <span style="color: #0000ff;">namespace</span><span style="color: #000000;"> GoogleAuthenticator
</span><span style="color: #008080;">  6</span> <span style="color: #000000;">{
</span><span style="color: #008080;">  7</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> GoogleAuthenticator
</span><span style="color: #008080;">  8</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">  9</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;"> 10</span>         <span style="color: #808080;">///</span><span style="color: #008000;"> 初始化验证码生成规则
</span><span style="color: #008080;"> 11</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;"> 12</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;param name="key"&gt;</span><span style="color: #008000;">秘钥(手机使用Base32码)</span><span style="color: #808080;">&lt;/param&gt;</span>
<span style="color: #008080;"> 13</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;param name="duration"&gt;</span><span style="color: #008000;">验证码间隔多久刷新一次（默认30秒和google同步）</span><span style="color: #808080;">&lt;/param&gt;</span>
<span style="color: #008080;"> 14</span>         <span style="color: #0000ff;">public</span> GoogleAuthenticator(<span style="color: #0000ff;">long</span> duration = <span style="color: #800080;">30</span>, <span style="color: #0000ff;">string</span> key = <span style="color: #800000;">"</span><span style="color: #800000;">xeon997@foxmail.com</span><span style="color: #800000;">"</span><span style="color: #000000;">)
</span><span style="color: #008080;"> 15</span> <span style="color: #000000;">        {
</span><span style="color: #008080;"> 16</span>             <span style="color: #0000ff;">this</span>.SERECT_KEY =<span style="color: #000000;"> key;
</span><span style="color: #008080;"> 17</span>             <span style="color: #0000ff;">this</span>.SERECT_KEY_MOBILE =<span style="color: #000000;"> Base32.ToString(Encoding.UTF8.GetBytes(key));
</span><span style="color: #008080;"> 18</span>             <span style="color: #0000ff;">this</span>.DURATION_TIME =<span style="color: #000000;"> duration;
</span><span style="color: #008080;"> 19</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 20</span> 
<span style="color: #008080;"> 21</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;"> 22</span>         <span style="color: #808080;">///</span><span style="color: #008000;"> 间隔时间
</span><span style="color: #008080;"> 23</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;"> 24</span>         <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">long</span> DURATION_TIME { <span style="color: #0000ff;">get</span>; <span style="color: #0000ff;">set</span><span style="color: #000000;">; }
</span><span style="color: #008080;"> 25</span> 
<span style="color: #008080;"> 26</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;"> 27</span>         <span style="color: #808080;">///</span><span style="color: #008000;"> 迭代次数
</span><span style="color: #008080;"> 28</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;"> 29</span>         <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">long</span><span style="color: #000000;"> COUNTER
</span><span style="color: #008080;"> 30</span> <span style="color: #000000;">        {
</span><span style="color: #008080;"> 31</span>             <span style="color: #0000ff;">get</span>
<span style="color: #008080;"> 32</span> <span style="color: #000000;">            {
</span><span style="color: #008080;"> 33</span>                 <span style="color: #0000ff;">return</span> (<span style="color: #0000ff;">long</span>)(DateTime.UtcNow - <span style="color: #0000ff;">new</span> DateTime(<span style="color: #800080;">1970</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">0</span>, <span style="color: #800080;">0</span>, <span style="color: #800080;">0</span>, DateTimeKind.Utc)).TotalSeconds /<span style="color: #000000;"> DURATION_TIME;
</span><span style="color: #008080;"> 34</span> <span style="color: #000000;">            }
</span><span style="color: #008080;"> 35</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 36</span> 
<span style="color: #008080;"> 37</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;"> 38</span>         <span style="color: #808080;">///</span><span style="color: #008000;"> 秘钥
</span><span style="color: #008080;"> 39</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;"> 40</span>         <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">string</span> SERECT_KEY { <span style="color: #0000ff;">get</span>; <span style="color: #0000ff;">set</span><span style="color: #000000;">; }
</span><span style="color: #008080;"> 41</span> 
<span style="color: #008080;"> 42</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;"> 43</span>         <span style="color: #808080;">///</span><span style="color: #008000;"> 手机端输入的秘钥
</span><span style="color: #008080;"> 44</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;"> 45</span>         <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">string</span> SERECT_KEY_MOBILE { <span style="color: #0000ff;">get</span>; <span style="color: #0000ff;">set</span><span style="color: #000000;">; }
</span><span style="color: #008080;"> 46</span> 
<span style="color: #008080;"> 47</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;"> 48</span>         <span style="color: #808080;">///</span><span style="color: #008000;"> 到期秒数
</span><span style="color: #008080;"> 49</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;"> 50</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">long</span><span style="color: #000000;"> EXPIRE_SECONDS
</span><span style="color: #008080;"> 51</span> <span style="color: #000000;">        {
</span><span style="color: #008080;"> 52</span>             <span style="color: #0000ff;">get</span>
<span style="color: #008080;"> 53</span> <span style="color: #000000;">            {
</span><span style="color: #008080;"> 54</span>                 <span style="color: #0000ff;">return</span> (DURATION_TIME - (<span style="color: #0000ff;">long</span>)(DateTime.UtcNow - <span style="color: #0000ff;">new</span> DateTime(<span style="color: #800080;">1970</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">0</span>, <span style="color: #800080;">0</span>, <span style="color: #800080;">0</span>, DateTimeKind.Utc)).TotalSeconds %<span style="color: #000000;"> DURATION_TIME);
</span><span style="color: #008080;"> 55</span> <span style="color: #000000;">            }
</span><span style="color: #008080;"> 56</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 57</span> 
<span style="color: #008080;"> 58</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;"> 59</span>         <span style="color: #808080;">///</span><span style="color: #008000;"> 获取手机端秘钥
</span><span style="color: #008080;"> 60</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;"> 61</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;returns&gt;&lt;/returns&gt;</span>
<span style="color: #008080;"> 62</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">string</span><span style="color: #000000;"> GetMobilePhoneKey()
</span><span style="color: #008080;"> 63</span> <span style="color: #000000;">        {
</span><span style="color: #008080;"> 64</span>             <span style="color: #0000ff;">if</span> (SERECT_KEY_MOBILE == <span style="color: #0000ff;">null</span><span style="color: #000000;">)
</span><span style="color: #008080;"> 65</span>                 <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> ArgumentNullException(<span style="color: #800000;">"</span><span style="color: #800000;">SERECT_KEY_MOBILE</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 66</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> SERECT_KEY_MOBILE;
</span><span style="color: #008080;"> 67</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 68</span> 
<span style="color: #008080;"> 69</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;"> 70</span>         <span style="color: #808080;">///</span><span style="color: #008000;"> 生成认证码
</span><span style="color: #008080;"> 71</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;"> 72</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;returns&gt;</span><span style="color: #008000;">返回验证码</span><span style="color: #808080;">&lt;/returns&gt;</span>
<span style="color: #008080;"> 73</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">string</span><span style="color: #000000;"> GenerateCode()
</span><span style="color: #008080;"> 74</span> <span style="color: #000000;">        {
</span><span style="color: #008080;"> 75</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> GenerateHashedCode(SERECT_KEY, COUNTER);
</span><span style="color: #008080;"> 76</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 77</span> 
<span style="color: #008080;"> 78</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;"> 79</span>         <span style="color: #808080;">///</span><span style="color: #008000;"> 按照次数生成哈希编码
</span><span style="color: #008080;"> 80</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;"> 81</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;param name="secret"&gt;</span><span style="color: #008000;">秘钥</span><span style="color: #808080;">&lt;/param&gt;</span>
<span style="color: #008080;"> 82</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;param name="iterationNumber"&gt;</span><span style="color: #008000;">迭代次数</span><span style="color: #808080;">&lt;/param&gt;</span>
<span style="color: #008080;"> 83</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;param name="digits"&gt;</span><span style="color: #008000;">生成位数</span><span style="color: #808080;">&lt;/param&gt;</span>
<span style="color: #008080;"> 84</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;returns&gt;</span><span style="color: #008000;">返回验证码</span><span style="color: #808080;">&lt;/returns&gt;</span>
<span style="color: #008080;"> 85</span>         <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">string</span> GenerateHashedCode(<span style="color: #0000ff;">string</span> secret, <span style="color: #0000ff;">long</span> iterationNumber, <span style="color: #0000ff;">int</span> digits = <span style="color: #800080;">6</span><span style="color: #000000;">)
</span><span style="color: #008080;"> 86</span> <span style="color: #000000;">        {
</span><span style="color: #008080;"> 87</span>             <span style="color: #0000ff;">byte</span>[] counter =<span style="color: #000000;"> BitConverter.GetBytes(iterationNumber);
</span><span style="color: #008080;"> 88</span> 
<span style="color: #008080;"> 89</span>             <span style="color: #0000ff;">if</span><span style="color: #000000;"> (BitConverter.IsLittleEndian)
</span><span style="color: #008080;"> 90</span> <span style="color: #000000;">                Array.Reverse(counter);
</span><span style="color: #008080;"> 91</span> 
<span style="color: #008080;"> 92</span>             <span style="color: #0000ff;">byte</span>[] key =<span style="color: #000000;"> Encoding.ASCII.GetBytes(secret);
</span><span style="color: #008080;"> 93</span> 
<span style="color: #008080;"> 94</span>             HMACSHA1 hmac = <span style="color: #0000ff;">new</span> HMACSHA1(key, <span style="color: #0000ff;">true</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 95</span> 
<span style="color: #008080;"> 96</span>             <span style="color: #0000ff;">byte</span>[] hash =<span style="color: #000000;"> hmac.ComputeHash(counter);
</span><span style="color: #008080;"> 97</span> 
<span style="color: #008080;"> 98</span>             <span style="color: #0000ff;">int</span> offset = hash[hash.Length - <span style="color: #800080;">1</span>] &amp; <span style="color: #800080;">0xf</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 99</span> 
<span style="color: #008080;">100</span>             <span style="color: #0000ff;">int</span> binary =
<span style="color: #008080;">101</span>                 ((hash[offset] &amp; <span style="color: #800080;">0x7f</span>) &lt;&lt; <span style="color: #800080;">24</span><span style="color: #000000;">)
</span><span style="color: #008080;">102</span>                 | ((hash[offset + <span style="color: #800080;">1</span>] &amp; <span style="color: #800080;">0xff</span>) &lt;&lt; <span style="color: #800080;">16</span><span style="color: #000000;">)
</span><span style="color: #008080;">103</span>                 | ((hash[offset + <span style="color: #800080;">2</span>] &amp; <span style="color: #800080;">0xff</span>) &lt;&lt; <span style="color: #800080;">8</span><span style="color: #000000;">)
</span><span style="color: #008080;">104</span>                 | (hash[offset + <span style="color: #800080;">3</span>] &amp; <span style="color: #800080;">0xff</span><span style="color: #000000;">);
</span><span style="color: #008080;">105</span> 
<span style="color: #008080;">106</span>             <span style="color: #0000ff;">int</span> password = binary % (<span style="color: #0000ff;">int</span>)Math.Pow(<span style="color: #800080;">10</span>, digits); <span style="color: #008000;">//</span><span style="color: #008000;"> 6 digits</span>
<span style="color: #008080;">107</span> 
<span style="color: #008080;">108</span>             <span style="color: #0000ff;">return</span> password.ToString(<span style="color: #0000ff;">new</span> <span style="color: #0000ff;">string</span>(<span style="color: #800000;">'</span><span style="color: #800000;">0</span><span style="color: #800000;">'</span><span style="color: #000000;">, digits));
</span><span style="color: #008080;">109</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">110</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">111</span> }</pre>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<p>&nbsp;</p>
<p><span style="font-size: 1.17em;">Base32转码类</span></p>
</div>
<div>
<div class="cnblogs_code" onclick="cnblogs_code_show('333f57cc-4312-4d81-b388-a2b62a46b77a')"><img id="code_img_closed_333f57cc-4312-4d81-b388-a2b62a46b77a" class="code_img_closed" src="./images/Google Authenticator(谷歌身份验证器)C#版2.png" alt="" /><img id="code_img_opened_333f57cc-4312-4d81-b388-a2b62a46b77a" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('333f57cc-4312-4d81-b388-a2b62a46b77a',event)" src="./images/Google Authenticator(谷歌身份验证器)C#版3.png" alt="" />
<div id="cnblogs_code_open_333f57cc-4312-4d81-b388-a2b62a46b77a" class="cnblogs_code_hide">
<pre><code><span style="color: #008080;">  1</span> <span style="color: #0000ff;">using</span><span style="color: #000000;"> System;
</span><span style="color: #008080;">  2</span> <span style="color: #0000ff;">namespace</span><span style="color: #000000;"> GoogleAuthorization
</span><span style="color: #008080;">  3</span> <span style="color: #000000;">{
</span><span style="color: #008080;">  4</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> Base32
</span><span style="color: #008080;">  5</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">  6</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">byte</span>[] ToBytes(<span style="color: #0000ff;">string</span><span style="color: #000000;"> input)
</span><span style="color: #008080;">  7</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">  8</span>             <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">string</span><span style="color: #000000;">.IsNullOrEmpty(input))
</span><span style="color: #008080;">  9</span> <span style="color: #000000;">            {
</span><span style="color: #008080;"> 10</span>                 <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> ArgumentNullException(<span style="color: #800000;">"</span><span style="color: #800000;">input</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 11</span> <span style="color: #000000;">            }
</span><span style="color: #008080;"> 12</span> 
<span style="color: #008080;"> 13</span>             input = input.TrimEnd(<span style="color: #800000;">'</span><span style="color: #800000;">=</span><span style="color: #800000;">'</span><span style="color: #000000;">); 
</span><span style="color: #008080;"> 14</span>             <span style="color: #0000ff;">int</span> byteCount = input.Length * <span style="color: #800080;">5</span> / <span style="color: #800080;">8</span><span style="color: #000000;">; 
</span><span style="color: #008080;"> 15</span>             <span style="color: #0000ff;">byte</span>[] returnArray = <span style="color: #0000ff;">new</span> <span style="color: #0000ff;">byte</span><span style="color: #000000;">[byteCount];
</span><span style="color: #008080;"> 16</span> 
<span style="color: #008080;"> 17</span>             <span style="color: #0000ff;">byte</span> curByte = <span style="color: #800080;">0</span>, bitsRemaining = <span style="color: #800080;">8</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 18</span>             <span style="color: #0000ff;">int</span> mask = <span style="color: #800080;">0</span>, arrayIndex = <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 19</span> 
<span style="color: #008080;"> 20</span>             <span style="color: #0000ff;">foreach</span> (<span style="color: #0000ff;">char</span> c <span style="color: #0000ff;">in</span><span style="color: #000000;"> input)
</span><span style="color: #008080;"> 21</span> <span style="color: #000000;">            {
</span><span style="color: #008080;"> 22</span>                 <span style="color: #0000ff;">int</span> cValue =<span style="color: #000000;"> CharToValue(c);
</span><span style="color: #008080;"> 23</span> 
<span style="color: #008080;"> 24</span>                 <span style="color: #0000ff;">if</span> (bitsRemaining &gt; <span style="color: #800080;">5</span><span style="color: #000000;">)
</span><span style="color: #008080;"> 25</span> <span style="color: #000000;">                {
</span><span style="color: #008080;"> 26</span>                     mask = cValue &lt;&lt; (bitsRemaining - <span style="color: #800080;">5</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 27</span>                     curByte = (<span style="color: #0000ff;">byte</span>)(curByte |<span style="color: #000000;"> mask);
</span><span style="color: #008080;"> 28</span>                     bitsRemaining -= <span style="color: #800080;">5</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 29</span> <span style="color: #000000;">                }
</span><span style="color: #008080;"> 30</span>                 <span style="color: #0000ff;">else</span>
<span style="color: #008080;"> 31</span> <span style="color: #000000;">                {
</span><span style="color: #008080;"> 32</span>                     mask = cValue &gt;&gt; (<span style="color: #800080;">5</span> -<span style="color: #000000;"> bitsRemaining);
</span><span style="color: #008080;"> 33</span>                     curByte = (<span style="color: #0000ff;">byte</span>)(curByte |<span style="color: #000000;"> mask);
</span><span style="color: #008080;"> 34</span>                     returnArray[arrayIndex++] =<span style="color: #000000;"> curByte;
</span><span style="color: #008080;"> 35</span>                     curByte = (<span style="color: #0000ff;">byte</span>)(cValue &lt;&lt; (<span style="color: #800080;">3</span> +<span style="color: #000000;"> bitsRemaining));
</span><span style="color: #008080;"> 36</span>                     bitsRemaining += <span style="color: #800080;">3</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 37</span> <span style="color: #000000;">                }
</span><span style="color: #008080;"> 38</span> <span style="color: #000000;">            }
</span><span style="color: #008080;"> 39</span> 
<span style="color: #008080;"> 40</span>             <span style="color: #0000ff;">if</span> (arrayIndex !=<span style="color: #000000;"> byteCount)
</span><span style="color: #008080;"> 41</span> <span style="color: #000000;">            {
</span><span style="color: #008080;"> 42</span>                 returnArray[arrayIndex] =<span style="color: #000000;"> curByte;
</span><span style="color: #008080;"> 43</span> <span style="color: #000000;">            }
</span><span style="color: #008080;"> 44</span> 
<span style="color: #008080;"> 45</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> returnArray;
</span><span style="color: #008080;"> 46</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 47</span> 
<span style="color: #008080;"> 48</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">string</span> ToString(<span style="color: #0000ff;">byte</span><span style="color: #000000;">[] input)
</span><span style="color: #008080;"> 49</span> <span style="color: #000000;">        {
</span><span style="color: #008080;"> 50</span>             <span style="color: #0000ff;">if</span> (input == <span style="color: #0000ff;">null</span> || input.Length == <span style="color: #800080;">0</span><span style="color: #000000;">)
</span><span style="color: #008080;"> 51</span> <span style="color: #000000;">            {
</span><span style="color: #008080;"> 52</span>                 <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> ArgumentNullException(<span style="color: #800000;">"</span><span style="color: #800000;">input</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 53</span> <span style="color: #000000;">            }
</span><span style="color: #008080;"> 54</span> 
<span style="color: #008080;"> 55</span>             <span style="color: #0000ff;">int</span> charCount = (<span style="color: #0000ff;">int</span>)Math.Ceiling(input.Length / 5d) * <span style="color: #800080;">8</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 56</span>             <span style="color: #0000ff;">char</span>[] returnArray = <span style="color: #0000ff;">new</span> <span style="color: #0000ff;">char</span><span style="color: #000000;">[charCount];
</span><span style="color: #008080;"> 57</span> 
<span style="color: #008080;"> 58</span>             <span style="color: #0000ff;">byte</span> nextChar = <span style="color: #800080;">0</span>, bitsRemaining = <span style="color: #800080;">5</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 59</span>             <span style="color: #0000ff;">int</span> arrayIndex = <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 60</span> 
<span style="color: #008080;"> 61</span>             <span style="color: #0000ff;">foreach</span> (<span style="color: #0000ff;">byte</span> b <span style="color: #0000ff;">in</span><span style="color: #000000;"> input)
</span><span style="color: #008080;"> 62</span> <span style="color: #000000;">            {
</span><span style="color: #008080;"> 63</span>                 nextChar = (<span style="color: #0000ff;">byte</span>)(nextChar | (b &gt;&gt; (<span style="color: #800080;">8</span> -<span style="color: #000000;"> bitsRemaining)));
</span><span style="color: #008080;"> 64</span>                 returnArray[arrayIndex++] =<span style="color: #000000;"> ValueToChar(nextChar);
</span><span style="color: #008080;"> 65</span> 
<span style="color: #008080;"> 66</span>                 <span style="color: #0000ff;">if</span> (bitsRemaining &lt; <span style="color: #800080;">4</span><span style="color: #000000;">)
</span><span style="color: #008080;"> 67</span> <span style="color: #000000;">                {
</span><span style="color: #008080;"> 68</span>                     nextChar = (<span style="color: #0000ff;">byte</span>)((b &gt;&gt; (<span style="color: #800080;">3</span> - bitsRemaining)) &amp; <span style="color: #800080;">31</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 69</span>                     returnArray[arrayIndex++] =<span style="color: #000000;"> ValueToChar(nextChar);
</span><span style="color: #008080;"> 70</span>                     bitsRemaining += <span style="color: #800080;">5</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 71</span> <span style="color: #000000;">                }
</span><span style="color: #008080;"> 72</span> 
<span style="color: #008080;"> 73</span>                 bitsRemaining -= <span style="color: #800080;">3</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 74</span>                 nextChar = (<span style="color: #0000ff;">byte</span>)((b &lt;&lt; bitsRemaining) &amp; <span style="color: #800080;">31</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 75</span> <span style="color: #000000;">            }
</span><span style="color: #008080;"> 76</span> 
<span style="color: #008080;"> 77</span>             <span style="color: #0000ff;">if</span> (arrayIndex !=<span style="color: #000000;"> charCount)
</span><span style="color: #008080;"> 78</span> <span style="color: #000000;">            {
</span><span style="color: #008080;"> 79</span>                 returnArray[arrayIndex++] =<span style="color: #000000;"> ValueToChar(nextChar);
</span><span style="color: #008080;"> 80</span>                 <span style="color: #0000ff;">while</span> (arrayIndex != charCount) returnArray[arrayIndex++] = <span style="color: #800000;">'</span><span style="color: #800000;">=</span><span style="color: #800000;">'</span><span style="color: #000000;">; 
</span><span style="color: #008080;"> 81</span> <span style="color: #000000;">            }
</span><span style="color: #008080;"> 82</span> 
<span style="color: #008080;"> 83</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> <span style="color: #0000ff;">string</span><span style="color: #000000;">(returnArray);
</span><span style="color: #008080;"> 84</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 85</span> 
<span style="color: #008080;"> 86</span>         <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">int</span> CharToValue(<span style="color: #0000ff;">char</span><span style="color: #000000;"> c)
</span><span style="color: #008080;"> 87</span> <span style="color: #000000;">        {
</span><span style="color: #008080;"> 88</span>             <span style="color: #0000ff;">var</span> value = (<span style="color: #0000ff;">int</span><span style="color: #000000;">)c;
</span><span style="color: #008080;"> 89</span> 
<span style="color: #008080;"> 90</span>             <span style="color: #0000ff;">if</span> (value &lt; <span style="color: #800080;">91</span> &amp;&amp; value &gt; <span style="color: #800080;">64</span><span style="color: #000000;">)
</span><span style="color: #008080;"> 91</span> <span style="color: #000000;">            {
</span><span style="color: #008080;"> 92</span>                 <span style="color: #0000ff;">return</span> value - <span style="color: #800080;">65</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 93</span> <span style="color: #000000;">            }
</span><span style="color: #008080;"> 94</span>             <span style="color: #0000ff;">if</span> (value &lt; <span style="color: #800080;">56</span> &amp;&amp; value &gt; <span style="color: #800080;">49</span><span style="color: #000000;">)
</span><span style="color: #008080;"> 95</span> <span style="color: #000000;">            {
</span><span style="color: #008080;"> 96</span>                 <span style="color: #0000ff;">return</span> value - <span style="color: #800080;">24</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 97</span> <span style="color: #000000;">            }
</span><span style="color: #008080;"> 98</span>             <span style="color: #0000ff;">if</span> (value &lt; <span style="color: #800080;">123</span> &amp;&amp; value &gt; <span style="color: #800080;">96</span><span style="color: #000000;">)
</span><span style="color: #008080;"> 99</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">100</span>                 <span style="color: #0000ff;">return</span> value - <span style="color: #800080;">97</span><span style="color: #000000;">;
</span><span style="color: #008080;">101</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">102</span> 
<span style="color: #008080;">103</span>             <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> ArgumentException(<span style="color: #800000;">"</span><span style="color: #800000;">Character is not a Base32 character.</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">c</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">104</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">105</span> 
<span style="color: #008080;">106</span>         <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">char</span> ValueToChar(<span style="color: #0000ff;">byte</span><span style="color: #000000;"> b)
</span><span style="color: #008080;">107</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">108</span>             <span style="color: #0000ff;">if</span> (b &lt; <span style="color: #800080;">26</span><span style="color: #000000;">)
</span><span style="color: #008080;">109</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">110</span>                 <span style="color: #0000ff;">return</span> (<span style="color: #0000ff;">char</span>)(b + <span style="color: #800080;">65</span><span style="color: #000000;">);
</span><span style="color: #008080;">111</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">112</span> 
<span style="color: #008080;">113</span>             <span style="color: #0000ff;">if</span> (b &lt; <span style="color: #800080;">32</span><span style="color: #000000;">)
</span><span style="color: #008080;">114</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">115</span>                 <span style="color: #0000ff;">return</span> (<span style="color: #0000ff;">char</span>)(b + <span style="color: #800080;">24</span><span style="color: #000000;">);
</span><span style="color: #008080;">116</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">117</span> 
<span style="color: #008080;">118</span>             <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> ArgumentException(<span style="color: #800000;">"</span><span style="color: #800000;">Byte is not a value Base32 value.</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">b</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">119</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">120</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">121</span> }</pre>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<p>&nbsp;</p>
</div>
<h2>总结</h2>
<h3>需要注意的坑</h3>
<div>
<p>移动端下载的认证器的秘钥key是通过base32转码得到的，而程序端是直接输入源码。</p>
<p>如原秘钥为xeon997@foxmail.com生成的base32码PBSW63RZHE3UAZTPPBWWC2LMFZRW63I=才是移动端需要输入的秘钥。</p>
<p>在网上找了很多资料没有发现关于C#的案例，所以在此记录一下自己遇到的坑，让更多的人能够跳过这个坑。</p>
<p>案例地址：</p>
<p>git:<a href="https://github.com/CN-Yi/GoogleAuthenticator">https://github.com/CN-Yi/GoogleAuthenticator</a></p>
<p>gitee:<a href="https://gitee.com/hsyi/GoogleAuthenticator">https://gitee.com/hsyi/GoogleAuthenticator</a></p>
<p>在此感谢提供学习资料的大神们，如果有错误的地方欢迎留言。</p>
<div>&nbsp;</div>
</div>
</div>
</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>